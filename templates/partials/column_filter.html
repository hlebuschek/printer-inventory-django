{# templates/partials/column_filter.html #}

{% if not column_filter_styles_loaded %}
<style id="column-filter-styles">
.column-filter .dropdown-toggle {
  position: relative;
  z-index: 12;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.column-filter .dropdown-toggle:hover {
  background: rgba(255, 255, 255, 1);
  border-color: rgba(13, 110, 253, 0.5);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ВАЖНО: Меню будет в body, используем portal */
.filter-menu-portal {
  position: fixed !important;
  z-index: 1060 !important;
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  min-width: 280px;
  max-height: 400px;
  overflow-y: auto;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
}

.filter-menu-portal.show {
  opacity: 1;
  pointer-events: auto;
}

.column-filter .dropdown-toggle.filter-active {
  background: rgba(13, 110, 253, 0.1);
  border-color: rgba(13, 110, 253, 0.3);
  color: #0d6efd;
}

.column-filter .dropdown-toggle.filter-active .bi-funnel:before {
  content: "\f462";
}

.filter-menu-portal .suggestion-item {
  cursor: pointer;
  user-select: none;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.filter-menu-portal .suggestion-item:hover {
  background-color: rgba(0, 123, 255, 0.1);
}

.filter-menu-portal .suggestion-item:last-child {
  border-bottom: none;
}

.filter-menu-portal .suggestion-checkbox {
  /* Убрано pointer-events: none для корректной работы с label */
}

.filter-menu-portal .suggestion-checkbox:checked + .suggestion-text {
  font-weight: 600;
  color: #0d6efd;
}

.filter-menu-portal .selected-count {
  font-weight: 600;
  color: #0d6efd;
}

.filter-menu-portal .suggestions-container {
  background: white;
}

.filter-menu-portal .select-all-filter,
.filter-menu-portal .clear-selection-filter {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
}

.filter-menu-portal .dynamic-search-indicator {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.75rem;
  color: #6c757d;
  pointer-events: none;
}

.filter-menu-portal .flt-input.searching {
  background-color: #fff3cd;
  border-color: #ffc107;
}

.filter-menu-portal .flt-input.searching + .dynamic-search-indicator {
  color: #856404;
}

@keyframes search-pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.filter-menu-portal .dynamic-search-indicator.active {
  animation: search-pulse 1s ease-in-out infinite;
}

@media (max-width: 768px) {
  .filter-menu-portal {
    max-width: calc(100vw - 20px);
    max-height: 300px;
  }
}
</style>
{% endif %}

<th class="th-{{ key }} column-filter">
  <div class="d-flex align-items-center gap-1">
    {{ label }}
    <div class="dropdown">
      <button class="btn btn-link btn-sm p-0 text-muted"
              onclick="window.ColumnFilters.toggleFilter('{{ key }}', this)"
              title="Фильтр"
              id="filter-toggle-{{ key }}">
        <i class="bi bi-funnel{% if value %}-fill text-primary{% endif %}"></i>
      </button>
      <!-- TEMPLATE для меню - будет склонирован в body -->
      <template id="filter-template-{{ key }}">
        <div class="filter-menu-portal p-2" data-filter-key="{{ key }}">
          <div class="input-group input-group-sm mb-2 position-relative">
            <input type="text" class="form-control flt-input dynamic-search" id="flt-{{ key }}" data-key="{{ key }}"
                   value="{{ value }}" placeholder="значение1, значение2, ..."
                   data-dynamic-search="true">
            <button class="btn btn-primary apply-filter" data-key="{{ key }}">OK</button>
            <span class="dynamic-search-indicator" id="search-indicator-{{ key }}">⚡</span>
          </div>

          <div class="d-flex gap-1 mb-2 flex-wrap">
            <a href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort={{ key }}" class="btn btn-outline-secondary btn-sm" title="Сортировать по возрастанию">↑</a>
            <a href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-{{ key }}" class="btn btn-outline-secondary btn-sm" title="Сортировать по убыванию">↓</a>
            {% if options %}
            <button class="btn btn-outline-info btn-sm select-all-filter" data-key="{{ key }}" title="Выбрать все">Все</button>
            <button class="btn btn-outline-warning btn-sm clear-selection-filter" data-key="{{ key }}" title="Очистить выбор">Очистить</button>
            {% endif %}
            <a href="#" class="btn btn-link btn-sm text-danger ms-auto clear-filter" data-key="{{ key }}">Сброс</a>
          </div>

          {% if options %}
          <div class="mb-2">
            <input type="text" class="form-control form-control-sm search-suggestions"
                   placeholder="Поиск в списке..." data-key="{{ key }}">
          </div>

          <div class="mb-2 small text-muted">
            Выбрано: <span class="selected-count" data-key="{{ key }}">0</span> из <span class="total-visible" data-key="{{ key }}">{{ options|length }}</span>
          </div>

          <div class="suggestions-container" data-key="{{ key }}" style="max-height: 240px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
            {% for v in options %}
              <label class="list-group-item list-group-item-action py-2 suggestion-item border-0"
                     title="{{ v }}"
                     data-key="{{ key }}"
                     data-value="{{ v }}">
                <input type="checkbox" class="form-check-input me-2 suggestion-checkbox"
                       data-key="{{ key }}" data-value="{{ v }}">
                <span class="suggestion-text">{{ v }}</span>
              </label>
            {% empty %}
              <div class="px-3 py-2 text-muted small">Нет вариантов</div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </template>
    </div>
  </div>
</th>

{% if not column_filter_scripts_loaded %}
<script id="column-filter-scripts">
window.ColumnFilters = window.ColumnFilters || {
  initialized: false,
  searchTimers: new Map(),
  activeMenu: null,
  activeToggle: null,

  init: function() {
    if (this.initialized) return;
    this.initialized = true;

    document.addEventListener('DOMContentLoaded', () => {
      this.initializeFiltersFromURL();

      // Закрываем меню при клике вне
      document.addEventListener('click', (e) => {
        if (this.activeMenu && !this.activeMenu.contains(e.target) && !this.activeToggle.contains(e.target)) {
          this.closeFilter();
        }
      });

      // Закрываем при Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.activeMenu) {
          this.closeFilter();
        }
      });

      // КРИТИЧНО: Закрываем при скролле
      const tableWrapper = document.querySelector('.table-responsive');
      if (tableWrapper) {
        tableWrapper.addEventListener('scroll', () => this.closeFilter(), { passive: true });
      }
      window.addEventListener('scroll', () => this.closeFilter(), { passive: true });
    });
  },

  toggleFilter: function(key, toggle) {
    // Если уже открыт этот фильтр - закрываем
    if (this.activeMenu && this.activeMenu.dataset.filterKey === key) {
      this.closeFilter();
      return;
    }

    // Закрываем предыдущий если был
    this.closeFilter();

    // Получаем template и клонируем
    const template = document.getElementById('filter-template-' + key);
    if (!template) return;

    const menu = template.content.cloneNode(true).firstElementChild;

    // Добавляем в body
    document.body.appendChild(menu);

    // Сохраняем ссылки
    this.activeMenu = menu;
    this.activeToggle = toggle;

    // Позиционируем
    this.positionMenu(toggle, menu);

    // Показываем
    setTimeout(() => menu.classList.add('show'), 10);

    // Фокус на input
    const input = menu.querySelector('.flt-input');
    if (input) {
      setTimeout(() => input.focus(), 100);
    }

    // КРИТИЧНО: Инициализируем состояние чекбоксов из URL
    this.initializeCheckboxesFromURL(menu, key);

    // Навешиваем обработчики НА ЭТОТ конкретный клон
    this.setupMenuEvents(menu, key);
  },

  closeFilter: function() {
    if (this.activeMenu) {
      this.activeMenu.classList.remove('show');
      setTimeout(() => {
        if (this.activeMenu && this.activeMenu.parentNode) {
          this.activeMenu.parentNode.removeChild(this.activeMenu);
        }
        this.activeMenu = null;
        this.activeToggle = null;
      }, 150);
    }
  },

  positionMenu: function(toggle, menu) {
    const toggleRect = toggle.getBoundingClientRect();
    const menuWidth = 280;
    const viewport = {
      width: window.innerWidth,
      height: window.innerHeight
    };

    const margin = 10;
    let top = toggleRect.bottom + 4;
    let left = toggleRect.left;

    // Проверяем горизонтальные границы
    if (left + menuWidth > viewport.width - margin) {
      left = Math.max(margin, viewport.width - menuWidth - margin);
    }

    if (left < margin) {
      left = margin;
    }

    // Проверяем вертикальные границы
    const menuHeight = 400; // max-height

    if (top + menuHeight > viewport.height - margin) {
      const topPosition = toggleRect.top - menuHeight - 4;

      if (topPosition >= margin) {
        top = topPosition;
      } else {
        top = toggleRect.bottom + 4;
        const availableHeight = viewport.height - top - margin * 2;
        menu.style.maxHeight = Math.max(200, availableHeight) + 'px';
      }
    }

    menu.style.top = top + 'px';
    menu.style.left = left + 'px';
  },

  // НОВАЯ ФУНКЦИЯ: Инициализация чекбоксов из URL
  initializeCheckboxesFromURL: function(menu, key) {
    const urlParams = new URLSearchParams(window.location.search);
    const multiValue = urlParams.get(key + '__in');
    const singleValue = urlParams.get(key);

    if (!multiValue && !singleValue) return;

    const container = menu.querySelector('.suggestions-container');
    if (!container) return;

    let selectedValues = [];

    if (multiValue) {
      selectedValues = multiValue.split('||').map(v => v.trim());
    } else if (singleValue) {
      selectedValues = [singleValue.trim()];
    }

    // Отмечаем нужные чекбоксы
    container.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
      if (selectedValues.includes(checkbox.dataset.value)) {
        checkbox.checked = true;
      }
    });

    // Обновляем счётчик и поле ввода
    this.updateSelectedCount(menu, key);
    this.updateFilterInput(menu, key);
  },

  setupMenuEvents: function(menu, key) {
    // Динамический поиск
    const dynamicInput = menu.querySelector('.flt-input.dynamic-search');
    if (dynamicInput) {
      dynamicInput.addEventListener('input', () => {
        this.handleDynamicSearch(dynamicInput);
      });

      dynamicInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.applyDynamicSearch(dynamicInput);
        }
      });
    }

    // Поиск в списке
    const searchInput = menu.querySelector('.search-suggestions');
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        const container = menu.querySelector('.suggestions-container');
        const query = searchInput.value.toLowerCase().trim();

        let visibleCount = 0;
        container.querySelectorAll('.suggestion-item').forEach(item => {
          const text = item.querySelector('.suggestion-text').textContent.toLowerCase();
          const isVisible = text.includes(query);
          item.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
        });

        const totalVisible = menu.querySelector('.total-visible');
        if (totalVisible) totalVisible.textContent = visibleCount;
      });
    }

    // ИСПРАВЛЕНО: Слушаем событие change на чекбоксах
    menu.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        // Обновляем UI при изменении состояния чекбокса
        this.updateFilterInput(menu, key);
        this.updateSelectedCount(menu, key);
        this.updateFilterButtonState(key);
      });
    });

    // Выбрать все
    const selectAllBtn = menu.querySelector('.select-all-filter');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        const container = menu.querySelector('.suggestions-container');
        const visibleCheckboxes = container.querySelectorAll('.suggestion-item:not([style*="display: none"]) .suggestion-checkbox');

        visibleCheckboxes.forEach(cb => cb.checked = true);

        this.updateFilterInput(menu, key);
        this.updateSelectedCount(menu, key);
        this.updateFilterButtonState(key);
      });
    }

    // Очистить
    const clearBtn = menu.querySelector('.clear-selection-filter');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        const container = menu.querySelector('.suggestions-container');
        container.querySelectorAll('.suggestion-checkbox').forEach(cb => cb.checked = false);

        this.updateFilterInput(menu, key);
        this.updateSelectedCount(menu, key);
        this.updateFilterButtonState(key);
      });
    }

    // OK
    const applyBtn = menu.querySelector('.apply-filter');
    if (applyBtn) {
      applyBtn.addEventListener('click', () => {
        const input = menu.querySelector('.flt-input');
        const container = menu.querySelector('.suggestions-container');
        let value = input.value.trim();

        const checkedBoxes = container ? container.querySelectorAll('.suggestion-checkbox:checked') : [];

        if (checkedBoxes.length > 0) {
          const values = Array.from(checkedBoxes).map(cb => cb.dataset.value);
          if (values.length === 1) {
            this.applySingleFilter(key, values[0]);
          } else {
            this.applyMultipleFilter(key, values);
          }
        } else if (value) {
          if (value.includes('||')) {
            const values = value.split('||').map(v => v.trim()).filter(v => v);
            if (values.length > 1) {
              this.applyMultipleFilter(key, values);
            } else if (values.length === 1) {
              this.applySingleFilter(key, values[0]);
            }
          } else {
            this.applySingleFilter(key, value);
          }
        } else {
          this.applySingleFilter(key, '');
        }
      });
    }

    // Сброс
    const clearLink = menu.querySelector('.clear-filter');
    if (clearLink) {
      clearLink.addEventListener('click', (e) => {
        e.preventDefault();
        const url = new URL(window.location);
        url.searchParams.delete(key);
        url.searchParams.delete(key + '__in');
        url.searchParams.delete('page');
        window.location.href = url.toString();
      });
    }
  },

  updateFilterButtonState: function(key) {
    const toggle = document.getElementById('filter-toggle-' + key);
    if (!toggle || !this.activeMenu) return;

    const input = this.activeMenu.querySelector('.flt-input');
    if (!input) return;

    const hasValue = input.value.trim().length > 0;
    const container = this.activeMenu.querySelector('.suggestions-container');
    const hasCheckedBoxes = container ? container.querySelectorAll('.suggestion-checkbox:checked').length > 0 : false;

    if (hasValue || hasCheckedBoxes) {
      toggle.classList.add('filter-active');
    } else {
      toggle.classList.remove('filter-active');
    }
  },

  handleDynamicSearch: function(input) {
    const key = input.dataset.key;

    input.classList.add('searching');
    this.showSearchIndicator(input, true, true);

    if (this.searchTimers.has(key)) {
      clearTimeout(this.searchTimers.get(key));
    }

    const timer = setTimeout(() => {
      this.applyDynamicSearch(input);
    }, 800);

    this.searchTimers.set(key, timer);
  },

  applyDynamicSearch: function(input) {
    const key = input.dataset.key;
    const menu = this.activeMenu;
    if (!menu) return;

    const container = menu.querySelector('.suggestions-container');
    let value = input.value.trim();

    input.classList.remove('searching');
    this.showSearchIndicator(input, false);

    const checkedBoxes = container ? container.querySelectorAll('.suggestion-checkbox:checked') : [];

    if (checkedBoxes.length > 0) {
      const values = Array.from(checkedBoxes).map(cb => cb.dataset.value);
      if (values.length === 1) {
        this.applySingleFilter(key, values[0]);
      } else {
        this.applyMultipleFilter(key, values);
      }
    } else if (value) {
      if (value.includes('||')) {
        const values = value.split('||').map(v => v.trim()).filter(v => v);
        if (values.length > 1) {
          this.applyMultipleFilter(key, values);
        } else if (values.length === 1) {
          this.applySingleFilter(key, values[0]);
        }
      } else {
        this.applySingleFilter(key, value);
      }
    } else {
      this.applySingleFilter(key, '');
    }
  },

  showSearchIndicator: function(input, show, active = false) {
    const indicator = input.parentElement.querySelector('.dynamic-search-indicator');
    if (indicator) {
      indicator.style.display = show ? 'block' : 'none';
      if (active) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    }
  },

  updateFilterInput: function(menu, key) {
    const container = menu.querySelector('.suggestions-container');
    const input = menu.querySelector('.flt-input');
    if (!container || !input) return;

    const checkedBoxes = container.querySelectorAll('.suggestion-checkbox:checked');
    const values = Array.from(checkedBoxes).map(cb => cb.dataset.value);

    if (values.length === 1) {
      input.value = values[0];
    } else if (values.length > 1) {
      input.value = values.join(' || ');
    } else {
      input.value = '';
    }
  },

  updateSelectedCount: function(menu, key) {
    const container = menu.querySelector('.suggestions-container');
    const counter = menu.querySelector('.selected-count');
    if (!container || !counter) return;

    const checkedBoxes = container.querySelectorAll('.suggestion-checkbox:checked');
    counter.textContent = checkedBoxes.length;
  },

  applySingleFilter: function(key, value) {
    const url = new URL(window.location);
    url.searchParams.delete(key + '__in');

    if (value) {
      url.searchParams.set(key, value);
    } else {
      url.searchParams.delete(key);
    }

    url.searchParams.delete('page');
    window.location.href = url.toString();
  },

  applyMultipleFilter: function(key, values) {
    const url = new URL(window.location);
    url.searchParams.delete(key);

    if (values.length > 0) {
      url.searchParams.set(key + '__in', values.join('||'));
    } else {
      url.searchParams.delete(key + '__in');
    }

    url.searchParams.delete('page');
    window.location.href = url.toString();
  },

  initializeFiltersFromURL: function() {
    const urlParams = new URLSearchParams(window.location.search);

    document.querySelectorAll('.column-filter [id^="filter-toggle-"]').forEach(toggle => {
      const key = toggle.id.replace('filter-toggle-', '');
      const multiValue = urlParams.get(key + '__in');
      const singleValue = urlParams.get(key);

      if (multiValue || singleValue) {
        toggle.classList.add('filter-active');
        const icon = toggle.querySelector('i');
        if (icon) {
          icon.classList.remove('bi-funnel');
          icon.classList.add('bi-funnel-fill', 'text-primary');
        }
      }
    });
  }
};

window.ColumnFilters.init();
</script>
{% endif %}