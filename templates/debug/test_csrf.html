{% extends "base.html" %}

{% block title %}Тест CSRF ошибки - {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h2>Тестирование CSRF ошибки</h2>
      
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Внимание!</strong> Эта страница предназначена для тестирования обработчика CSRF ошибок.
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Формы для тестирования</h5>
        </div>
        <div class="card-body">
          
          <!-- Форма с CSRF токеном (работает) -->
          <h6 class="text-success">Форма с CSRF токеном (должна работать)</h6>
          <form method="post" action="{% url 'test_csrf_submit' %}" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
              <label for="test_field_1" class="form-label">Тестовое поле</label>
              <input type="text" class="form-control" id="test_field_1" name="test_field" value="Тест с CSRF">
            </div>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle me-2"></i>
              Отправить с CSRF
            </button>
          </form>
          
          <hr>
          
          <!-- Форма без CSRF токена (вызовет ошибку) -->
          <h6 class="text-danger">Форма без CSRF токена (вызовет ошибку 403)</h6>
          <form method="post" action="{% url 'test_csrf_submit' %}" class="mb-4" id="csrf-error-form">
            <!-- Намеренно не включаем {% csrf_token %} -->
            <div class="mb-3">
              <label for="test_field_2" class="form-label">Тестовое поле</label>
              <input type="text" class="form-control" id="test_field_2" name="test_field" value="Тест без CSRF">
            </div>
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Отправить без CSRF (вызовет ошибку)
            </button>
          </form>
          
          <hr>
          
          <!-- JavaScript форма -->
          <h6 class="text-info">AJAX запрос без CSRF токена</h6>
          <button type="button" class="btn btn-info" onclick="testAjaxCsrf()">
            <i class="bi bi-wifi me-2"></i>
            AJAX без CSRF (вызовет ошибку)
          </button>
        </div>
      </div>
      
      <div class="mt-3">
        <a href="{% url 'error_test_menu' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>
          Назад к меню тестов
        </a>
      </div>
    </div>
  </div>
</div>

<script>
function testAjaxCsrf() {
  fetch("{% url 'test_csrf_submit' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // Намеренно не включаем CSRF токен
    },
    body: JSON.stringify({test_field: 'AJAX без CSRF'})
  })
  .then(response => {
    if (response.ok) {
      alert('Неожиданно: запрос прошёл успешно!');
    } else {
      alert(`Ожидаемая ошибка: ${response.status} ${response.statusText}`);
      // При CSRF ошибке сервер должен перенаправить на страницу ошибки
      if (response.status === 403) {
        window.location.href = response.url;
      }
    }
  })
  .catch(error => {
    console.error('Ошибка:', error);
    alert('Ошибка запроса: ' + error.message);
  });
}
</script>
{% endblock %}