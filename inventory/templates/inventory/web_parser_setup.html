{% extends "base.html" %}

{% block content %}
<style>
    * {
        box-sizing: border-box;
    }

    .web-parser-container {
        max-width: 1600px;
        margin: 0 auto;
    }

    .parser-header {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .parser-header h1 {
        color: #333;
        font-size: 24px;
        margin: 0;
    }

    .parser-header .printer-info {
        color: #6c757d;
        font-size: 14px;
        margin-top: 5px;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .panel {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .panel h2 {
        color: #333;
        font-size: 20px;
        margin: 0 0 20px 0;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .form-row-auth {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }

    .form-row label {
        font-weight: 500;
        color: #495057;
        align-self: center;
    }

    .form-row input,
    .form-row select {
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .btn-custom {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary-custom {
        background: #007bff;
        color: white;
    }

    .btn-primary-custom:hover {
        background: #0056b3;
    }

    .btn-secondary-custom {
        background: #6c757d;
        color: white;
    }

    .btn-secondary-custom:hover {
        background: #5a6268;
    }

    .btn-success-custom {
        background: #28a745;
        color: white;
    }

    .btn-success-custom:hover {
        background: #218838;
    }

    .btn-danger-custom {
        background: #dc3545;
        color: white;
    }

    .btn-danger-custom:hover {
        background: #c82333;
    }

    .btn-info-custom {
        background: #17a2b8;
        color: white;
    }

    .btn-info-custom:hover {
        background: #138496;
    }

    .btn-warning-custom {
        background: #ffc107;
        color: #000;
    }

    .btn-warning-custom:hover {
        background: #e0a800;
    }

    #webFrame {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
    }

    .iframe-container {
        position: relative;
        margin-bottom: 20px;
    }

    .page-preview {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        background: #f8f9fa;
        display: none;
        margin-bottom: 10px;
    }

    .page-preview-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 4px;
    }

    .info-box.warning {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .info-box strong {
        display: block;
        margin-bottom: 5px;
    }

    .info-box code {
        background: rgba(0,0,0,0.05);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }

    .checkbox-group label {
        margin: 0;
        cursor: pointer;
    }

    .hidden {
        display: none !important;
    }

    .rules-list {
        margin-top: 20px;
    }

    .rule-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .rule-item.calculated {
        border-left: 4px solid #ffc107;
    }

    .rule-info {
        flex: 1;
    }

    .rule-info strong {
        color: #007bff;
        display: block;
        margin-bottom: 5px;
    }

    .rule-info small {
        color: #6c757d;
        display: block;
        font-size: 12px;
        margin-top: 5px;
    }

    .rule-badge {
        background: #ffc107;
        color: #000;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
        margin-left: 8px;
    }

    .empty-rules {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Модальные окна */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: 1px solid #888;
        width: 90%;
        max-width: 900px;
        border-radius: 8px;
        max-height: 85vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .close:hover,
    .close:focus {
        color: black;
    }

    .modal-body {
        padding: 20px;
    }

    .action-builder-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .action-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        border-left: 3px solid #007bff;
    }

    .action-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .action-log {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        min-height: 100px;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
    }

    .actions-preview {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        display: none;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #495057;
        font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 60px;
        font-family: 'Courier New', monospace;
    }

    .advanced-options {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
        margin-top: 15px;
    }
</style>

<div class="web-parser-container">
    <div class="parser-header">
        <div>
            <h1>Настройка веб-парсинга</h1>
            <div class="printer-info">
                Принтер: {{ printer.ip_address }} ({{ printer.model_display }} - {{ printer.serial_number }})
            </div>
        </div>
        <a href="{% url 'inventory:printer_list' %}" class="btn-custom btn-secondary-custom">
            Назад к списку
        </a>
    </div>

    <div id="statusMessage" class="alert d-none" role="alert"></div>

    <div class="main-grid">
        <!-- Левая панель: Веб-интерфейс принтера -->
        <div class="panel">
            <h2>Веб-интерфейс принтера</h2>

            <div class="form-row">
                <select id="protocol" class="form-control">
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                </select>
                <input type="text" id="urlPath" class="form-control" placeholder="/main.html или /status" value="/">
            </div>

            <div class="form-row-auth">
                <input type="text" id="username" class="form-control" placeholder="Логин (опционально)" value="{{ printer.web_username|default:'' }}">
                <input type="password" id="password" class="form-control" placeholder="Пароль (опционально)" value="{{ printer.web_password|default:'' }}">
            </div>

            <div class="button-group">
                <button class="btn-custom btn-primary-custom" onclick="loadPrinterPage()">
                    Загрузить страницу
                </button>
                <button class="btn-custom btn-secondary-custom" onclick="openInNewTab()">
                    Открыть в новой вкладке
                </button>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Загрузка страницы...</p>
            </div>

            <div id="pagePreview" class="page-preview">
                <div class="page-preview-header">
                    <strong>Финальный URL:</strong>
                    <button class="btn-custom btn-secondary-custom" onclick="copyFinalUrl()" style="padding: 5px 10px; font-size: 12px;">
                        Копировать
                    </button>
                </div>
                <div id="finalUrl" style="color: #007bff; word-break: break-all;"></div>
            </div>

            <div id="iframeContainer" style="height: 600px; overflow: auto; border: 1px solid #dee2e6; background: white; margin-bottom: 20px;">
                <div class="text-center text-muted p-5" id="placeholder">
                    <i class="bi bi-cloud-download" style="font-size: 3rem;"></i>
                    <p class="mt-3">Нажмите "Загрузить страницу" для просмотра</p>
                </div>
                <iframe id="webFrame" style="width:100%; height:100%; border:none; display:none;"></iframe>
            </div>

            <div class="info-box">
                <strong>Как получить XPath:</strong>
                <p style="font-size: 13px; line-height: 1.6;">
                    1. Нажмите "Загрузить страницу" - она появится выше<br>
                    2. Откройте DevTools (F12) прямо здесь<br>
                    3. Кликните на iframe и найдите нужный элемент<br>
                    4. Правой кнопкой → Copy → Copy XPath<br>
                    5. Вставьте в поле справа и тестируйте<br>
                    <strong>Альтернатива:</strong> Используйте кнопку "Открыть в новой вкладке"
                </p>
            </div>

            <div class="info-box warning">
                <strong>Тестирование XPath</strong>
                <div class="form-group">
                    <label for="testXpath">XPath выражение</label>
                    <input type="text" id="testXpath" class="form-control" placeholder="//td[contains(text(),'Serial')]/following-sibling::td/text()">
                </div>
                <div class="form-group">
                    <label for="testRegex">Regex паттерн (опционально)</label>
                    <input type="text" id="testRegex" class="form-control" placeholder="(\w+)">
                </div>
                <button class="btn-custom btn-warning-custom" onclick="testXpath()">
                    Тестировать
                </button>
                <div id="xpathResult" style="display: none; margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                    <strong>Исходное значение:</strong> <span id="rawResult" style="display: block; color: #007bff;"></span>
                    <strong>После обработки:</strong> <span id="processedResult" style="display: block; color: #28a745;"></span>
                </div>
            </div>
        </div>

        <!-- Правая панель: Правила парсинга -->
        <div class="panel">
            <h2>Правила парсинга</h2>

            <input type="hidden" id="editRuleId" value="0">

            <div class="form-group">
                <label for="fieldName">Поле для обновления</label>
                <select id="fieldName" class="form-control" onchange="updateFieldDescription()">
                    <option value="counter">Общий счетчик</option>
                    <option value="counter_a4_bw">Счетчик A4 ЧБ</option>
                    <option value="counter_a3_bw">Счетчик A3 ЧБ</option>
                    <option value="counter_a4_color">Счетчик A4 Цвет</option>
                    <option value="counter_a3_color">Счетчик A3 Цвет</option>
                    <option value="serial_number">Серийный номер</option>
                    <option value="mac_address">MAC-адрес</option>
                    <option value="toner_black">Тонер черный</option>
                    <option value="toner_cyan">Тонер голубой</option>
                    <option value="toner_magenta">Тонер пурпурный</option>
                    <option value="toner_yellow">Тонер желтый</option>
                    <option value="drum_black">Барабан черный</option>
                    <option value="drum_cyan">Барабан голубой</option>
                    <option value="drum_magenta">Барабан пурпурный</option>
                    <option value="drum_yellow">Барабан желтый</option>
                </select>
            </div>

            <!-- Обычное правило или вычисляемое -->
            <div class="checkbox-group">
                <input type="checkbox" id="isCalculated" onchange="toggleCalculatedMode()">
                <label for="isCalculated">Вычисляемое поле (использовать результаты других правил)</label>
            </div>

            <!-- Блок для обычного парсинга -->
            <div id="normalRuleBlock">
                <div class="info-box warning">
                    <strong>Инструкция:</strong>
                    <p style="font-size: 13px; margin-top: 5px;">
                        1. Загрузите страницу принтера<br>
                        2. Откройте конструктор действий<br>
                        3. Добавьте клики/ожидания/парсинг<br>
                        4. Выполните и проверьте результат<br>
                        5. Сохраните действия и правило
                    </p>
                </div>

                <div class="advanced-options">
                    <div class="info-box">
                        <strong>Конструктор действий</strong>
                        <p style="font-size: 13px; margin-top: 5px;">
                            Если данные в другой вкладке/разделе - постройте цепочку действий
                        </p>
                    </div>

                    <button type="button" class="btn-custom btn-info-custom" onclick="openActionBuilder()" style="margin-bottom: 15px;">
                        Открыть конструктор действий
                    </button>

                    <div id="actionsPreview" class="actions-preview">
                        <strong>Действия:</strong>
                        <div id="actionsPreviewList" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>

                    <div class="info-box">
                        <strong>Обработка данных (опционально)</strong>
                        <p style="font-size: 13px; margin-top: 5px;">
                            Используйте регулярные выражения для извлечения и форматирования данных
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="regexPattern">Regex шаблон (для извлечения)</label>
                        <input type="text" id="regexPattern" class="form-control" placeholder="Например: (\d+) или ([A-F0-9:]+)">
                    </div>

                    <div class="form-group">
                        <label for="regexReplacement">Regex замена (опционально)</label>
                        <input type="text" id="regexReplacement" class="form-control" placeholder="Например: \1 или $1">
                    </div>

                    <div class="info-box warning">
                        <strong>Примеры регулярных выражений:</strong>
                        <p style="font-size: 12px; margin-top: 5px;">
                            • (\d+) - извлечь числа<br>
                            • (\d+)\.\d+ - число до точки<br>
                            • ([A-F0-9:]+) - MAC с двоеточиями
                        </p>
                    </div>
                </div>
            </div>

            <!-- Блок для вычисляемого поля -->
            <div id="calculatedRuleBlock" class="hidden">
                <div class="info-box warning">
                    <strong>Вычисляемое поле</strong>
                    <p style="font-size: 13px; margin-top: 5px;">
                        Выберите сохраненные правила для использования в вычислениях.<br>
                        Каждое правило будет выполнено и его результат можно использовать в формуле.
                    </p>
                </div>

                <div class="form-group">
                    <label>Использовать данные из сохраненных правил:</label>
                    <div id="rulesSelector" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        {% for rule in rules %}
                        {% if not rule.is_calculated %}
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="use_rule_{{ rule.id }}" value="{{ rule.id }}" data-field="{{ rule.field_name }}" onchange="updateCalculationFormula()">
                            <label for="use_rule_{{ rule.id }}" style="font-size: 13px;">
                                <strong>{{ rule.field_name }}</strong>
                                <span style="color: #6c757d;">({{ rule.protocol }}://{{ printer.ip_address }}{{ rule.url_path }})</span>
                            </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="calculationFormula">Формула вычисления</label>
                    <input type="text" id="calculationFormula" class="form-control" placeholder="Например: rule_1 + rule_2 - rule_3">
                    <small style="color: #6c757d;">Используйте rule_ID для ссылки на правила (например: rule_1 + rule_2)</small>
                </div>

                <div class="info-box">
                    <strong>Примеры формул:</strong>
                    <p style="font-size: 12px; margin-top: 5px;">
                        • rule_1 + rule_2 - сумма двух правил<br>
                        • rule_1 + rule_2 - rule_3 - сложение и вычитание<br>
                        • (rule_1 + rule_2) * 2 - с умножением<br>
                        • rule_1 + 1000 - добавить константу
                    </p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-custom btn-success-custom" onclick="saveRule()" id="saveBtn">
                    Сохранить правило
                </button>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Сохраненные правила</h3>

            <div id="rulesList" class="rules-list">
                {% if rules %}
                    {% for rule in rules %}
                    <div class="rule-item {% if rule.is_calculated %}calculated{% endif %}">
                        <div class="rule-info">
                            <strong>
                                {{ rule.field_name }}
                                {% if rule.is_calculated %}<span class="rule-badge">ВЫЧИСЛЯЕМОЕ</span>{% endif %}
                            </strong>
                            {% if rule.is_calculated %}
                                <small>Формула: {{ rule.calculation_formula }}</small>
                            {% else %}
                                <div>{{ rule.protocol }}://{{ printer.ip_address }}{{ rule.url_path }}</div>
                                {% if rule.actions_chain %}
                                    <small>Действий: {{ rule.actions_chain|length }}</small>
                                {% endif %}
                                {% if rule.xpath %}
                                    <small>XPath: {{ rule.xpath }}</small>
                                {% endif %}
                                {% if rule.regex_pattern %}
                                    <small>Regex: {{ rule.regex_pattern }}</small>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="button-group">
                            {% if not rule.is_calculated %}
                                <button class="btn-custom btn-secondary-custom" onclick="viewActions({{ rule.id }})">
                                    Просмотреть
                                </button>
                            {% endif %}
                            <button class="btn-custom btn-warning-custom" onclick="editRule({{ rule.id }})">
                                Редактировать
                            </button>
                            <button class="btn-custom btn-danger-custom" onclick="deleteRule({{ rule.id }})">
                                Удалить
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-rules">
                        <p>Нет сохраненных правил парсинга</p>
                        <p style="font-size: 12px; margin-top: 10px;">Создайте первое правило</p>
                    </div>
                {% endif %}
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <strong>Доступные поля:</strong>
                <ul style="font-size: 13px; margin-bottom: 15px;">
                    <li><strong>serial_number</strong> - Серийный номер</li>
                    <li><strong>mac_address</strong> - MAC-адрес</li>
                    <li><strong>counter</strong> - Общий счетчик</li>
                    <li><strong>counter_a4_bw</strong> - ЧБ A4</li>
                    <li><strong>counter_a3_bw</strong> - ЧБ A3</li>
                    <li><strong>counter_a4_color</strong> - Цвет A4</li>
                    <li><strong>counter_a3_color</strong> - Цвет A3</li>
                    <li><strong>toner_black</strong> - Тонер черный</li>
                    <li><strong>toner_cyan</strong> - Тонер голубой</li>
                    <li><strong>toner_magenta</strong> - Тонер пурпурный</li>
                    <li><strong>toner_yellow</strong> - Тонер желтый</li>
                    <li><strong>drum_black</strong> - Барабан черный</li>
                    <li><strong>drum_cyan</strong> - Барабан голубой</li>
                    <li><strong>drum_magenta</strong> - Барабан пурпурный</li>
                    <li><strong>drum_yellow</strong> - Барабан желтый</li>
                </ul>
                <strong>Примеры XPath:</strong>
                <ul style="font-size: 13px;">
                    <li>//td[contains(text(),'Serial')]/following-sibling::td/text()</li>
                    <li>//span[@id='counter']/text()</li>
                    <li>//div[@class='info']/p[2]/text()</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно конструктора действий -->
<div id="actionBuilderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Конструктор действий</h2>
            <span class="close" onclick="closeActionBuilder()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="action-builder-grid">
                <!-- Левая часть - действия -->
                <div>
                    <h3 style="margin-bottom: 15px;">Действия</h3>

                    <div class="button-group" style="margin-bottom: 15px;">
                        <button type="button" class="btn-custom btn-primary-custom" onclick="addAction('click')">
                            Клик
                        </button>
                        <button type="button" class="btn-custom btn-secondary-custom" onclick="addAction('send_keys')">
                            Ввод
                        </button>
                        <button type="button" class="btn-custom btn-secondary-custom" onclick="addAction('wait')">
                            Ожидание
                        </button>
                        <button type="button" class="btn-custom btn-success-custom" onclick="addAction('parse')">
                            Парсинг XPath
                        </button>
                    </div>

                    <div id="actionsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Действия будут добавляться сюда -->
                    </div>

                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" class="btn-custom btn-success-custom" onclick="executeActions()">
                            Выполнить
                        </button>
                        <button type="button" class="btn-custom btn-danger-custom" onclick="clearActions()">
                            Очистить
                        </button>
                    </div>
                </div>

                <!-- Правая часть - результат -->
                <div>
                    <h3 style="margin-bottom: 15px;">Результат</h3>

                    <div id="actionLog" class="action-log">
                        Выполните действия чтобы увидеть результат
                    </div>

                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn-custom btn-secondary-custom" onclick="viewHtmlSource()" style="width: 100%;">
                            Посмотреть HTML
                        </button>
                    </div>

                    <div>
                        <button type="button" class="btn-custom btn-success-custom" onclick="saveActionsAndClose()" style="width: 100%;">
                            Сохранить действия
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра HTML -->
<div id="htmlViewModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2>HTML источник</h2>
            <span class="close" onclick="closeHtmlView()">&times;</span>
        </div>
        <div class="modal-body">
            <textarea id="htmlSource" style="width: 100%; height: 500px; font-family: monospace; font-size: 11px;"></textarea>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра действий -->
<div id="viewActionsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Порядок действий</h2>
            <span class="close" onclick="closeViewActions()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="viewActionsList" style="font-size: 14px; line-height: 1.6;"></div>
        </div>
    </div>
</div>

<script>
const printerId = {{ printer.id }};
const printerIp = '{{ printer.ip_address }}';
let currentHtml = '';
let currentUrl = '';
let finalUrlStored = '';
let actionCounter = 0;
let actions = [];
let lastExecutedHtml = '';
var rulesData = {{ rules_data|safe }};

// CSRF токен
function getCookie(name) {
    const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
}

const csrfToken = getCookie('csrftoken');

function updateFieldDescription() {
    const fieldName = document.getElementById('fieldName').value;
}

function toggleCalculatedMode() {
    const isCalculated = document.getElementById('isCalculated').checked;
    const normalBlock = document.getElementById('normalRuleBlock');
    const calculatedBlock = document.getElementById('calculatedRuleBlock');

    if (isCalculated) {
        normalBlock.classList.add('hidden');
        calculatedBlock.classList.remove('hidden');
    } else {
        normalBlock.classList.remove('hidden');
        calculatedBlock.classList.add('hidden');
    }
}

function showMessage(text, type) {
    const messageDiv = document.getElementById('statusMessage');
    messageDiv.textContent = text;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.classList.remove('d-none');

    setTimeout(() => {
        messageDiv.classList.add('d-none');
    }, 5000);
}

function loadPrinterPage() {
    const protocol = document.getElementById('protocol').value;
    let urlPath = document.getElementById('urlPath').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (!urlPath.startsWith('/')) {
        urlPath = '/' + urlPath;
    }

    const url = `${protocol}://${printerIp}${urlPath}`;

    document.getElementById('loading').style.display = 'block';
    document.getElementById('pagePreview').style.display = 'none';

    fetch('{% url "inventory:fetch_page" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            url: url,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('loading').style.display = 'none';

        if (result.success) {
            currentHtml = result.content;
            currentUrl = result.url;
            finalUrlStored = result.url;

            if (result.final_path) {
                document.getElementById('urlPath').value = result.final_path;
            }

            document.getElementById('pagePreview').style.display = 'block';
            document.getElementById('finalUrl').textContent = result.url;

            const placeholder = document.getElementById('placeholder');
            const iframe = document.getElementById('webFrame');

            // Показываем индикатор загрузки
            placeholder.innerHTML = `
                <div class="spinner"></div>
                <p class="mt-3">Загрузка страницы...</p>
                <small>Ожидание выполнения JavaScript и AJAX запросов</small>
            `;
            placeholder.style.display = 'block';
            iframe.style.display = 'none';

            let proxyUrl = '{% url "inventory:proxy_page" %}?url=' + encodeURIComponent(result.url);
            if (username) {
                proxyUrl += '&username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password);
            }

            // Загружаем iframe
            iframe.src = proxyUrl;

            // Ждем загрузки iframe
            iframe.onload = function() {
                setTimeout(() => {
                    placeholder.style.display = 'none';
                    iframe.style.display = 'block';
                    showMessage('Страница загружена', 'success');
                }, 1000); // Дополнительная пауза после загрузки
            };

            // Если iframe не загрузился за 30 секунд - показываем его в любом случае
            setTimeout(() => {
                if (placeholder.style.display !== 'none') {
                    placeholder.style.display = 'none';
                    iframe.style.display = 'block';
                    showMessage('Страница загружена (timeout)', 'warning');
                }
            }, 30000);
        } else {
            showMessage('Ошибка загрузки страницы: ' + result.error, 'danger');
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        showMessage('Ошибка: ' + error.message, 'danger');
    });
}

function openInNewTab() {
    if (!finalUrlStored) {
        showMessage('Сначала загрузите страницу', 'danger');
        return;
    }
    window.open(finalUrlStored, '_blank');
    showMessage('Страница открыта в новой вкладке', 'success');
}

function copyFinalUrl() {
    navigator.clipboard.writeText(finalUrlStored).then(() => {
        showMessage('URL скопирован в буфер обмена', 'success');
    });
}

function testXpath() {
    const xpath = document.getElementById('testXpath').value;
    const regex = document.getElementById('testRegex').value;

    if (!currentHtml) {
        showMessage('Сначала загрузите страницу принтера', 'danger');
        return;
    }

    if (!xpath) {
        showMessage('Введите XPath выражение', 'danger');
        return;
    }

    fetch('{% url "inventory:test_xpath" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            html: currentHtml,
            xpath: xpath,
            regex_pattern: regex
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('rawResult').textContent = data.raw_result;
            document.getElementById('processedResult').textContent = data.processed_result || data.raw_result;
            document.getElementById('xpathResult').style.display = 'block';
            showMessage('XPath протестирован успешно', 'success');
        } else {
            showMessage(`Ошибка: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showMessage(`Ошибка: ${error.message}`, 'danger');
    });
}

function saveRule() {
    const protocol = document.getElementById('protocol').value;
    const urlPath = document.getElementById('urlPath').value;
    const fieldName = document.getElementById('fieldName').value;
    const isCalculated = document.getElementById('isCalculated').checked;
    const editId = parseInt(document.getElementById('editRuleId').value) || 0;

    let data = {
        printer_id: printerId,
        protocol: protocol,
        url_path: urlPath,
        field_name: fieldName,
        is_calculated: isCalculated
    };

    if (isCalculated) {
        const selectedRules = [];
        const checkboxes = document.querySelectorAll('#rulesSelector input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
            selectedRules.push(parseInt(cb.value));
        });

        const formula = document.getElementById('calculationFormula').value;

        if (selectedRules.length === 0) {
            showMessage('Выберите хотя бы одно правило для вычислений', 'danger');
            return;
        }

        if (!formula) {
            showMessage('Введите формулу вычисления', 'danger');
            return;
        }

        data.source_rules = JSON.stringify(selectedRules);
        data.calculation_formula = formula;
        data.xpath = '';
        data.actions_chain = '';
        data.regex_pattern = '';
        data.regex_replacement = '';
    } else {
        if (!urlPath || actions.length === 0) {
            showMessage('Создайте действия в конструкторе', 'danger');
            return;
        }

        const parseActions = actions.filter(a => a.type === 'parse');
        if (parseActions.length !== 1) {
            showMessage('Должно быть ровно одно действие парсинга в конце цепочки', 'danger');
            return;
        }

        const parseAction = parseActions[0];
        data.xpath = parseAction.xpath;
        data.regex_pattern = document.getElementById('regexPattern').value || parseAction.regex || '';
        data.regex_replacement = document.getElementById('regexReplacement').value || '';
        data.actions_chain = JSON.stringify(actions);
    }

    fetch('{% url "inventory:save_web_parsing_rule" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage('Правило сохранено успешно!', 'success');
            document.getElementById('editRuleId').value = 0;
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage('Ошибка сохранения: ' + (result.error || 'Неизвестная ошибка'), 'danger');
        }
    })
    .catch(error => {
        showMessage('Ошибка сохранения: ' + error.message, 'danger');
    });
}

function editRule(ruleId) {
    const rule = rulesData.find(r => r.id === ruleId);
    if (!rule) return;

    document.getElementById('editRuleId').value = ruleId;
    document.getElementById('protocol').value = rule.protocol;

    let urlPath = rule.url_path;
    if (!urlPath.startsWith('/')) urlPath = '/' + urlPath;
    document.getElementById('urlPath').value = urlPath;

    document.getElementById('fieldName').value = rule.field_name;

    const isCalculated = rule.is_calculated;
    document.getElementById('isCalculated').checked = isCalculated;
    toggleCalculatedMode();

    if (isCalculated) {
        const sourceRules = JSON.parse(rule.source_rules || '[]');
        sourceRules.forEach(ruleId => {
            const checkbox = document.querySelector(`#use_rule_${ruleId}`);
            if (checkbox) checkbox.checked = true;
        });
        document.getElementById('calculationFormula').value = rule.calculation_formula || '';
    } else {
        document.getElementById('regexPattern').value = rule.regex_pattern || '';
        document.getElementById('regexReplacement').value = rule.regex_replacement || '';

        const acts = JSON.parse(rule.actions_chain || '[]');
        const actionsList = document.getElementById('actionsList');
        actionsList.innerHTML = '';
        actionCounter = 0;
        acts.forEach(a => {
            addAction(a.type);
            const id = actionCounter;
            if (a.selector) document.querySelector(`.action-selector[data-id="${id}"]`).value = a.selector;
            if (a.value) document.querySelector(`.action-value[data-id="${id}"]`).value = a.value;
            if (a.wait !== undefined) document.querySelector(`.action-wait[data-id="${id}"]`).value = a.wait;
            if (a.xpath) document.querySelector(`.action-xpath[data-id="${id}"]`).value = a.xpath;
            if (a.regex) document.querySelector(`.action-regex[data-id="${id}"]`).value = a.regex;
            if (a.var_name) document.querySelector(`.action-varname[data-id="${id}"]`).value = a.var_name;
        });
        actions = acts;
        showActionsPreview();
    }

    showMessage('Правило загружено для редактирования', 'success');
}

function viewActions(ruleId) {
    const rule = rulesData.find(r => r.id === ruleId);
    if (!rule || !rule.actions_chain) return;

    const acts = JSON.parse(rule.actions_chain);
    const preview = acts.map((a, i) => {
        if (a.type === 'click') return `${i+1}. Клик: ${a.selector} (ожидание ${a.wait}с)`;
        if (a.type === 'send_keys') return `${i+1}. Ввод: ${a.selector} = "${a.value}" (ожидание ${a.wait}с)`;
        if (a.type === 'wait') return `${i+1}. Ожидание: ${a.wait}с`;
        if (a.type === 'parse') return `${i+1}. Парсинг: ${a.xpath}${a.regex ? ' (regex: ' + a.regex + ')' : ''}${a.var_name ? ' -> ' + a.var_name : ''}`;
    }).join('<br>');

    document.getElementById('viewActionsList').innerHTML = preview;
    document.getElementById('viewActionsModal').style.display = 'block';
}

function closeViewActions() {
    document.getElementById('viewActionsModal').style.display = 'none';
}

function deleteRule(ruleId) {
    if (confirm('Удалить это правило парсинга?')) {
        fetch(`/printers/api/web-parser/delete-rule/${ruleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                showMessage('Правило удалено', 'success');
                location.reload();
            } else {
                showMessage('Ошибка удаления', 'danger');
            }
        })
        .catch(error => showMessage('Ошибка: ' + error.message, 'danger'));
    }
}

// === КОНСТРУКТОР ДЕЙСТВИЙ ===

function openActionBuilder() {
    if (!currentHtml) {
        showMessage('Сначала загрузите страницу принтера', 'danger');
        return;
    }
    document.getElementById('actionBuilderModal').style.display = 'block';
}

function closeActionBuilder() {
    document.getElementById('actionBuilderModal').style.display = 'none';
}

function addAction(type) {
    actionCounter++;
    const actionsList = document.getElementById('actionsList');
    const action = document.createElement('div');
    action.className = 'action-item';
    action.id = `action-${actionCounter}`;
    action.dataset.type = type;

    let html = `
        <div class="action-item-header">
            <strong>${type === 'click' ? 'Клик' : type === 'send_keys' ? 'Ввод' : type === 'wait' ? 'Ожидание' : 'Парсинг'} #${actionCounter}</strong>
            <button type="button" class="btn-custom btn-danger-custom" onclick="removeAction(${actionCounter})" style="padding: 5px 10px; font-size: 12px;">Удалить</button>
        </div>
    `;

    if (type === 'click') {
        html += `
            <input type="text" placeholder="CSS селектор (например: #tab2)" class="action-selector" data-id="${actionCounter}" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <input type="number" placeholder="Ожидание после (сек)" value="1" min="0" max="10" class="action-wait" data-id="${actionCounter}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
        `;
    } else if (type === 'send_keys') {
        html += `
            <input type="text" placeholder="CSS селектор" class="action-selector" data-id="${actionCounter}" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <input type="text" placeholder="Текст для ввода" class="action-value" data-id="${actionCounter}" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <input type="number" placeholder="Ожидание после (сек)" value="1" min="0" max="10" class="action-wait" data-id="${actionCounter}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
        `;
    } else if (type === 'wait') {
        html += `
            <input type="number" placeholder="Секунд" value="2" min="1" max="10" class="action-wait" data-id="${actionCounter}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
        `;
    } else if (type === 'parse') {
        html += `
            <input type="text" placeholder="XPath выражение" class="action-xpath" data-id="${actionCounter}" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <input type="text" placeholder="Regex (опционально)" class="action-regex" data-id="${actionCounter}" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <input type="text" placeholder="Имя переменной" class="action-varname" data-id="${actionCounter}" value="parsed_value" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <div id="parse-result-${actionCounter}" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none; font-size: 13px;"></div>
        `;
    }

    action.innerHTML = html;
    actionsList.appendChild(action);
}

function removeAction(id) {
    const action = document.getElementById(`action-${id}`);
    if (action) action.remove();
}

function clearActions() {
    if (confirm('Очистить все действия?')) {
        document.getElementById('actionsList').innerHTML = '';
        actions = [];
        document.getElementById('actionLog').textContent = 'Действия очищены';
        document.getElementById('actionsPreview').style.display = 'none';
    }
}

function executeActions() {
    const protocol = document.getElementById('protocol').value;
    const urlPath = document.getElementById('urlPath').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const url = `${protocol}://${printerIp}${urlPath}`;

    actions = [];
    const actionElements = document.getElementById('actionsList').children;

    for (let elem of actionElements) {
        const type = elem.dataset.type;
        const id = elem.id.split('-')[1];

        const action = { type };

        if (type === 'click' || type === 'send_keys') {
            const selector = document.querySelector(`.action-selector[data-id="${id}"]`).value;
            if (!selector) {
                showMessage('Заполните CSS селектор', 'danger');
                return;
            }
            action.selector = selector;
        }

        if (type === 'send_keys') {
            const value = document.querySelector(`.action-value[data-id="${id}"]`).value;
            action.value = value;
        }

        if (type === 'parse') {
            const xpath = document.querySelector(`.action-xpath[data-id="${id}"]`).value;
            const regex = document.querySelector(`.action-regex[data-id="${id}"]`).value;
            const var_name = document.querySelector(`.action-varname[data-id="${id}"]`).value || 'parsed_value';
            if (!xpath) {
                showMessage('Заполните XPath выражение', 'danger');
                return;
            }
            action.xpath = xpath;
            action.regex = regex;
            action.var_name = var_name;
        }

        const waitElem = document.querySelector(`.action-wait[data-id="${id}"]`);
        if (waitElem) {
            action.wait = parseInt(waitElem.value);
        }

        actions.push(action);
    }

    document.getElementById('actionLog').textContent = 'Выполнение...';

    fetch('{% url "inventory:execute_action" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            url: url,
            actions: actions,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            lastExecutedHtml = result.html;
            currentHtml = result.html;
            document.getElementById('actionLog').innerHTML = result.action_log.join('<br>') + '<br><strong style="color: green;">✓ Успешно!</strong>';
            showMessage('Действия выполнены успешно!', 'success');
        } else {
            document.getElementById('actionLog').innerHTML = (result.action_log || []).join('<br>') + '<br><strong style="color: red;">✗ Ошибка: ' + result.error + '</strong>';
            showMessage('Ошибка выполнения действий', 'danger');
        }
    })
    .catch(error => {
        document.getElementById('actionLog').textContent = '✗ Ошибка: ' + error.message;
        showMessage('Ошибка: ' + error.message, 'danger');
    });
}

function viewHtmlSource() {
    if (!lastExecutedHtml) {
        showMessage('Сначала выполните действия', 'danger');
        return;
    }
    document.getElementById('htmlSource').value = lastExecutedHtml;
    document.getElementById('htmlViewModal').style.display = 'block';
}

function closeHtmlView() {
    document.getElementById('htmlViewModal').style.display = 'none';
}

function showActionsPreview() {
    if (actions.length === 0) {
        document.getElementById('actionsPreview').style.display = 'none';
        return;
    }

    const preview = actions.map((a, i) => {
        if (a.type === 'click') return `${i+1}. Клик: ${a.selector} (ожидание ${a.wait}с)`;
        if (a.type === 'send_keys') return `${i+1}. Ввод: ${a.selector} = "${a.value}" (ожидание ${a.wait}с)`;
        if (a.type === 'wait') return `${i+1}. Ожидание: ${a.wait}с`;
        if (a.type === 'parse') return `${i+1}. Парсинг: ${a.xpath}${a.regex ? ' (regex: ' + a.regex + ')' : ''}${a.var_name ? ' -> ' + a.var_name : ''}`;
    }).join('<br>');

    document.getElementById('actionsPreview').style.display = 'block';
    document.getElementById('actionsPreviewList').innerHTML = preview;
}

function saveActionsAndClose() {
    showActionsPreview();
    closeActionBuilder();
    showMessage('Действия сохранены!', 'success');
}

function updateCalculationFormula() {
    const checkboxes = document.querySelectorAll('#rulesSelector input[type="checkbox"]:checked');
    const selectedRules = [];

    checkboxes.forEach(cb => {
        const ruleId = cb.value;
        selectedRules.push(`rule_${ruleId}`);
    });

    if (selectedRules.length > 0) {
        const formula = selectedRules.join(' + ');
        document.getElementById('calculationFormula').value = formula;
    }
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>

{% endblock %}