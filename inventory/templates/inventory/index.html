{% extends "base.html" %}
{% block content %}
<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
        return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
    }
</script>

<!-- Форма фильтрации -->
<form method="get" class="row g-2 mb-3" id="filter-form">
    <div class="col-auto">
        <input type="text" name="q_ip" value="{{ q_ip }}" class="form-control" placeholder="IP-адрес">
    </div>
    <div class="col-auto">
        <input type="text" name="q_serial" value="{{ q_serial }}" class="form-control" placeholder="Серийный №">
    </div>

    <!-- НОВЫЕ ПОЛЯ для фильтрации по модели -->
    <div class="col-auto">
        <select name="q_manufacturer" id="filter-manufacturer" class="form-select">
            <option value="">Производитель (все)</option>
            {% for mfr in manufacturers %}
                <option value="{{ mfr.id }}" {% if q_manufacturer == mfr.id|stringformat:"s" %}selected{% endif %}>
                    {{ mfr.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="q_device_model" id="filter-device-model" class="form-select">
            <option value="">Модель (все)</option>
            {% if q_manufacturer %}
                {% for model in device_models %}
                    <option value="{{ model.id }}" {% if q_device_model == model.id|stringformat:"s" %}selected{% endif %}>
                        {{ model.name }}
                    </option>
                {% endfor %}
            {% endif %}
        </select>
    </div>
    <div class="col-auto">
        <input type="text" name="q_model_text" value="{{ q_model_text }}" class="form-control"
               placeholder="Поиск по модели" title="Текстовый поиск по названию модели или производителя">
    </div>
    <div class="col-auto">
        <select name="q_org" class="form-select">
            <option value="">Организация (все)</option>
            <option value="none" {% if q_org == 'none' %}selected{% endif %}>— без организации —</option>
            {% for org in organizations %}
                <option value="{{ org.id }}" {% if q_org|default:'' == org.id|stringformat:"s" %}selected{% endif %}>
                    {{ org.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="q_rule" class="form-select">
            <option value="">Правило (все)</option>
            <option value="SN_MAC" {% if q_rule == 'SN_MAC' %}selected{% endif %}>Серийник+MAC</option>
            <option value="MAC_ONLY" {% if q_rule == 'MAC_ONLY' %}selected{% endif %}>Только MAC</option>
            <option value="SN_ONLY" {% if q_rule == 'SN_ONLY' %}selected{% endif %}>Только серийник</option>
            <option value="NONE"     {% if q_rule == 'NONE' %}selected{% endif %}>Нет данных</option>
        </select>
    </div>
    <div class="col-auto d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-funnel me-1"></i> Фильтровать
        </button>
        <a href="{% url 'inventory:printer_list' %}" class="btn btn-primary me-2">
            <i class="bi bi-x-circle me-1"></i> Сброс
        </a>
        {% if perms.inventory.export_printers %}
            <button formaction="{% url 'inventory:export_excel' %}" class="btn btn-primary me-2">
              <i class="bi bi-file-earmark-excel me-1"></i> Экспорт в Excel
            </button>
            {% endif %}

            {% if perms.inventory.export_amb_report %}
            <a href="{% url 'inventory:export_amb' %}" class="btn btn-primary me-2">
              <i class="bi bi-file-earmark-text me-1"></i> Отчет для АМБ
            </a>
            {% endif %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#columnModal">
            <i class="bi bi-table me-1"></i> Выбрать столбцы
        </button>
    </div>
</form>

<!-- Кнопки добавления и опроса -->
{% if perms.inventory.add_printer %}
<a href="{% url "inventory:add_printer" %}" class="btn btn-success mb-3 me-2">
  <i class="bi bi-plus-circle me-1"></i> Добавить принтер
</a>
{% endif %}

{% if perms.inventory.run_inventory or perms.inventory.change_printer %}
<button id="run-all-btn" class="btn btn-primary mb-3">
  <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner-all"></span>
  <span id="run-all-text"><i class="bi bi-arrow-repeat me-1"></i> Запустить опрос всех</span>
</button>
{% endif %}


<!-- Информация о записях и страницах -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="text-muted">
        Показано {{ page_obj.start_index }}-{{ page_obj.end_index }} из {{ page_obj.paginator.count }} принтеров
    </div>
    <div class="text-muted">
        Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
    </div>
</div>

<!-- Легенда и стили -->
<style>
    .match-dot{display:inline-block;width:12px;height:12px;border-radius:50%;vertical-align:middle}
.dot-sn-mac{background:#2ecc71}
.dot-mac{background:#f39c12}
.dot-sn{background:#3498db}
.dot-unknown{background:#95a5a6}

.table-success {
    transition: background-color 0.5s ease-out;
}

.badge.bg-success {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.historical-warning {
    animation: slideInDown 0.3s ease-out;
    border-left: 4px solid #f0ad4e !important;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.toast-container {
    z-index: 1055;
}

.toast.show {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.table tr.historical-issue {
    background-color: #fff3cd;
    border-left: 4px solid #f0ad4e;
}

    .match-dot{display:inline-block;width:12px;height:12px;border-radius:50%;vertical-align:middle}
    .dot-sn-mac{background:#2ecc71}
    .dot-mac{background:#f39c12}
    .dot-sn{background:#3498db}
    .dot-unknown{background:#95a5a6}

    /* ═══ ФИКСИРОВАННЫЙ СКРОЛЛБАР ═══ */
    .fixed-scrollbar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 17px;
        background: rgba(248, 249, 250, 0.95);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        overflow-y: hidden;
        z-index: 1000;
        backdrop-filter: blur(3px);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        display: block;
    }

    .fixed-scrollbar-content {
        height: 1px;
    }

    /* Улучшенный стиль скроллбара */
    .fixed-scrollbar::-webkit-scrollbar {
        height: 14px;
    }

    .fixed-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
    }

    .fixed-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 7px;
        border: 2px solid rgba(248, 249, 250, 0.95);
    }

    .fixed-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.5);
    }

    /* Добавим отступ снизу чтобы контент не скрывался под скроллбаром */
    body {
        padding-bottom: 20px;
    }
</style>
<div class="mb-2 small text-muted">
    <span class="match-dot dot-sn-mac"></span> Серийник+MAC&nbsp;&nbsp;
    <span class="match-dot dot-mac"></span> Только MAC&nbsp;&nbsp;
    <span class="match-dot dot-sn"></span> Только серийник
</div>

<!-- Таблица -->
<div class="table-responsive" id="table-wrap">
    <table class="table table-striped table-bordered" id="printer-table">
        <thead>
            <tr>
                <th class="col-organization">Организация</th>
                <th class="col-ip_address">IP-адрес</th>
                <th class="col-serial_number">Серийный №</th>
                <th class="col-mac_address">MAC-адрес</th>
                <th class="col-device_model">Модель</th>
                <th class="col-bw_a4">ЧБ A4</th>
                <th class="col-color_a4">Цвет A4</th>
                <th class="col-bw_a3">ЧБ A3</th>
                <th class="col-color_a3">Цвет A3</th>
                <th class="col-total">Всего</th>
                <th class="col-drums">Барабаны (K/C/M/Y)</th>
                <th class="col-toners">Тонеры (K/C/M/Y)</th>
                <th class="col-fuser_kit">Fuser Kit</th>
                <th class="col-transfer_kit">Transfer Kit</th>
                <th class="col-waste_toner">Waste Toner</th>
                <th class="col-timestamp">Дата опроса</th>
                <th class="col-match_rule">Правило</th>
                {% if perms.inventory.change_printer or perms.inventory.delete_printer or perms.inventory.run_inventory %}
                <th class="col-actions">Действия</th>
                {% endif %}

            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr data-printer-id="{{ row.printer.id }}" {% if row.is_fresh %}class="table-success"{% endif %}>
                <td class="col-organization">{{ row.printer.organization.name|default:'—' }}</td>
                <td class="col-ip_address">
                    {{ row.printer.ip_address }}
                    {% if row.is_fresh %}
                        <span class="badge bg-success ms-1" title="Свежие данные из последнего опроса">
                            <i class="bi bi-check-circle"></i> Обновлено
                        </span>
                    {% endif %}
                </td>
                <td class="col-serial_number">{{ row.printer.serial_number }}</td>
                <td class="col-mac_address">{{ row.printer.mac_address|default:'—' }}</td>
                <td class="col-device_model">{{ row.printer.device_model.name|default:'—' }}</td>
                <td class="col-bw_a4">{{ row.bw_a4|default:'—' }}</td>
                <td class="col-color_a4">{{ row.color_a4|default:'—' }}</td>
                <td class="col-bw_a3">{{ row.bw_a3|default:'—' }}</td>
                <td class="col-color_a3">{{ row.color_a3|default:'—' }}</td>
                <td class="col-total">{{ row.total|default:'—' }}</td>
                <td class="col-drums">
                    {{ row.drum_black|default:'—' }} / {{ row.drum_cyan|default:'—' }} /
                    {{ row.drum_magenta|default:'—' }} / {{ row.drum_yellow|default:'—' }}
                </td>
                <td class="col-toners">
                    {{ row.toner_black|default:'—' }} / {{ row.toner_cyan|default:'—' }} /
                    {{ row.toner_magenta|default:'—' }} / {{ row.toner_yellow|default:'—' }}
                </td>
                <td class="col-fuser_kit">{{ row.fuser_kit|default:'—' }}</td>
                <td class="col-transfer_kit">{{ row.transfer_kit|default:'—' }}</td>
                <td class="col-waste_toner">{{ row.waste_toner|default:'—' }}</td>
                <td class="col-timestamp">{{ row.last_date }}</td>
                <td class="col-match_rule">
                    {% with rule=row.printer.last_match_rule %}
                    <span class="match-dot
                        {% if rule == 'SN_MAC' %}dot-sn-mac{% elif rule == 'MAC_ONLY' %}dot-mac{% elif rule == 'SN_ONLY' %}dot-sn{% else %}dot-unknown{% endif %}"
                        data-bs-toggle="tooltip"
                        data-bs-title="{% if rule == 'SN_MAC' %}Серийник + MAC{% elif rule == 'MAC_ONLY' %}Только MAC{% elif rule == 'SN_ONLY' %}Только серийник{% else %}Нет данных{% endif %}">
                    </span>
                    {% endwith %}
                </td>
                {% if perms.inventory.change_printer or perms.inventory.delete_printer or perms.inventory.run_inventory %}
                    <td class="col-actions">
                      {% if perms.inventory.change_printer %}
                      <button class="btn btn-sm btn-outline-primary me-1 edit-btn"
                              data-id="{{ row.printer.id }}"
                              data-device-model-id="{{ row.device_model_id|default:'' }}"
                              data-manufacturer-id="{{ row.manufacturer_id|default:'' }}"
                              data-bs-toggle="modal" data-bs-target="#printerModal" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                      </button>
                      {% endif %}

                      {% if perms.inventory.manage_web_parsing %}
                      <button class="btn btn-sm btn-outline-secondary me-1"
                             onclick="window.location.href='{% url 'inventory:web_parser_setup' row.printer.id %}'"
                             title="Настроить веб-парсинг">
                        <i class="bi bi-globe"></i>
                      </button>
                      {% endif %}

                      {% if perms.inventory.delete_printer %}
                      <button class="btn btn-sm btn-outline-danger me-1 delete-btn" data-id="{{ row.printer.id }}"
                              data-ip-address="{{ row.printer.ip_address }}" data-serial-number="{{ row.printer.serial_number }}"
                              title="Удалить">
                        <i class="bi bi-trash"></i>
                      </button>
                      {% endif %}

                      <button class="btn btn-sm btn-outline-info me-1 email-btn"
                                data-printer-id="{{ row.printer.id }}"
                                data-serial="{{ row.printer.serial_number }}"
                                title="Скачать письмо с информацией"
                                aria-label="Скачать письмо">
                          <i class="bi bi-envelope"></i>
                      </button>

                      <button class="btn btn-sm btn-outline-primary me-1 history-btn" data-id="{{ row.printer.id }}"
                              data-bs-toggle="modal" data-bs-target="#printerModal" title="Информация и история">
                        <i class="bi bi-clock-history"></i>
                      </button>

                      {% if perms.inventory.run_inventory or perms.inventory.change_printer %}
                      <button class="btn btn-sm btn-outline-primary run-btn" data-id="{{ row.printer.id }}" title="Опрос">
                        <span class="spinner-border spinner-border-sm me-1 d-none" id="spinner-{{ row.printer.id }}"></span>
                        <span id="run-text-{{ row.printer.id }}"><i class="bi bi-arrow-repeat"></i></span>
                      </button>
                      {% endif %}
                    </td>
                {% endif %}

            </tr>
            {% empty %}
            <tr>
                <td colspan="20" class="text-center">Принтеры не найдены</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="fixed-scrollbar" id="fixedScrollbar">
    <div class="fixed-scrollbar-content" id="fixedScrollbarContent"></div>
</div>
<!-- Пагинация -->
{% if page_obj.has_other_pages %}
<div class="d-flex justify-content-between align-items-center mt-4">
    <nav aria-label="Навигация по страницам">
        <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if q_ip %}q_ip={{ q_ip }}&{% endif %}{% if q_serial %}q_serial={{ q_serial }}&{% endif %}{% if q_model %}q_model={{ q_model }}&{% endif %}{% if q_org %}q_org={{ q_org }}&{% endif %}{% if q_rule %}q_rule={{ q_rule }}&{% endif %}per_page={{ per_page }}&page=1">«« Первая</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if q_ip %}q_ip={{ q_ip }}&{% endif %}{% if q_serial %}q_serial={{ q_serial }}&{% endif %}{% if q_model %}q_model={{ q_model }}&{% endif %}{% if q_org %}q_org={{ q_org }}&{% endif %}{% if q_rule %}q_rule={{ q_rule }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">« Предыдущая</a>
                </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if q_ip %}q_ip={{ q_ip }}&{% endif %}{% if q_serial %}q_serial={{ q_serial }}&{% endif %}{% if q_model %}q_model={{ q_model }}&{% endif %}{% if q_org %}q_org={{ q_org }}&{% endif %}{% if q_rule %}q_rule={{ q_rule }}&{% endif %}per_page={{ per_page }}&page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if q_ip %}q_ip={{ q_ip }}&{% endif %}{% if q_serial %}q_serial={{ q_serial }}&{% endif %}{% if q_model %}q_model={{ q_model }}&{% endif %}{% if q_org %}q_org={{ q_org }}&{% endif %}{% if q_rule %}q_rule={{ q_rule }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Следующая »</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if q_ip %}q_ip={{ q_ip }}&{% endif %}{% if q_serial %}q_serial={{ q_serial }}&{% endif %}{% if q_model %}q_model={{ q_model }}&{% endif %}{% if q_org %}q_org={{ q_org }}&{% endif %}{% if q_rule %}q_rule={{ q_rule }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.paginator.num_pages }}">Последняя »»</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    <div>
        <select id="per-page-select" class="form-select" style="width: auto;">
            {% for num in per_page_options %}
                <option value="{{ num }}" {% if per_page == num %}selected{% endif %}>{{ num }} на странице</option>
            {% endfor %}
        </select>
    </div>
</div>
{% endif %}

<!-- Модальное окно для выбора столбцов -->
<div class="modal fade" id="columnModal" tabindex="-1" aria-labelledby="columnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnModalLabel">Выбрать столбцы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-organization" id="col-organization" checked>
                    <label class="form-check-label" for="col-organization">Организация</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-ip_address" id="col-ip_address" checked disabled>
                    <label class="form-check-label" for="col-ip_address">IP-адрес</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-serial_number" id="col-serial_number" checked disabled>
                    <label class="form-check-label" for="col-serial_number">Серийный №</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-mac_address" id="col-mac_address" checked>
                    <label class="form-check-label" for="col-mac_address">MAC-адрес</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-device_model" id="col-device_model" checked>
                    <label class="form-check-label" for="col-device_model">Модель</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-bw_a4" id="col-bw_a4" checked>
                    <label class="form-check-label" for="col-bw_a4">ЧБ A4</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-color_a4" id="col-color_a4" checked>
                    <label class="form-check-label" for="col-color_a4">Цвет A4</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-bw_a3" id="col-bw_a3" checked>
                    <label class="form-check-label" for="col-bw_a3">ЧБ A3</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-color_a3" id="col-color_a3" checked>
                    <label class="form-check-label" for="col-color_a3">Цвет A3</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-total" id="col-total" checked>
                    <label class="form-check-label" for="col-total">Всего</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-drums" id="col-drums" checked>
                    <label class="form-check-label" for="col-drums">Барабаны (K/C/M/Y)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-toners" id="col-toners" checked>
                    <label class="form-check-label" for="col-toners">Тонеры (K/C/M/Y)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-fuser_kit" id="col-fuser_kit" checked>
                    <label class="form-check-label" for="col-fuser_kit">Fuser Kit</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-transfer_kit" id="col-transfer_kit" checked>
                    <label class="form-check-label" for="col-transfer_kit">Transfer Kit</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-waste_toner" id="col-waste_toner" checked>
                    <label class="form-check-label" for="col-waste_toner">Waste Toner</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-timestamp" id="col-timestamp" checked>
                    <label class="form-check-label" for="col-timestamp">Дата опроса</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="col-match_rule" id="col-match_rule" checked>
                    <label class="form-check-label" for="col-match_rule">Правило</label>
                </div>
                {% if perms.inventory.change_printer or perms.inventory.delete_printer or perms.inventory.run_inventory %}
                <div class="form-check">
                  <input class="form-check-input column-toggle" type="checkbox" value="col-actions" id="col-actions" checked disabled>
                  <label class="form-check-label" for="col-actions">Действия</label>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="apply-columns">Применить</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div class="modal fade" id="deletePrinterModal" tabindex="-1" aria-labelledby="deletePrinterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePrinterModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить принтер с IP-адресом <span id="delete-ip-address"></span> (Серийный №: <span id="delete-serial-number"></span>)?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Удалить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для информации и истории -->
<div class="modal fade" id="printerModal" tabindex="-1" aria-labelledby="printerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printerModalLabel">Информация о принтере</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="printerTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">Информация</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">История</button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="printerTabContent">
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <form id="edit-printer-form">
                          {% csrf_token %}
                          <div class="mb-3">
                            <label for="ip_address" class="form-label">IP-адрес</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" required
                                   {% if not perms.inventory.change_printer %}disabled{% endif %}>
                          </div>
                          <div class="mb-3">
                            <label for="serial_number" class="form-label">Серийный №</label>
                            <input type="text" class="form-control" id="serial_number" name="serial_number" required
                                   {% if not perms.inventory.change_printer %}disabled{% endif %}>
                          </div>
                          <div class="mb-3">
                            <label for="mac_address" class="form-label">MAC-адрес</label>
                            <input type="text" class="form-control" id="mac_address" name="mac_address"
                                   {% if not perms.inventory.change_printer %}disabled{% endif %}>
                          </div>

                          <div class="row g-2 mb-3">
                            <div class="col">
                              <label for="manufacturer" class="form-label">Производитель</label>
                              <select class="form-select" id="manufacturer" name="manufacturer"
                                      {% if not perms.inventory.change_printer %}disabled{% endif %}>
                                <option value="">— выберите —</option>
                              </select>
                            </div>
                            <div class="col">
                              <label for="device_model" class="form-label">Модель</label>
                              <select class="form-select" id="device_model" name="device_model"
                                      {% if not perms.inventory.change_printer %}disabled{% endif %}>
                                <option value="">— выберите —</option>
                              </select>
                            </div>
                          </div>

                          <div class="mb-3">
                            <label for="snmp_community" class="form-label">SNMP Community</label>
                            <input type="text" class="form-control" id="snmp_community" name="snmp_community" required
                                   {% if not perms.inventory.change_printer %}disabled{% endif %}>
                          </div>
                          <div class="mb-3">
                            <label for="organization" class="form-label">Организация</label>
                            <select id="organization" name="organization" class="form-select" required
                                    {% if not perms.inventory.change_printer %}disabled{% endif %}>
                              <option value="">— выберите организацию —</option>
                              {% for org in organizations %}
                                <option value="{{ org.id }}">{{ org.name }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          {% if perms.inventory.change_printer %}
                          <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> Обновить
                          </button>
                          {% else %}
                          <div class="alert alert-info">У вас нет прав на редактирование — доступен только просмотр.</div>
                          {% endif %}
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        </form>

                    </div>
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                        <canvas id="historyChart" style="max-height: 400px;"></canvas>
                        <div class="mt-3">
                            <h6>История опросов</h6>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>ЧБ A4</th>
                                        <th>Цвет A4</th>
                                        <th>ЧБ A3</th>
                                        <th>Цвет A3</th>
                                        <th>Всего</th>
                                        <th>Тонер (K/C/M/Y)</th>
                                        <th>Барабан (K/C/M/Y)</th>
                                        <th>Fuser Kit</th>
                                        <th>Transfer Kit</th>
                                        <th>Waste Toner</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
  // ---------- CSRF helper ----------
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  function csrfHeaders(extra = {}) {
    return Object.assign(
      { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
      extra
    );
  }

  // ---------- Tooltips ----------
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  });

  // ---------- Column visibility ----------
  function defaultVisibleColumns() {
    const base = [
      'col-organization','col-ip_address','col-serial_number','col-mac_address','col-device_model',
      'col-bw_a4','col-color_a4','col-bw_a3','col-color_a3','col-total',
      'col-drums','col-toners','col-fuser_kit','col-transfer_kit','col-waste_toner',
      'col-timestamp','col-match_rule'
    ];
    if (document.querySelector('#printer-table th.col-actions')) base.push('col-actions');
    return base;
  }

  function updateColumnVisibility() {
    const visibleColumns = JSON.parse(localStorage.getItem('visibleColumns')) || defaultVisibleColumns();
    document.querySelectorAll('#printer-table th, #printer-table td').forEach(cell => {
        const colClass = [...cell.classList].find(c => c.startsWith('col-'));
        if (!colClass) return;
        cell.style.display = visibleColumns.includes(colClass) ? '' : 'none';
    });
    const emptyRow = document.querySelector('#printer-table tbody tr td[colspan]');
    if (emptyRow) emptyRow.setAttribute('colspan', visibleColumns.length);
    document.querySelectorAll('.column-toggle').forEach(checkbox => {
        checkbox.checked = visibleColumns.includes(checkbox.value) || checkbox.disabled;
    });

    // Обновляем скроллбар после изменения видимости колонок
    if (typeof syncScrollbarWidth === 'function') {
        setTimeout(syncScrollbarWidth, 100);
    }
}

  document.addEventListener('DOMContentLoaded', updateColumnVisibility);

  const applyColumnsBtn = document.getElementById('apply-columns');
  if (applyColumnsBtn) {
    applyColumnsBtn.addEventListener('click', () => {
      const visibleColumns = [];
      document.querySelectorAll('.column-toggle:checked').forEach(cb => visibleColumns.push(cb.value));

      ['col-ip_address', 'col-serial_number'].forEach(c => {
        if (!visibleColumns.includes(c)) visibleColumns.push(c);
      });
      if (document.querySelector('#printer-table th.col-actions') &&
          !visibleColumns.includes('col-actions')) {
        visibleColumns.push('col-actions');
      }

      localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
      updateColumnVisibility();
      bootstrap.Modal.getInstance(document.getElementById('columnModal')).hide();
    });
  }

  // ---------- Model/Manufacturer logic ----------
  let allModels = [];
  let selectedModelId = '';
  let selectedManufacturerId = '';

  async function loadAllModels() {
    try {
      const resp = await fetch("{% url 'inventory:api_all_printer_models' %}");
      const data = await resp.json();
      allModels = data.models || [];

      const mfrMap = new Map();
      allModels.forEach(m => {
        if (!mfrMap.has(m.manufacturer_id)) {
          mfrMap.set(m.manufacturer_id, {id: m.manufacturer_id, name: m.manufacturer});
        }
      });

      const manufacturers = Array.from(mfrMap.values()).sort((a, b) => a.name.localeCompare(b.name));
      const $manufacturer = document.getElementById('manufacturer');
      if ($manufacturer) {
        $manufacturer.innerHTML = '<option value="">— выберите —</option>';
        manufacturers.forEach(mfr => {
          const opt = document.createElement('option');
          opt.value = mfr.id;
          opt.textContent = mfr.name;
          $manufacturer.appendChild(opt);
        });
      }
    } catch (err) {
      console.error('Error loading models:', err);
    }
  }

  function updateModelsDropdown(manufacturerId) {
    const $deviceModel = document.getElementById('device_model');
    if (!$deviceModel) return;

    const filtered = manufacturerId ? allModels.filter(m => String(m.manufacturer_id) === String(manufacturerId)) : [];
    $deviceModel.innerHTML = '<option value="">— ' + (manufacturerId ? 'выберите модель' : 'сначала выберите производителя') + ' —</option>';

    filtered.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.name;
      $deviceModel.appendChild(opt);
    });

    if (selectedModelId) $deviceModel.value = selectedModelId;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadAllModels();

    const $manufacturer = document.getElementById('manufacturer');
    const $deviceModel = document.getElementById('device_model');

    if ($manufacturer) {
      $manufacturer.addEventListener('change', function() {
        selectedManufacturerId = this.value;
        updateModelsDropdown(this.value);
        if (!this.value) {
          selectedModelId = '';
          if ($deviceModel) $deviceModel.value = '';
        }
      });
    }

    if ($deviceModel) {
      $deviceModel.addEventListener('change', function() {
        selectedModelId = this.value;
      });
    }
  });

  // ---------- WebSocket & Toast functions ----------
  function showToast(title, message, type = 'info', duration = 5000) {
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
      toastContainer.style.zIndex = '1055';
      document.body.appendChild(toastContainer);
    }

    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'warning' ? 'exclamation-triangle' :
                      type === 'error' ? 'x-circle' :
                      type === 'success' ? 'check-circle' : 'info-circle';

    const toastHtml = `
      <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <i class="bi bi-${iconClass} text-${type === 'error' ? 'danger' : type} me-2"></i>
          <strong class="me-auto">${title}</strong>
          <small class="text-muted">сейчас</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
          ${message}
        </div>
      </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    const toast = new bootstrap.Toast(document.getElementById(toastId), {
      delay: duration
    });
    toast.show();

    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
      this.remove();
    });
  }

  function showHistoricalInconsistencyNotification(printerId, message) {
    const row = document.querySelector(`tr[data-printer-id="${printerId}"]`);
    if (!row) return;

    row.classList.add('historical-issue');

    const ipCell = row.querySelector('.col-ip_address');
    if (ipCell) {
      const oldNotification = ipCell.querySelector('.historical-warning');
      if (oldNotification) {
        oldNotification.remove();
      }

      const notification = document.createElement('div');
      notification.className = 'historical-warning alert alert-warning py-1 px-2 mt-1 small';
      notification.style.fontSize = '0.75rem';
      notification.innerHTML = `
        <i class="bi bi-exclamation-triangle me-1"></i>
        <strong>Данные не обновлены:</strong><br>
        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="${message}">
          ${message}
        </span>
        <button type="button" class="btn-close btn-close-sm ms-2 float-end"
                onclick="this.parentElement.remove(); this.closest('tr').classList.remove('historical-issue')">
        </button>
      `;

      ipCell.appendChild(notification);

      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
          row.classList.remove('historical-issue');
        }
      }, 20000);
    }

    showToast(
      'Исторические данные не согласованы',
      `Принтер ${printerId}: ${message}`,
      'warning',
      10000
    );
  }

  // ---------- WebSocket ----------
  let ws;
  try {
    ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws/inventory/');
  } catch (err) {
    console.error('WebSocket init error:', err);
  }

  if (ws) {
    ws.onopen = () => {
      console.log('WebSocket connected');
    };

    ws.onclose = () => {
      console.log('WebSocket disconnected');
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    ws.onmessage = e => {
      const d = JSON.parse(e.data || '{}');
      const row = document.querySelector(`tr[data-printer-id="${d.printer_id}"]`);
      if (!row) return;

      if (d.type === 'inventory_start') {
        const sp = document.getElementById(`spinner-${d.printer_id}`);
        const rt = document.getElementById(`run-text-${d.printer_id}`);
        const spAll = document.getElementById('spinner-all');
        const rtAll = document.getElementById('run-all-text');
        if (sp) sp.classList.remove('d-none');
        if (rt) rt.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
        if (spAll) spAll.classList.remove('d-none');
        if (rtAll) rtAll.innerHTML = '<i class="bi bi-arrow-repeat"></i> Опрос…';
        return;
      }

      if (d.type === 'inventory_update') {
        if (d.status === 'HISTORICAL_INCONSISTENCY') {
          const sp = document.getElementById(`spinner-${d.printer_id}`);
          const rt = document.getElementById(`run-text-${d.printer_id}`);
          const spAll = document.getElementById('spinner-all');
          const rtAll = document.getElementById('run-all-text');
          if (sp) sp.classList.add('d-none');
          if (rt) rt.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
          if (spAll) spAll.classList.add('d-none');
          if (rtAll) rtAll.innerHTML = '<i class="bi bi-arrow-repeat"></i> Запустить опрос всех';

          showHistoricalInconsistencyNotification(d.printer_id, d.message);
          return;
        }

        if (d.status === 'FAILED' || d.status === 'VALIDATION_ERROR') {
          const sp = document.getElementById(`spinner-${d.printer_id}`);
          const rt = document.getElementById(`run-text-${d.printer_id}`);
          const spAll = document.getElementById('spinner-all');
          const rtAll = document.getElementById('run-all-text');
          if (sp) sp.classList.add('d-none');
          if (rt) rt.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
          if (spAll) spAll.classList.add('d-none');
          if (rtAll) rtAll.innerHTML = '<i class="bi bi-arrow-repeat"></i> Запустить опрос всех';

          showToast('Ошибка опроса', `Принтер ${d.printer_id}: ${d.message}`, 'error');
          return;
        }

        // SUCCESS - update table
        const visibleColumns = JSON.parse(localStorage.getItem('visibleColumns')) || defaultVisibleColumns();

        if (!row.dataset.freshAnimated) {
          row.classList.remove('historical-issue');
          row.classList.add('table-success');
          row.dataset.freshAnimated = 'true';

          setTimeout(() => {
            row.classList.remove('table-success');
            delete row.dataset.freshAnimated;
          }, 5000);
        }

        const ipCell = row.querySelector('.col-ip_address');
        if (ipCell && visibleColumns.includes('col-ip_address')) {
          const oldWarning = ipCell.querySelector('.historical-warning');
          if (oldWarning) {
            oldWarning.remove();
          }

          const ipText = ipCell.textContent.trim().split('\n')[0].trim();
          const ipMatch = ipText.match(/^[\d.]+/);
          const ip = ipMatch ? ipMatch[0] : ipText;

          ipCell.innerHTML = `${ip} <span class="badge bg-success ms-1" title="Свежие данные из последнего опроса">
            <i class="bi bi-check-circle"></i> Обновлено
          </span>`;

          if (ipCell.dataset.badgeTimer) {
            clearTimeout(parseInt(ipCell.dataset.badgeTimer));
          }

          const timerId = setTimeout(() => {
            ipCell.innerHTML = ip;
            delete ipCell.dataset.badgeTimer;
          }, 5000);

          ipCell.dataset.badgeTimer = timerId;
        }

        ['bw_a4', 'color_a4', 'bw_a3', 'color_a3', 'total'].forEach(k => {
          const c = row.querySelector(`.col-${k}`);
          if (c && visibleColumns.includes(`col-${k}`)) c.textContent = d[k] ?? '—';
        });

        const drums = row.querySelector('.col-drums');
        if (drums && visibleColumns.includes('col-drums')) {
          drums.textContent = `${d.drum_black ?? '—'} / ${d.drum_cyan ?? '—'} / ${d.drum_magenta ?? '—'} / ${d.drum_yellow ?? '—'}`;
        }
        const toners = row.querySelector('.col-toners');
        if (toners && visibleColumns.includes('col-toners')) {
          toners.textContent = `${d.toner_black ?? '—'} / ${d.toner_cyan ?? '—'} / ${d.toner_magenta ?? '—'} / ${d.toner_yellow ?? '—'}`;
        }
        const fuser = row.querySelector('.col-fuser_kit');
        if (fuser && visibleColumns.includes('col-fuser_kit')) fuser.textContent = d.fuser_kit ?? '—';
        const transfer = row.querySelector('.col-transfer_kit');
        if (transfer && visibleColumns.includes('col-transfer_kit')) transfer.textContent = d.transfer_kit ?? '—';
        const waste = row.querySelector('.col-waste_toner');
        if (waste && visibleColumns.includes('col-waste_toner')) waste.textContent = d.waste_toner ?? '—';

        const timestamp = row.querySelector('.col-timestamp');
        if (timestamp && visibleColumns.includes('col-timestamp') && d.timestamp) {
          try {
            timestamp.textContent = new Date(d.timestamp).toLocaleString('ru-RU', {
              day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
          } catch {}
        }

        const dot = row.querySelector('.col-match_rule .match-dot');
        if (dot && visibleColumns.includes('col-match_rule')) {
          const clsMap = { 'SN_MAC': 'dot-sn-mac', 'MAC_ONLY': 'dot-mac', 'SN_ONLY': 'dot-sn' };
          const titleMap = { 'SN_MAC': 'Серийник + MAC', 'MAC_ONLY': 'Только MAC', 'SN_ONLY': 'Только серийник' };
          dot.classList.remove('dot-sn-mac', 'dot-mac', 'dot-sn', 'dot-unknown');
          dot.classList.add(clsMap[d.match_rule] || 'dot-unknown');
          const newTitle = titleMap[d.match_rule] || 'Нет данных';
          const t = bootstrap.Tooltip.getInstance(dot);
          if (t) t.dispose();
          dot.setAttribute('data-bs-title', newTitle);
          new bootstrap.Tooltip(dot);
        }

        const sp = document.getElementById(`spinner-${d.printer_id}`);
        const rt = document.getElementById(`run-text-${d.printer_id}`);
        const spAll = document.getElementById('spinner-all');
        const rtAll = document.getElementById('run-all-text');
        if (sp) sp.classList.add('d-none');
        if (rt) rt.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
        if (spAll) spAll.classList.add('d-none');
        if (rtAll) rtAll.innerHTML = '<i class="bi bi-arrow-repeat"></i> Запустить опрос всех';
      }
    };
  }

  // ---------- Single inventory run ----------
  document.querySelectorAll('.run-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const sp = document.getElementById(`spinner-${id}`);
      const rt = document.getElementById(`run-text-${id}`);
      if (sp) sp.classList.remove('d-none');
      if (rt) rt.innerHTML = '<i class="bi bi-arrow-repeat"></i>';

      fetch(`{% url 'inventory:run_inventory' 0 %}`.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: csrfHeaders()
      })
      .then(r => r.json())
      .then(data => console.log('Run inventory response:', data))
      .catch(err => console.error('Run inventory error:', err));
    });
  });

  // ---------- Run all ----------
  const runAllBtn = document.getElementById('run-all-btn');
  if (runAllBtn) {
    runAllBtn.addEventListener('click', () => {
      const spAll = document.getElementById('spinner-all');
      const rtAll = document.getElementById('run-all-text');
      if (spAll) spAll.classList.remove('d-none');
      if (rtAll) rtAll.innerHTML = '<i class="bi bi-arrow-repeat"></i> Опрос…';

      fetch('{% url 'inventory:run_inventory_all' %}', {
        method: 'POST',
        headers: csrfHeaders()
      })
      .then(r => r.json())
      .then(data => console.log('Run all inventory response:', data))
      .catch(err => console.error('Run all inventory error:', err));
    });
  }

  // ---------- Per-page select ----------
  const perPageSelect = document.getElementById('per-page-select');
  if (perPageSelect) {
    perPageSelect.addEventListener('change', function () {
      const url = new URL(window.location);
      url.searchParams.set('per_page', this.value);
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  }

  // ---------- Modal open: info & history ----------
  let historyChart = null;
  document.querySelectorAll('.edit-btn, .history-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const printerId = btn.dataset.id;
      const isEdit = btn.classList.contains('edit-btn');
      const infoTab = document.getElementById('info-tab');
      const historyTab = document.getElementById('history-tab');
      if (isEdit && infoTab) infoTab.click();
      else if (historyTab) historyTab.click();

      // Load printer info
      fetch(`{% url 'inventory:api_printer' 0 %}`.replace('/0/', `/${printerId}/`), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        document.getElementById('ip_address').value = data.ip_address || '';
        document.getElementById('serial_number').value = data.serial_number || '';
        document.getElementById('mac_address').value = data.mac_address || '';
        document.getElementById('organization').value = data.organization_id || '';
        document.getElementById('snmp_community').value = data.snmp_community || '';

        // Set model data
        selectedModelId = data.device_model_id || '';
        selectedManufacturerId = data.manufacturer_id || '';

        if (selectedManufacturerId) {
          const $manufacturer = document.getElementById('manufacturer');
          if ($manufacturer) {
            $manufacturer.value = selectedManufacturerId;
            updateModelsDropdown(selectedManufacturerId);
            setTimeout(() => {
              const $deviceModel = document.getElementById('device_model');
              if ($deviceModel && selectedModelId) {
                $deviceModel.value = selectedModelId;
              }
            }, 100);
          }
        }

        document.getElementById('edit-printer-form').dataset.printerId = printerId;
        document.getElementById('printerModalLabel').textContent = `Принтер ${data.ip_address}`;
      })
      .catch(error => {
        console.error('Error loading printer data:', error);
        alert('Ошибка загрузки данных принтера: ' + error.message);
      });

      // Load history (unchanged)
      fetch(`{% url 'inventory:history' 0 %}`.replace('/0/', `/${printerId}/`), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('History API response:', data);
        const labels = data.map(row => new Date(row.task_timestamp).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }));
        const datasets = [
          { label: 'ЧБ A4', data: data.map(row => row.bw_a4 || 0), borderColor: '#000000', yAxisID: 'y', borderWidth: 2, borderDash: [], pointStyle: 'line', hidden: false },
          { label: 'Цвет A4', data: data.map(row => row.color_a4 || 0), borderColor: '#ff0000', yAxisID: 'y', borderWidth: 2, borderDash: [], pointStyle: 'line', hidden: false },
          { label: 'ЧБ A3', data: data.map(row => row.bw_a3 || 0), borderColor: '#0000ff', yAxisID: 'y', borderWidth: 2, borderDash: [], pointStyle: 'line', hidden: false },
          { label: 'Цвет A3', data: data.map(row => row.color_a3 || 0), borderColor: '#00ff00', yAxisID: 'y', borderWidth: 2, borderDash: [], pointStyle: 'line', hidden: false },
          { label: 'Всего', data: data.map(row => row.total_pages || 0), borderColor: '#ff00ff', yAxisID: 'y', borderWidth: 2, borderDash: [], pointStyle: 'line', hidden: false },
          { label: 'Тонер (K)', data: data.map(row => row.toner_black || 0), borderColor: '#333333', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Тонер (C)', data: data.map(row => row.toner_cyan || 0), borderColor: '#00ffff', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Тонер (M)', data: data.map(row => row.toner_magenta || 0), borderColor: '#ff3399', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Тонер (Y)', data: data.map(row => row.toner_yellow || 0), borderColor: '#ffff00', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Барабан (K)', data: data.map(row => row.drum_black || 0), borderColor: '#666666', yAxisID: 'y1', borderWidth: 0, borderDash: [], pointStyle: 'circle', pointRadius: 5, pointHoverRadius: 7, hidden: false },
          { label: 'Барабан (C)', data: data.map(row => row.drum_cyan || 0), borderColor: '#3399ff', yAxisID: 'y1', borderWidth: 0, borderDash: [], pointStyle: 'circle', pointRadius: 5, pointHoverRadius: 7, hidden: false },
          { label: 'Барабан (M)', data: data.map(row => row.drum_magenta || 0), borderColor: '#cc00cc', yAxisID: 'y1', borderWidth: 0, borderDash: [], pointStyle: 'circle', pointRadius: 5, pointHoverRadius: 7, hidden: false },
          { label: 'Барабан (Y)', data: data.map(row => row.drum_yellow || 0), borderColor: '#cccc00', yAxisID: 'y1', borderWidth: 0, borderDash: [], pointStyle: 'circle', pointRadius: 5, pointHoverRadius: 7, hidden: false },
          { label: 'Fuser Kit', data: data.map(row => row.fuser_kit || 0), borderColor: '#ff9933', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Transfer Kit', data: data.map(row => row.transfer_kit || 0), borderColor: '#33cc33', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false },
          { label: 'Waste Toner', data: data.map(row => row.waste_toner || 0), borderColor: '#9933ff', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], pointStyle: 'line', hidden: false }
        ];

        const hasNonZero = ds => (ds.data || []).some(v => v != null && v !== 0);
        datasets.forEach(ds => { ds.hidden = !hasNonZero(ds); });

        if (historyChart) historyChart.destroy();

        historyChart = new Chart(document.getElementById('historyChart'), {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y:  { position: 'left',  title: { display: true, text: 'Счётчики (страницы)' } },
              y1: { position: 'right', title: { display: true, text: 'Расходники (%)' }, max: 100, min: 0 }
            },
            plugins: {
              legend: {
                position: 'top',
                onClick: (e, legendItem, legend) => {
                  const index = legendItem.datasetIndex;
                  const ci = legend.chart;
                  const meta = ci.getDatasetMeta(index);
                  meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                  ci.data.datasets[index].hidden = !ci.data.datasets[index].hidden;
                  ci.update();
                },
                labels: {
                  filter: (legendItem, chartData) => hasNonZero(chartData.datasets[legendItem.datasetIndex])
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                filter: tip => tip.raw !== 0
              }
            }
          }
        });

        const tbody = document.getElementById('historyTableBody');
        if (tbody) {
          tbody.innerHTML = '';
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(row.task_timestamp).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
              <td>${row.bw_a4 || '—'}</td>
              <td>${row.color_a4 || '—'}</td>
              <td>${row.bw_a3 || '—'}</td>
              <td>${row.color_a3 || '—'}</td>
              <td>${row.total_pages || '—'}</td>
              <td>${row.toner_black || '—'}/${row.toner_cyan || '—'}/${row.toner_magenta || '—'}/${row.toner_yellow || '—'}</td>
              <td>${row.drum_black || '—'}/${row.drum_cyan || '—'}/${row.drum_magenta || '—'}/${row.drum_yellow || '—'}</td>
              <td>${row.fuser_kit || '—'}</td>
              <td>${row.transfer_kit || '—'}</td>
              <td>${row.waste_toner || '—'}</td>
            `;
            tbody.appendChild(tr);
          });
        }
      })
      .catch(error => {
        console.error('Error loading history data:', error);
        alert('Ошибка загрузки истории: ' + error.message);
      });
    });
  });

  // ---------- Edit form submit ----------
  const editForm = document.getElementById('edit-printer-form');
  if (editForm) {
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const printerId = e.target.dataset.printerId;
      const formData = new FormData(e.target);

      fetch(`{% url 'inventory:edit_printer' 0 %}`.replace('/0/', `/${printerId}/`), {
        method: 'POST',
        body: formData,
        headers: csrfHeaders()
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const row = document.querySelector(`tr[data-printer-id="${printerId}"]`);
          if (row) {
            const visibleColumns = JSON.parse(localStorage.getItem('visibleColumns')) || defaultVisibleColumns();
            if (visibleColumns.includes('col-ip_address'))    row.querySelector('.col-ip_address').textContent = data.printer.ip_address;
            if (visibleColumns.includes('col-serial_number')) row.querySelector('.col-serial_number').textContent = data.printer.serial_number;
            if (visibleColumns.includes('col-mac_address'))   row.querySelector('.col-mac_address').textContent = data.printer.mac_address || '—';
            if (visibleColumns.includes('col-organization')) {
              const orgCell = row.querySelector('.col-organization');
              if (orgCell) orgCell.textContent = data.printer.organization || '—';
            }
          }
          bootstrap.Modal.getInstance(document.getElementById('printerModal')).hide();
          alert('Принтер обновлён');
        } else {
          alert('Ошибка при обновлении принтера: ' + (data.error || 'Неизвестная ошибка'));
        }
      })
      .catch(error => {
        console.error('Error submitting form:', error);
        alert('Ошибка при обновлении принтера: ' + error.message);
      });
    });
  }

  // ---------- Delete flow ----------
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const printerId = btn.dataset.id;
      const ipAddress = btn.dataset.ipAddress;
      const serialNumber = btn.dataset.serialNumber;
      document.getElementById('delete-ip-address').textContent = ipAddress || '';
      document.getElementById('delete-serial-number').textContent = serialNumber || '';
      document.getElementById('confirmDeleteButton').dataset.printerId = printerId;
      new bootstrap.Modal(document.getElementById('deletePrinterModal')).show();
    });
  });

  const confirmDeleteButton = document.getElementById('confirmDeleteButton');
  if (confirmDeleteButton) {
    confirmDeleteButton.addEventListener('click', () => {
      const printerId = confirmDeleteButton.dataset.printerId;
      fetch(`{% url 'inventory:delete_printer' 0 %}`.replace('/0/', `/${printerId}/`), {
        method: 'POST',
        headers: csrfHeaders()
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const row = document.querySelector(`tr[data-printer-id="${printerId}"]`);
          if (row) row.remove();
          bootstrap.Modal.getInstance(document.getElementById('deletePrinterModal')).hide();
          alert('Принтер удалён');
        } else {
          alert('Ошибка при удалении принтера');
        }
      })
      .catch(error => {
        console.error('Error deleting printer:', error);
        alert('Ошибка при удалении принтера: ' + error.message);
      });
    });
  }

  // ---------- Email button ----------
  document.querySelectorAll('.email-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
      e.preventDefault();
      const printerId = this.dataset.printerId;
      const serial = this.dataset.serial;

      if (!serial) {
        alert('У принтера отсутствует серийный номер');
        return;
      }

      try {
        const response = await fetch(
          `{% url 'contracts:api_lookup_by_serial' %}?serial=${encodeURIComponent(serial)}`,
          {headers: {'X-Requested-With': 'fetch'}}
        );
        const data = await response.json();

        if (!data.ok || !data.found) {
          alert(`Устройство с серийным номером ${serial} не найдено в договорах. Добавьте его сначала в раздел "Устройства в договоре".`);
          return;
        }

        window.location.href = `/contracts/${data.device.id}/email/`;
      } catch (err) {
        alert('Ошибка при проверке устройства: ' + err.message);
      }
    });
  });
  // Фильтр моделей - динамическая загрузка при изменении производителя
document.addEventListener('DOMContentLoaded', function() {
    const filterManufacturer = document.getElementById('filter-manufacturer');
    const filterDeviceModel = document.getElementById('filter-device-model');

    if (filterManufacturer && filterDeviceModel) {
        filterManufacturer.addEventListener('change', async function() {
            const manufacturerId = this.value;
            filterDeviceModel.innerHTML = '<option value="">Модель (все)</option>';

            if (!manufacturerId) {
                return;
            }

            filterDeviceModel.innerHTML = '<option value="">Загрузка...</option>';
            filterDeviceModel.disabled = true;

            try {
                const response = await fetch(`{% url 'inventory:api_models_by_manufacturer' %}?manufacturer_id=${manufacturerId}`);
                const data = await response.json();

                filterDeviceModel.innerHTML = '<option value="">Модель (все)</option>';

                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        filterDeviceModel.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки моделей:', error);
                filterDeviceModel.innerHTML = '<option value="">Ошибка загрузки</option>';
            } finally {
                filterDeviceModel.disabled = false;
            }
        });
    }

    // Синхронизация фильтров
    const modelTextInput = document.querySelector('input[name="q_model_text"]');

    if (modelTextInput && filterManufacturer && filterDeviceModel) {
        // При вводе текста очищаем dropdowns
        modelTextInput.addEventListener('input', function() {
            if (this.value) {
                filterManufacturer.value = '';
                filterDeviceModel.innerHTML = '<option value="">Модель (все)</option>';
            }
        });

        // При выборе dropdown очищаем текстовое поле
        [filterManufacturer, filterDeviceModel].forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    modelTextInput.value = '';
                }
            });
        });
    }
});
// ===== ФИКСИРОВАННЫЙ СКРОЛЛБАР =====
(function() {
    const tableWrapper = document.querySelector('.table-responsive');
    const fixedScrollbar = document.getElementById('fixedScrollbar');
    const fixedScrollbarContent = document.getElementById('fixedScrollbarContent');

    if (!tableWrapper || !fixedScrollbar || !fixedScrollbarContent) return;

    // Функция для синхронизации ширины скроллбара с таблицей
    function syncScrollbarWidth() {
        const table = tableWrapper.querySelector('table');
        if (!table) return;

        // Устанавливаем ширину контента скроллбара равной ширине таблицы
        fixedScrollbarContent.style.width = table.scrollWidth + 'px';

        // Показываем/скрываем скроллбар в зависимости от необходимости
        if (table.scrollWidth > tableWrapper.clientWidth) {
            fixedScrollbar.style.display = 'block';
        } else {
            fixedScrollbar.style.display = 'none';
        }
    }

    // Синхронизация прокрутки: таблица -> фиксированный скроллбар
    tableWrapper.addEventListener('scroll', function() {
        fixedScrollbar.scrollLeft = tableWrapper.scrollLeft;
    });

    // Синхронизация прокрутки: фиксированный скроллбар -> таблица
    fixedScrollbar.addEventListener('scroll', function() {
        tableWrapper.scrollLeft = fixedScrollbar.scrollLeft;
    });

    // Инициализация и обновление при изменении размеров
    syncScrollbarWidth();
    window.addEventListener('resize', syncScrollbarWidth);

    // Обновляем при изменении видимости колонок
    const columnModal = document.getElementById('columnModal');
    if (columnModal) {
        columnModal.addEventListener('hidden.bs.modal', function() {
            setTimeout(syncScrollbarWidth, 100);
        });
    }

    // Обновляем при применении колонок
    const applyColumnsBtn = document.getElementById('apply-columns');
    if (applyColumnsBtn) {
        const originalClickHandler = applyColumnsBtn.onclick;
        applyColumnsBtn.onclick = function(e) {
            if (originalClickHandler) originalClickHandler.call(this, e);
            setTimeout(syncScrollbarWidth, 100);
        };
    }

    // Следим за изменениями в таблице (например, при добавлении/удалении строк через WebSocket)
    const observer = new MutationObserver(syncScrollbarWidth);
    observer.observe(tableWrapper, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class', 'style']
    });

    console.log('Фиксированный скроллбар инициализирован');
})();

})();

</script>

{% endblock %}