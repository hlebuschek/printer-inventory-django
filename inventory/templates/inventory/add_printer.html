{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5">
    <h2 class="mb-4">
      {% if form.instance.pk %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä{% else %}–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä{% endif %}
    </h2>

    <form method="post" novalidate id="printerForm">
      {% csrf_token %}

      {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
      {% endif %}

      <div class="mb-3">
        <label for="id_ip_address" class="form-label">IP-–∞–¥—Ä–µ—Å <span class="text-danger">*</span></label>
        {{ form.ip_address }}
        {{ form.ip_address.errors }}
      </div>

      <div class="mb-3">
        <label for="id_serial_number" class="form-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä <span class="text-danger">*</span></label>
        {{ form.serial_number }}
        {{ form.serial_number.errors }}
      </div>

      <div class="row g-2 mb-3">
        <div class="col">
          <label for="id_manufacturer" class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
          <select class="form-select" id="id_manufacturer" name="manufacturer">
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
          </select>
        </div>

        <div class="col">
          <label for="id_device_model" class="form-label">–ú–æ–¥–µ–ª—å</label>
          <select class="form-select" id="id_device_model" name="device_model">
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
          </select>
          {{ form.device_model.errors }}
        </div>
      </div>

      <div class="mb-3">
        <label for="id_model" class="form-label">–ò–ª–∏ –º–æ–¥–µ–ª—å —Ç–µ–∫—Å—Ç–æ–º</label>
        {{ form.model }}
        <small class="text-muted d-block mt-1">–ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ</small>
        {{ form.model.errors }}
      </div>

      <div class="mb-3">
        <label for="id_snmp_community" class="form-label">SNMP —Å–æ–æ–±—â–µ—Å—Ç–≤–æ</label>
        {{ form.snmp_community }}
        {{ form.snmp_community.errors }}
      </div>

      <div class="mb-3">
        <label for="id_mac_address" class="form-label">MAC-–∞–¥—Ä–µ—Å</label>
        {{ form.mac_address }}
        {{ form.mac_address.errors }}
      </div>

      <div class="mb-3">
        <label for="id_organization" class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è <span class="text-danger">*</span></label>
        {{ form.organization }}
        {{ form.organization.errors }}
      </div>

      <div class="mb-3 p-3 bg-light rounded">
        <button type="button" class="btn btn-outline-primary w-100" id="btn-probe">
          <i class="bi bi-broadcast"></i> –û–ø—Ä–æ—Å–∏—Ç—å –ø–æ SNMP
        </button>
        <div id="probe-message" class="mt-2 text-center small" style="display: none;"></div>
        <small class="text-muted d-block mt-2 text-center">
          –ï—Å–ª–∏ SNMP community –ø—É—Å—Ç–æ–µ ‚Äî –≤–æ–∑—å–º—ë–º <code>public</code>
        </small>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <a href="{% url 'inventory:printer_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-x-lg"></i> –û—Ç–º–µ–Ω–∞
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function(){
  const $serial = document.getElementById("id_serial_number");
  const $org = document.getElementById("id_organization");
  const $modelText = document.getElementById("id_model");
  const $ip = document.getElementById("id_ip_address");
  const $comm = document.getElementById("id_snmp_community");
  const $btnProbe = document.getElementById("btn-probe");
  const $probeMessage = document.getElementById("probe-message");
  const $manufacturer = document.getElementById("id_manufacturer");
  const $deviceModel = document.getElementById("id_device_model");

  let allModels = [];
  let selectedModelId = "{{ form.device_model.value|default:'' }}";

  function showMessage(text, isError = false) {
    $probeMessage.textContent = text;
    $probeMessage.className = isError ? 'mt-2 text-center small text-danger' : 'mt-2 text-center small text-success';
    $probeMessage.style.display = 'block';
    setTimeout(() => $probeMessage.style.display = 'none', 4000);
  }

  async function loadData() {
    try {
      const resp = await fetch("{% url 'inventory:api_all_printer_models' %}");
      const data = await resp.json();
      allModels = data.models || [];

      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–æ–¥–µ–ª–µ–π:', allModels.length);

      const mfrMap = new Map();
      allModels.forEach(m => {
        if (!mfrMap.has(m.manufacturer_id)) {
          mfrMap.set(m.manufacturer_id, {id: m.manufacturer_id, name: m.manufacturer});
        }
      });

      const manufacturers = Array.from(mfrMap.values()).sort((a, b) => a.name.localeCompare(b.name));

      $manufacturer.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      manufacturers.forEach(mfr => {
        const opt = document.createElement('option');
        opt.value = mfr.id;
        opt.textContent = mfr.name;
        $manufacturer.appendChild(opt);
      });

      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π:', manufacturers.length);

      if (selectedModelId) {
        const selected = allModels.find(m => String(m.id) === String(selectedModelId));
        if (selected) {
          $manufacturer.value = selected.manufacturer_id;
          updateModels(selected.manufacturer_id);
          setTimeout(() => $deviceModel.value = selectedModelId, 50);
        }
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
    }
  }

  function updateModels(manufacturerId) {
    const filtered = manufacturerId ? allModels.filter(m => String(m.manufacturer_id) === String(manufacturerId)) : [];

    console.log('–§–∏–ª—å—Ç—Ä –º–æ–¥–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è', manufacturerId, ':', filtered.length);

    $deviceModel.innerHTML = '<option value="">‚Äî ' + (manufacturerId ? '–≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å' : '—Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è') + ' ‚Äî</option>';
    filtered.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.name;
      $deviceModel.appendChild(opt);
    });

    if (selectedModelId) $deviceModel.value = selectedModelId;
  }

  $manufacturer?.addEventListener('change', function() {
    updateModels(this.value);
    if (!this.value) {
      selectedModelId = '';
      $deviceModel.value = '';
    }
  });

  $deviceModel?.addEventListener('change', function() {
    selectedModelId = this.value;
    if (this.value) {
      const selected = allModels.find(m => String(m.id) === String(this.value));
      if (selected && !$modelText.value.trim()) {
        $modelText.value = selected.name;
      }
    }
  });

  async function lookupBySerial(serial) {
  if (!serial) return;

  console.log('üîç –ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–∏–∫—É:', serial);

  try {
    const url = "{% url 'contracts:api_lookup_by_serial' %}?serial=" + encodeURIComponent(serial);
    const resp = await fetch(url, {headers: {'X-Requested-With': 'fetch'}});

    if (!resp.headers.get('content-type')?.includes('application/json')) {
      console.warn('–ù–µ–≤–µ—Ä–Ω—ã–π content-type');
      return;
    }

    const data = await resp.json();
    console.log('üì¶ –û—Ç–≤–µ—Ç –æ—Ç API:', data);

    if (!data.ok || !data.found) {
      console.log('‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
      return;
    }

    // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
    const orgId = String(data.device.organization?.id || "");
    if (orgId && $org) {
      console.log('üè¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é:', orgId);
      [...$org.options].forEach(opt => {
        if (String(opt.value) === orgId) {
          $org.value = orgId;
          console.log('‚úÖ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
      });
    }

    // –í–ê–ñ–ù–û: manufacturer –∏ model - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ!
    if (data.device.manufacturer?.id && data.device.model?.id) {
      const manufacturerId = String(data.device.manufacturer.id);
      const modelId = String(data.device.model.id);

      console.log('üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –∏–∑ API:', manufacturerId, data.device.manufacturer.name);
      console.log('üì± –ú–æ–¥–µ–ª—å –∏–∑ API:', modelId, data.device.model.name);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –µ—Å—Ç—å –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      const modelExists = allModels.find(m => String(m.id) === modelId);

      if (modelExists) {
        console.log('‚úÖ –ú–æ–¥–µ–ª—å –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ:', modelExists.name);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è
        $manufacturer.value = manufacturerId;
        console.log('‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', manufacturerId);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
        updateModels(manufacturerId);

        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
        setTimeout(() => {
          $deviceModel.value = modelId;
          selectedModelId = modelId;
          console.log('‚úÖ –ú–æ–¥–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', modelId);

          // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
          if (!$modelText.value.trim()) {
            $modelText.value = modelExists.name;
            console.log('‚úÖ –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:', modelExists.name);
          }
        }, 150);
      } else {
        console.error('‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ allModels. ID:', modelId);
        console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:', allModels.map(m => ({id: m.id, name: m.name})));
      }
    } else {
      console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ –∏–ª–∏ –º–æ–¥–µ–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ API');
      console.log('manufacturer:', data.device.manufacturer);
      console.log('model:', data.device.model);
    }

    // SNMP community
    if ($comm && !$comm.value.trim()) {
      $comm.value = "public";
      console.log('‚úÖ SNMP community —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: public');
    }

    showMessage("‚úì –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞");
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:', err);
  }
}

  $serial?.addEventListener("blur", () => {
    const serial = $serial.value.trim();
    if (serial) {
      lookupBySerial(serial);
    }
  });

  $btnProbe?.addEventListener("click", async (e) => {
    e.preventDefault();

    const ip = ($ip?.value || "").trim();
    if (!ip) {
      showMessage("–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å", true);
      return;
    }

    let comm = ($comm?.value || "").trim() || "public";
    if ($comm && !$comm.value) $comm.value = "public";

    $btnProbe.disabled = true;
    showMessage("–û–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...");

    try {
      const resp = await fetch("{% url 'inventory:api_probe_serial' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ip, community: comm})
      });

      if (!resp.headers.get('content-type')?.includes('application/json')) {
        throw new Error("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");
      }

      const data = await resp.json();
      if (!data.ok) throw new Error(data.error);

      if ($serial) $serial.value = data.serial || $serial.value;

      showMessage("‚úì –°–µ—Ä–∏–π–Ω–∏–∫ –ø–æ–ª—É—á–µ–Ω: " + data.serial);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º –≤ –¥–æ–≥–æ–≤–æ—Ä–µ
      await lookupBySerial(data.serial);
    } catch (err) {
      showMessage(err.message || "–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞", true);
    } finally {
      $btnProbe.disabled = false;
    }
  });

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadData();
})();
</script>
{% endblock %}