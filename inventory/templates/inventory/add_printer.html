{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">Добавить принтер</h1>

<form method="post" novalidate>
  {% csrf_token %}
  {{ form.as_p }}

  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <button type="button" class="btn btn-outline-primary" id="btn-probe">
      Опросить по SNMP
    </button>
    <small class="text-muted">Если SNMP community пустое — возьмём <code>public</code>.</small>
    <span id="probe-msg" class="ms-2 small"></span>
  </div>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="{% url 'inventory:printer_list' %}" class="btn btn-outline-secondary">Отмена</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function getCSRFFromInput(){
    const i = document.querySelector('input[name=csrfmiddlewaretoken]');
    return i ? i.value : '';
  }
  function getCSRF(){
    const m=document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
    return m?decodeURIComponent(m[1]):"";
  }
  const csrf = () => getCSRFFromInput() || getCSRF();

  const $serial = document.getElementById("id_serial_number");
  const $org    = document.getElementById("id_organization");
  const $model  = document.getElementById("id_model");
  const $ip     = document.getElementById("id_ip_address");
  const $comm   = document.getElementById("id_snmp_community");
  const $btn    = document.getElementById("btn-probe");
  const $msg    = document.getElementById("probe-msg");

  function setMsg(text, ok){
    $msg.textContent = text || "";
    $msg.className = "ms-2 small " + (ok ? "text-success" : "text-danger");
  }

  async function lookupBySerial(serial){
    if(!serial) return;
    try{
      const url = "{% url 'contracts:api_lookup_by_serial' %}?serial=" + encodeURIComponent(serial);
      const resp = await fetch(url, {headers:{'X-Requested-With':'fetch'}});
      const ctype = resp.headers.get('content-type') || '';
      if (!ctype.includes('application/json')) throw new Error("Неожиданный ответ (возможно, требуется вход)");
      const data = await resp.json();
      if(!data.ok) throw new Error(data.error || "Ошибка запроса");

      if(!data.found){
        setMsg("В договорах не найдено", false);
        return;
      }

      // Организация — ModelChoiceField
      const orgId = String(data.device.organization?.id || "");
      if (orgId && $org) {
        const opt = [...$org.options].find(o => String(o.value) === orgId);
        if (opt) {
          $org.value = orgId;
          // если стоит select2/chosen — дернём change
          $org.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }

      // Модель — поддержим оба варианта (CharField/ForeignKey)
      if ($model) {
        if (data.device.model?.id) {
          const val = String(data.device.model.id);
          const opt = $model.tagName === 'SELECT' ? [...$model.options].find(o => String(o.value) === val) : null;
          if (opt) { $model.value = val; $model.dispatchEvent(new Event('change', { bubbles: true })); }
          else if ($model.tagName !== 'SELECT' && data.device.model?.name) {
            $model.value = data.device.model.name;
          }
        } else if (data.device.model?.name && $model.tagName !== 'SELECT') {
          $model.value = data.device.model.name;
        }
      }

      if ($comm && !$comm.value.trim()) $comm.value = "public";
      setMsg("Заполнено из договора", true);
    }catch(err){
      setMsg(err.message || "Ошибка", false);
    }
  }

  if ($serial) {
    const handler = () => lookupBySerial($serial.value.trim());
    $serial.addEventListener("change", handler);
    $serial.addEventListener("blur", handler);
  }

  if ($btn) {
    $btn.addEventListener("click", async (e)=>{
      e.preventDefault();
      setMsg("", true);

      const ip = ($ip?.value || "").trim();
      if (!ip) { setMsg("Введите IP", false); return; }

      let comm = ($comm?.value || "").trim();
      if (!comm) { comm = "public"; if ($comm) $comm.value = "public"; }

      $btn.disabled = true;
      try{
        const resp = await fetch("{% url 'inventory:api_probe_serial' %}", {
          method:"POST",
          headers:{ "Content-Type":"application/json", "X-CSRFToken": csrf() },
          body: JSON.stringify({ ip, community: comm })
        });
        const ctype = resp.headers.get('content-type') || '';
        if (!ctype.includes('application/json')) throw new Error("Неожиданный ответ (возможно, требуется вход)");
        const data = await resp.json();
        if(!data.ok) throw new Error(data.error || "Не удалось опросить устройство");

        if ($serial) $serial.value = data.serial || $serial.value;
        setMsg("Серийник получен: " + (data.serial || ""), true);

        await lookupBySerial(data.serial);
      }catch(err){
        setMsg(err.message || "Ошибка опроса", false);
      } finally {
        $btn.disabled = false;
      }
    });
  }
})();
</script>
{% endblock %}
