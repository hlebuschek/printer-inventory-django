{% extends "base.html" %}

{% block head_extra %}
<style>
/* =========================
   TABLE / GRID BASICS
   ========================= */
.table-fixed{ table-layout: fixed; }
.table-fixed th, .table-fixed td{ vertical-align: middle; }
.table-responsive{ overflow-x:auto; overflow-y:visible; }

/* =========================
   –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–ò–ü–ö–ê–Ø –®–ê–ü–ö–ê
   ========================= */

/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª–∏–ø–∫–æ–π —à–∞–ø–∫–∏ */
.table-fixed thead th {
  position: sticky;
  top: 0;
  z-index: 10; /* —É–≤–µ–ª–∏—á–µ–Ω z-index –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞–≤–∞—é—â–∏–º —Å–∫—Ä–æ–ª–ª–æ–º */
  background: #f8f9fa;
  box-shadow: 0 2px 4px rgba(0,0,0,.08); /* —É—Å–∏–ª–µ–Ω–∞ —Ç–µ–Ω—å */
  backdrop-filter: blur(8px); /* —Ä–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
  border-bottom: 2px solid #dee2e6; /* —á–µ—Ç–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip;
  padding-right: 12px;
  transition: box-shadow 0.2s ease, background-color 0.2s ease;
}

/* –ì—Ä—É–ø–ø–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ */
.table-fixed thead .group-row th {
  position: sticky;
  top: 0;
  z-index: 11;
  font-weight: 600;
  text-transform: uppercase;
  font-size: .75rem;
  letter-spacing: .02em;
  background: linear-gradient(135deg, #eef2f7 0%, #e3f2fd 100%);
  color: #4b5563;
  border-bottom: 1px solid #d1d5db;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}

/* –°—Ç—Ä–æ–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ */
.table-fixed thead tr:last-child th {
  position: sticky;
  top: 41px; /* –≤—ã—Å–æ—Ç–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ + –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ */
  z-index: 10;
  background: rgba(248, 249, 250, 0.98);
  backdrop-filter: blur(8px);
  border-bottom: 2px solid #0d6efd;
  font-weight: 500;
}

/* –£—Å–∏–ª–µ–Ω–Ω–∞—è —Ç–µ–Ω—å –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ª–∏–ø–∫–æ–π —à–∞–ø–∫–µ */
.sticky-active .table-fixed thead th {
  box-shadow: 0 4px 8px rgba(0,0,0,.12);
  background: rgba(248, 249, 250, 0.98);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–π —à–∞–ø–∫–∏ */
.sticky-header-indicator {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #0d6efd 0%, #198754 50%, #fd7e14 100%);
  z-index: 1001; /* –≤—ã—à–µ –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sticky-header-indicator.show {
  opacity: 1;
}

/* =========================
   RESIZE HANDLES
   ========================= */
.col-resize-handle{
  position:absolute; top:0; right:-3px; width:6px; height:100%;
  cursor: col-resize; user-select:none; z-index: 12; /* –≤—ã—à–µ –≤—Å–µ—Ö sticky —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
}
.col-resize-handle::after{ content:""; position:absolute; top:0; bottom:0; right:2px; border-right:1px dashed rgba(0,0,0,.2); }
.col-resize-handle.active::after{
  border-right-color: #0d6efd;
  box-shadow: 1px 0 0 rgba(13, 110, 253, 0.3);
}

/* Dropdown –∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –ª–∏–ø–∫–æ–π —à–∞–ø–∫–µ */
.column-filter .dropdown-toggle{
  position: relative;
  z-index: 12;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.column-filter .dropdown-toggle:hover {
  background: rgba(255, 255, 255, 1);
  border-color: rgba(13, 110, 253, 0.5);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.table-fixed thead .dropdown-menu{
  z-index: 1060; /* –≤—ã—à–µ sticky —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* –ö–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –ª–∏–ø–∫–æ–π —à–∞–ø–∫–µ */
.table-fixed thead th .btn-link {
  color: #6c757d;
  transition: all 0.2s ease;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 3px;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.table-fixed thead th .btn-link:hover {
  color: #0d6efd;
  background: rgba(13, 110, 253, 0.1);
  transform: scale(1.1);
}

/* =========================
   CELL CONTENT
   ========================= */
/* –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è */
.table-fixed tbody td{ white-space: normal; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
.table-fixed td.col-serial, .table-fixed td.col-inv{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* –¥—É–±–ª–∏–∫–∞—Ç—ã SN */
td.dup-serial{ background:#d1e7dd !important; }

/* –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ */
.counter-input{
  font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  transition: border-color 0.2s ease;
}
.counter-input.form-control-sm{
  padding-right: 2rem;  /* –º–µ—Å—Ç–æ –ø–æ–¥ —Å—Ç–∞—Ç—É—Å-–∏–∫–æ–Ω–∫—É */
  background-color: #fff;
  border-color: rgba(0,0,0,.1);
}
.cell-editable{ position: relative; }
.cell-editable:hover .form-control{ border-color: rgba(13,110,253,.35); }

/* —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É number */
.counter-input[type="number"]::-webkit-inner-spin-button,
.counter-input[type="number"]::-webkit-outer-spin-button{ -webkit-appearance: none; margin: 0; }
.counter-input[type="number"]{ -moz-appearance: textfield; }

/* –Ω–µ–∂–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–∏ */
.cell-editable .form-control:focus{ box-shadow: 0 0 0 .15rem rgba(13,110,253,.12); }

.counter-input[disabled]{ background:#f6f6f6; }

/* =========================
   SAVE STATES & ANIMATIONS
   ========================= */
.cell-editable.saving {
  background: linear-gradient(90deg, #fff3cd 0%, #fff3cd 50%, #ffffff 51%, #ffffff 100%);
  background-size: 200% 100%;
  animation: saving-pulse 1s ease-in-out infinite;
}
.cell-editable.saving::after{
  content:"üíæ"; position:absolute; right:.35rem; top:50%; transform:translateY(-50%);
  font-size: 14px; opacity:.8; animation: rotate 1s linear infinite;
}

.cell-editable.saved {
  background: linear-gradient(90deg, #d1e7dd 0%, #ffffff 100%);
  animation: saved-flash 0.6s ease-out;
}
.cell-editable.saved::after{
  content:"‚úÖ"; position:absolute; right:.35rem; top:50%; transform:translateY(-50%);
  font-size: 14px; animation: bounce 0.6s ease-out;
}

.cell-editable.error {
  background: linear-gradient(90deg, #f8d7da 0%, #ffffff 100%);
  animation: error-shake 0.6s ease-out;
}
.cell-editable.error::after{
  content:"‚ùå"; position:absolute; right:.35rem; top:50%; transform:translateY(-50%);
  font-size: 14px; animation: shake 0.6s ease-out;
}

/* –∞–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes saving-pulse {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
@keyframes rotate {
  from { transform: translateY(-50%) rotate(0deg); }
  to { transform: translateY(-50%) rotate(360deg); }
}
@keyframes saved-flash {
  0% { background: #d1e7dd; transform: scale(1); }
  50% { background: #a3d9a4; transform: scale(1.02); }
  100% { background: #ffffff; transform: scale(1); }
}
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(-50%) scale(1); }
  40% { transform: translateY(-50%) scale(1.2); }
  60% { transform: translateY(-50%) scale(1.1); }
}
@keyframes error-shake {
  0%, 100% { background: #ffffff; transform: translateX(0); }
  25% { background: #f8d7da; transform: translateX(-2px); }
  75% { background: #f8d7da; transform: translateX(2px); }
}
@keyframes shake {
  0%, 100% { transform: translateY(-50%) translateX(0); }
  25% { transform: translateY(-50%) translateX(-2px); }
  75% { transform: translateY(-50%) translateX(2px); }
}

/* ¬´–±–µ–π–¥–∂-–¥–µ–ª—å—Ç–∞¬ª —Ä—è–¥–æ–º —Å total –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ */
.total-cell.updated{
  animation: total-updated 1.5s ease-out;
  font-weight: bold;
}
@keyframes total-updated{
  0% { background:#fff3cd; color: #856404; transform: scale(1); }
  50% { background:#ffc107; color: #212529; transform: scale(1.05); }
  100% { background:transparent; color: inherit; transform: scale(1); }
}

/* =========================
   MANUAL EDIT INDICATORS
   ========================= */
/* —Ñ–æ–Ω+–ø–æ–ª–æ—Å–∞ –¥–ª—è —è—á–µ–µ–∫, —É—à–µ–¥—à–∏—Ö –≤ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
.manual-edited {
  position: relative;
  background-color: #fff3cd !important;  /* –ª—ë–≥–∫–∞—è –∂—ë–ª—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
  border-left: 3px solid #ffc107 !important; /* –∂—ë–ª—Ç–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
}

/* —Å—Ç–∏–ª—å –∏–Ω–ø—É—Ç–∞ –≤ —Ä—É—á–Ω—ã—Ö –ø–æ–ª—è—Ö */
.manual-field {
  background-color: #fff3cd !important;
  border-color: #ffc107 !important;
}
.manual-field:focus {
  border-color: #ff8c00 !important;
  box-shadow: 0 0 0 0.15rem rgba(255, 193, 7, 0.25) !important;
}

/* –∏–∫–æ–Ω–∫–∞ "—Ä—É—á–Ω–æ–≥–æ" —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
.manual-indicator {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 12px;
  z-index: 10;
  color: #856404;
  cursor: help;
}

/* –ø–ª–∞–≤–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è "—Å—Ç–∞–ª–æ —Ä—É—á–Ω—ã–º" */
.cell-editable.became-manual {
  animation: becameManual 2s ease-out;
}

@keyframes becameManual {
  0% {
    background-color: #d1ecf1;
    border-left-color: #0dcaf0;
    transform: scale(1);
  }
  30% {
    background-color: #ffeaa7;
    border-left-color: #fdcb6e;
    transform: scale(1.02);
  }
  100% {
    background-color: #fff3cd;
    border-left-color: #ffc107;
    transform: scale(1);
  }
}

/* –±–µ–π–¥–∂ IP¬∑AUTO, –µ—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –µ—Å—Ç—å —Ä—É—á–Ω—ã–µ –ø–æ–ª—è */
.serial-info.with-manual-fields {
  background: linear-gradient(45deg, #e3f2fd, #fff3cd) !important;
  border: 1px solid #ffc107 !important;
}

.auto-conflict-hint {
  position: absolute;
  bottom: -18px;
  left: 2px;
  font-size: 10px;
  color: #dc3545;
  background: rgba(255, 255, 255, 0.95);
  padding: 1px 4px;
  border-radius: 3px;
  font-weight: 600;
  border: 1px solid #dc3545;
}

/* =========================
   –ü–õ–ê–í–ê–Æ–©–ò–ô –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ô –°–ö–†–û–õ–õ
   ========================= */
.floating-scrollbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 17px;
  background: rgba(248, 249, 250, 0.95);
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  z-index: 1000;
  display: none; /* —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  backdrop-filter: blur(3px);
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
}

.floating-scrollbar-inner {
  height: 100%;
  overflow-x: auto;
  overflow-y: hidden;
}

.floating-scrollbar-content {
  height: 1px;
  /* —à–∏—Ä–∏–Ω–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ JavaScript */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∫—Ä–æ–ª–ª–∞ */
.scroll-progress {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, #0d6efd, #198754);
  z-index: 1002; /* –≤—ã—à–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ª–∏–ø–∫–æ–π —à–∞–ø–∫–∏ */
  transform-origin: left;
  transform: scaleX(0);
  transition: transform 0.1s ease;
}

/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞–≤–∞—é—â–∏–π —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ */
.floating-scrollbar.show {
  display: block;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.floating-scrollbar-inner::-webkit-scrollbar {
  height: 14px;
}

.floating-scrollbar-inner::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
}

.floating-scrollbar-inner::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 7px;
  border: 2px solid rgba(248, 249, 250, 0.95);
}

.floating-scrollbar-inner::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.5);
}

/* =========================
   –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
   ========================= */
/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –ª–∏–ø–∫–æ–π —à–∞–ø–∫–∏ –ø—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
@media (max-width: 1200px) {
  .table-fixed thead th {
    font-size: 0.875rem;
    padding: 0.5rem 0.25rem;
  }

  .table-fixed thead .group-row th {
    font-size: 0.7rem;
    padding: 0.25rem;
  }

  .table-fixed thead tr:last-child th {
    top: 35px; /* —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ */
  }
}
</style>
{% endblock %}


{% block content %}
<h1 class="h4 mb-3 d-flex align-items-center gap-2">
  –û—Ç—á—ë—Ç –∑–∞ {{ month_date|date:"F Y" }}
  {% if report_is_editable %}
    <span class="badge text-bg-success">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –¥–æ {{ report_edit_until|date:"d.m.Y H:i" }}</span>
  {% else %}
    <span class="badge text-bg-secondary">–¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ</span>
  {% endif %}
</h1>

{% if report_is_editable %}
  <div class="alert alert-info py-2 small d-flex align-items-center gap-3">
    <div><strong>–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:</strong>
      {% if can_edit_start %}<span class="badge text-bg-primary">–Ω–∞—á–∞–ª–æ A4/A3</span>{% endif %}
      {% if can_edit_end %}<span class="badge text-bg-primary">–∫–æ–Ω–µ—Ü A4/A3</span>{% endif %}
      {% if not can_edit_start and not can_edit_end %}<em>–Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤</em>{% endif %}
    </div>
    <div class="ms-auto text-muted">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –ø–æ Enter/–≤—ã—Ö–æ–¥—É –∏–∑ –ø–æ–ª—è</div>
  </div>
{% endif %}

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ —Å CSRF —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –≤—Å–µ—Ö AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ -->
<form id="csrf-form" style="display: none;">
  {% csrf_token %}
</form>

<div class="d-flex gap-2 align-items-center mb-3">
  <form class="row g-2 flex-grow-1" method="get">
    <div class="col">
      <input name="q" value="{{ filters.q }}" class="form-control" placeholder="–ü–æ–∏—Å–∫ (–æ—Ä–≥, –≥–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å, –º–æ–¥–µ–ª—å, SN, –∏–Ω–≤)">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
    {% if perms.monthly_report.upload_monthly_report %}
    <div class="col-auto">
      <a class="btn btn-outline-success" href="{% url 'upload_excel' %}">–ó–∞–≥—Ä—É–∑–∫–∞ Excel</a>
    </div>
    {% endif %}
    <div class="col-auto">
      <a class="btn btn-outline-secondary" href="{% url 'month_list' %}">–ö —Å–ø–∏—Å–∫—É –º–µ—Å—è—Ü–µ–≤</a>
    </div>
  </form>

  {% if report_is_editable and perms.monthly_report.sync_from_inventory %}
  <form id="sync-inv-form" method="post"
        action="{% url 'api_sync_from_inventory' year=month_date.year month=month_date.month %}">
    {% csrf_token %}
    <button type="button" class="btn btn-outline-primary" id="btn-sync-inv">
      –ü–æ–¥—Ç—è–Ω—É—Ç—å –∏–∑ Inventory
    </button>
    <small class="text-muted ms-2" id="sync-inv-status"></small>
  </form>
  {% endif %}

  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–æ–ª–±—Ü–æ–≤ -->
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
      –ö–æ–ª–æ–Ω–∫–∏
    </button>
    <div class="dropdown-menu dropdown-menu-end p-2 columns-menu" style="min-width: 280px;">
      <!-- –±–∞–∑–æ–≤—ã–µ -->
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-org"    data-col-key="org"    type="checkbox" checked><span class="form-check-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-branch" data-col-key="branch" type="checkbox" checked><span class="form-check-label">–§–∏–ª–∏–∞–ª</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-city"   data-col-key="city"   type="checkbox" checked><span class="form-check-label">–ì–æ—Ä–æ–¥</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-address" data-col-key="address" type="checkbox" checked><span class="form-check-label">–ê–¥—Ä–µ—Å</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-model"  data-col-key="model"  type="checkbox" checked><span class="form-check-label">–ú–æ–¥–µ–ª—å</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-serial" data-col-key="serial" type="checkbox" checked><span class="form-check-label">–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-inv"    data-col-key="inv"    type="checkbox" checked><span class="form-check-label">–ò–Ω–≤ ‚Ññ</span></label>

      <div class="dropdown-divider"></div>

      <!-- A4/A3 -->
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a4bw_s" data-col-key="a4bw_s" type="checkbox" checked><span class="form-check-label">A4 —á/–± –Ω–∞—á–∞–ª–æ</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a4bw_e" data-col-key="a4bw_e" type="checkbox" checked><span class="form-check-label">A4 —á/–± –∫–æ–Ω–µ—Ü</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a4c_s"  data-col-key="a4c_s"  type="checkbox" checked><span class="form-check-label">A4 —Ü–≤–µ—Ç –Ω–∞—á–∞–ª–æ</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a4c_e"  data-col-key="a4c_e"  type="checkbox" checked><span class="form-check-label">A4 —Ü–≤–µ—Ç –∫–æ–Ω–µ—Ü</span></label>

      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a3bw_s" data-col-key="a3bw_s" type="checkbox" checked><span class="form-check-label">A3 —á/–± –Ω–∞—á–∞–ª–æ</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a3bw_e" data-col-key="a3bw_e" type="checkbox" checked><span class="form-check-label">A3 —á/–± –∫–æ–Ω–µ—Ü</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a3c_s"  data-col-key="a3c_s"  type="checkbox" checked><span class="form-check-label">A3 —Ü–≤–µ—Ç –Ω–∞—á–∞–ª–æ</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-a3c_e"  data-col-key="a3c_e"  type="checkbox" checked><span class="form-check-label">A3 —Ü–≤–µ—Ç –∫–æ–Ω–µ—Ü</span></label>

      <div class="dropdown-divider"></div>

      <!-- –º–µ—Ç—Ä–∏–∫–∏ -->
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-total" data-col-key="total" type="checkbox" checked><span class="form-check-label">–ò—Ç–æ–≥–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-A"     data-col-key="A"     type="checkbox"><span class="form-check-label">A (–Ω–æ—Ä–º.)</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-D"     data-col-key="D"     type="checkbox"><span class="form-check-label">D (–Ω–µ–¥–æ—Å—Ç.)</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-K1"    data-col-key="K1"    type="checkbox"><span class="form-check-label">K1 (%)</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-L"     data-col-key="L"     type="checkbox"><span class="form-check-label">L (–Ω–µ –ø—Ä–æ—Å—Ä.)</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-W"     data-col-key="W"     type="checkbox"><span class="form-check-label">W (–æ–±—â–µ–µ)</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-K2"    data-col-key="K2"    type="checkbox"><span class="form-check-label">K2 (%)</span></label>

      <div class="dropdown-divider"></div>
      <button class="btn btn-sm btn-outline-secondary w-100" id="cols-reset">–°–±—Ä–æ—Å</button>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped table-hover table-bordered align-middle table-fixed table-resizable">
    <colgroup>
      <col style="width: 70px;">
      <col class="cg-org" style="width: 220px;">
      <col class="cg-branch" style="width: 160px;">
      <col class="cg-city" style="width: 160px;">
      <col class="cg-address" style="width: 280px;">
      <col class="cg-model" style="width: 240px;">
      <col class="cg-serial" style="width: 250px;">
      <col class="cg-inv" style="width: 140px;">
      <col class="cg-a4bw_s" style="width: 120px;">
      <col class="cg-a4bw_e" style="width: 120px;">
      <col class="cg-a4c_s"  style="width: 120px;">
      <col class="cg-a4c_e"  style="width: 120px;">
      <col class="cg-a3bw_s" style="width: 120px;">
      <col class="cg-a3bw_e" style="width: 120px;">
      <col class="cg-a3c_s"  style="width: 120px;">
      <col class="cg-a3c_e"  style="width: 120px;">
      <col class="cg-total"  style="width: 150px;">
      <col class="cg-A"      style="width: 120px;">
      <col class="cg-D"      style="width: 120px;">
      <col class="cg-K1"     style="width: 120px;">
      <col class="cg-L"      style="width: 120px;">
      <col class="cg-W"      style="width: 120px;">
      <col class="cg-K2"     style="width: 120px;">
    </colgroup>

    <thead class="table-light">
  <!-- –ì–†–£–ü–ü–û–í–´–ï –ó–ê–ì–û–õ–û–í–ö–ò -->
  <tr class="group-row">
    <!-- –¥–æ A4 ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫: ‚Ññ, –æ—Ä–≥, —Ñ–∏–ª–∏–∞–ª, –≥–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å, –º–æ–¥–µ–ª—å, SN, –∏–Ω–≤ -->
    <th colspan="8"></th>
    <th colspan="4" class="text-center">–°—á—ë—Ç—á–∏–∫–∏ A4</th>
    <th colspan="4" class="text-center">–°—á—ë—Ç—á–∏–∫–∏ A3</th>
    <th colspan="7" class="text-center">–ú–µ—Ç—Ä–∏–∫–∏</th>
  </tr>

  <!-- –¢–í–û–Ø —Å—Ç—Ä–æ–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ -->
  <tr>
    {% include "partials/column_filter.html" with key="num" label="‚Ññ –ø/–ø" value=filters.num options=choices.num base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="org"    label="–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è" value=filters.org options=choices.org base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="branch" label="–§–∏–ª–∏–∞–ª"      value=filters.branch options=choices.branch base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="city"   label="–ì–æ—Ä–æ–¥"       value=filters.city options=choices.city base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="address" label="–ê–¥—Ä–µ—Å"     value=filters.address options=choices.address base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="model"  label="–ú–æ–¥–µ–ª—å"      value=filters.model options=choices.model base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="serial" label="–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ"  value=filters.serial options=choices.serial base_qs=base_qs %}
    {% include "partials/column_filter.html" with key="inv"    label="–ò–Ω–≤ ‚Ññ"       value=filters.inv options=choices.inv base_qs=base_qs %}

    <th class="th-a4bw_s">A4 —á/–± –Ω–∞—á–∞–ª–æ</th>
    <th class="th-a4bw_e">A4 —á/–± –∫–æ–Ω–µ—Ü</th>
    <th class="th-a4c_s">A4 —Ü–≤–µ—Ç –Ω–∞—á–∞–ª–æ</th>
    <th class="th-a4c_e">A4 —Ü–≤–µ—Ç –∫–æ–Ω–µ—Ü</th>

    <th class="th-a3bw_s">A3 —á/–± –Ω–∞—á–∞–ª–æ</th>
    <th class="th-a3bw_e">A3 —á/–± –∫–æ–Ω–µ—Ü</th>
    <th class="th-a3c_s">A3 —Ü–≤–µ—Ç –Ω–∞—á–∞–ª–æ</th>
    <th class="th-a3c_e">A3 —Ü–≤–µ—Ç –∫–æ–Ω–µ—Ü</th>

    <th class="th-total">
      <div class="d-flex align-items-center gap-1">
        –ò—Ç–æ–≥–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=total">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-total">‚Üì</a>
      </div>
    </th>
    <th class="th-A">
      <div class="d-flex align-items-center gap-1">
        A (–Ω–æ—Ä–º–∞—Ç–∏–≤)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=A">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-A">‚Üì</a>
      </div>
    </th>
    <th class="th-D">
      <div class="d-flex align-items-center gap-1">
        D (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=D">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-D">‚Üì</a>
      </div>
    </th>
    <th class="th-K1">
      <div class="d-flex align-items-center gap-1">
        K1 (%)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=k1">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-k1">‚Üì</a>
      </div>
    </th>
    <th class="th-L">
      <div class="d-flex align-items-center gap-1">
        L (–Ω–µ –ø—Ä–æ—Å—Ä.)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=L">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-L">‚Üì</a>
      </div>
    </th>
    <th class="th-W">
      <div class="d-flex align-items-center gap-1">
        W (–æ–±—â–µ–µ)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=W">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-W">‚Üì</a>
      </div>
    </th>
    <th class="th-K2">
      <div class="d-flex align-items-center gap-1">
        K2 (%)
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=K2">‚Üë</a>
        <a class="btn btn-link btn-sm p-0 text-muted" href="?{% if base_qs %}{{ base_qs }}&{% endif %}sort=-K2">‚Üì</a>
      </div>
    </th>
  </tr>
</thead>


    <tbody>
      {% for r in reports %}
      <tr data-pk="{{ r.id }}" data-update-url="{% url 'api_update_counters' pk=r.id %}">
        <td class="text-end">{{ r.order_number }}</td>
        <td class="col-org">{{ r.organization }}</td>
        <td class="col-branch">{{ r.branch }}</td>
        <td class="col-city">{{ r.city }}</td>
        <td class="col-address">{{ r.address }}</td>
        <td class="col-model">{{ r.equipment_model }}</td>
        <td class="col-serial {% if r.ui_is_dup %}dup-serial{% endif %}">
          <div class="d-flex align-items-center gap-2">
            <span class="text-nowrap">{{ r.serial_number }}</span>

            {% if perms.monthly_report.view_change_history %}
              <a href="{% url 'change_history' pk=r.id %}"
                 class="btn btn-outline-secondary btn-sm"
                 title="–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">
                üìù
              </a>
            {% endif %}

            {% if r.a4_bw_end_auto or r.a4_color_end_auto or r.a3_bw_end_auto or r.a3_color_end_auto %}
              {% comment %}
                –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤—Ä—É—á–Ω—É—é –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ with-manual-fields
              {% endcomment %}
              {% if r.a4_bw_end_manual or r.a4_color_end_manual or r.a3_bw_end_manual or r.a3_color_end_manual %}
                <span class="badge rounded-pill serial-info with-manual-fields
                             {% if r.ui_poll_stale %}text-bg-warning{% else %}bg-light border text-muted{% endif %}"
                      role="button"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      data-bs-html="true"
                      data-bs-container="body"
                      data-ip="{{ r.device_ip|default_if_none:'' }}"
                      data-lastok="{% if r.inventory_last_ok %}{{ r.inventory_last_ok|date:'Y-m-d H:i' }}{% endif %}"
                      title="IP: {{ r.device_ip|default:'‚Äî' }}<br>
                             –û–ø—Ä–æ—Å: {% if r.inventory_last_ok %}{{ r.inventory_last_ok|date:'d.m.Y H:i' }}{% else %}‚Äî{% endif %}<br>
                             –ê–≤—Ç–æ—Å–∏–Ω–∫: {{ r.inventory_autosync_at|date:'d.m.Y H:i' }}<br>
                             <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –µ—Å—Ç—å –ø–æ–ª—è —Å —Ä—É—á–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º">
                  IP¬∑AUTO¬∑–†–£–ß–ù
                </span>
              {% else %}
                <span class="badge rounded-pill serial-info
                             {% if r.ui_poll_stale %}text-bg-warning{% else %}bg-light border text-muted{% endif %}"
                      role="button"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      data-bs-html="true"
                      data-bs-container="body"
                      data-ip="{{ r.device_ip|default_if_none:'' }}"
                      data-lastok="{% if r.inventory_last_ok %}{{ r.inventory_last_ok|date:'Y-m-d H:i' }}{% endif %}"
                      title="IP: {{ r.device_ip|default:'‚Äî' }}<br>
                             –û–ø—Ä–æ—Å: {% if r.inventory_last_ok %}{{ r.inventory_last_ok|date:'d.m.Y H:i' }}{% else %}‚Äî{% endif %}<br>
                             –ê–≤—Ç–æ—Å–∏–Ω–∫: {{ r.inventory_autosync_at|date:'d.m.Y H:i' }}">
                  IP¬∑AUTO
                </span>
              {% endif %}
            {% endif %}
          </div>
        </td>

        <td class="col-inv">{{ r.inventory_number }}</td>

        {# --- A4 START --- #}
        <td class="text-end col-a4bw_s">
          <div class="cell-editable">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input"
                   value="{{ r.a4_bw_start|default_if_none:'' }}"
                   data-field="a4_bw_start"
                   {% if not r.ui_allow_a4_bw_start %}disabled{% endif %}>
          </div>
        </td>

        <td class="text-end col-a4bw_e">
          <div class="cell-editable {% if r.a4_bw_end_manual %}manual-edited{% endif %}">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input {% if r.a4_bw_end_manual %}manual-field{% endif %}"
                   value="{{ r.a4_bw_end|default_if_none:'' }}"
                   data-field="a4_bw_end"
                   {% if not r.ui_allow_a4_bw_end %}disabled{% endif %}
                   title="{% if r.a4_bw_end_manual %}–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é. –ê–≤—Ç–æ: {{ r.a4_bw_end_auto|default:'-' }}{% endif %}">

            {% if r.a4_bw_end_manual %}
              <span class="manual-indicator"
                    title="–†—É—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{ r.a4_bw_end|default:'-' }}&#10;–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: {{ r.a4_bw_end_auto|default:'-' }}&#10;–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: {{ r.ui_conflicts.a4_bw_end|default:'0' }}">‚úã</span>
            {% endif %}

            {% if r.a4_bw_end_auto and r.a4_bw_end_manual and r.a4_bw_end_auto != r.a4_bw_end %}
              <small class="auto-conflict-hint"
                     title="–†—É—á–Ω–æ–µ: {{ r.a4_bw_end|default:'-' }}, –ê–≤—Ç–æ: {{ r.a4_bw_end_auto|default:'-' }}">
                Œî{% if r.ui_conflicts.a4_bw_end > 0 %}+{% endif %}{{ r.ui_conflicts.a4_bw_end|default:'0' }}
              </small>
            {% endif %}
          </div>
        </td>

        <td class="text-end col-a4c_s">
          <div class="cell-editable">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input"
                   value="{{ r.a4_color_start|default_if_none:'' }}"
                   data-field="a4_color_start"
                   {% if not r.ui_allow_a4_color_start %}disabled{% endif %}>
          </div>
        </td>

        <td class="text-end col-a4c_e">
          <div class="cell-editable {% if r.a4_color_end_manual %}manual-edited{% endif %}">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input {% if r.a4_color_end_manual %}manual-field{% endif %}"
                   value="{{ r.a4_color_end|default_if_none:'' }}"
                   data-field="a4_color_end"
                   {% if not r.ui_allow_a4_color_end %}disabled{% endif %}
                   title="{% if r.a4_color_end_manual %}–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é. –ê–≤—Ç–æ: {{ r.a4_color_end_auto|default:'-' }}{% endif %}">

            {% if r.a4_color_end_manual %}
              <span class="manual-indicator"
                    title="–†—É—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{ r.a4_color_end|default:'-' }}&#10;–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: {{ r.a4_color_end_auto|default:'-' }}&#10;–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: {{ r.ui_conflicts.a4_color_end|default:'0' }}">‚úã</span>
            {% endif %}

            {% if r.a4_color_end_auto and r.a4_color_end_manual and r.a4_color_end_auto != r.a4_color_end %}
              <small class="auto-conflict-hint"
                     title="–†—É—á–Ω–æ–µ: {{ r.a4_color_end|default:'-' }}, –ê–≤—Ç–æ: {{ r.a4_color_end_auto|default:'-' }}">
                Œî{% if r.ui_conflicts.a4_color_end > 0 %}+{% endif %}{{ r.ui_conflicts.a4_color_end|default:'0' }}
              </small>
            {% endif %}
          </div>
        </td>

        {# --- A3 --- #}
        <td class="text-end col-a3bw_s">
          <div class="cell-editable">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input"
                   value="{{ r.a3_bw_start|default_if_none:'' }}"
                   data-field="a3_bw_start"
                   {% if not r.ui_allow_a3_bw_start %}disabled{% endif %}>
          </div>
        </td>

        <td class="text-end col-a3bw_e">
          <div class="cell-editable {% if r.a3_bw_end_manual %}manual-edited{% endif %}">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input {% if r.a3_bw_end_manual %}manual-field{% endif %}"
                   value="{{ r.a3_bw_end|default_if_none:'' }}"
                   data-field="a3_bw_end"
                   {% if not r.ui_allow_a3_bw_end %}disabled{% endif %}
                   title="{% if r.a3_bw_end_manual %}–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é. –ê–≤—Ç–æ: {{ r.a3_bw_end_auto|default:'-' }}{% endif %}">

            {% if r.a3_bw_end_manual %}
              <span class="manual-indicator"
                    title="–†—É—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{ r.a3_bw_end|default:'-' }}&#10;–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: {{ r.a3_bw_end_auto|default:'-' }}&#10;–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: {{ r.ui_conflicts.a3_bw_end|default:'0' }}">‚úã</span>
            {% endif %}

            {% if r.a3_bw_end_auto and r.a3_bw_end_manual and r.a3_bw_end_auto != r.a3_bw_end %}
              <small class="auto-conflict-hint"
                     title="–†—É—á–Ω–æ–µ: {{ r.a3_bw_end|default:'-' }}, –ê–≤—Ç–æ: {{ r.a3_bw_end_auto|default:'-' }}">
                Œî{% if r.ui_conflicts.a3_bw_end > 0 %}+{% endif %}{{ r.ui_conflicts.a3_bw_end|default:'0' }}
              </small>
            {% endif %}
          </div>
        </td>

        <td class="text-end col-a3c_s">
          <div class="cell-editable">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input"
                   value="{{ r.a3_color_start|default_if_none:'' }}"
                   data-field="a3_color_start"
                   {% if not r.ui_allow_a3_color_start %}disabled{% endif %}>
          </div>
        </td>

        <td class="text-end col-a3c_e">
          <div class="cell-editable {% if r.a3_color_end_manual %}manual-edited{% endif %}">
            <input type="number" inputmode="numeric" min="0"
                   class="form-control form-control-sm text-end counter-input {% if r.a3_color_end_manual %}manual-field{% endif %}"
                   value="{{ r.a3_color_end|default_if_none:'' }}"
                   data-field="a3_color_end"
                   {% if not r.ui_allow_a3_color_end %}disabled{% endif %}
                   title="{% if r.a3_color_end_manual %}–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é. –ê–≤—Ç–æ: {{ r.a3_color_end_auto|default:'-' }}{% endif %}">

            {% if r.a3_color_end_manual %}
              <span class="manual-indicator"
                    title="–†—É—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{ r.a3_color_end|default:'-' }}&#10;–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ: {{ r.a3_color_end_auto|default:'-' }}&#10;–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: {{ r.ui_conflicts.a3_color_end|default:'0' }}">‚úã</span>
            {% endif %}

            {% if r.a3_color_end_auto and r.a3_color_end_manual and r.a3_color_end_auto != r.a3_color_end %}
              <small class="auto-conflict-hint"
                     title="–†—É—á–Ω–æ–µ: {{ r.a3_color_end|default:'-' }}, –ê–≤—Ç–æ: {{ r.a3_color_end_auto|default:'-' }}">
                Œî{% if r.ui_conflicts.a3_color_end > 0 %}+{% endif %}{{ r.ui_conflicts.a3_color_end|default:'0' }}
              </small>
            {% endif %}
          </div>
        </td>

        <td class="text-end col-total total-cell">{{ r.total_prints }}</td>
        <td class="text-end col-A">{% if r.normative_availability %}{{ r.normative_availability|floatformat:1 }}{% endif %}</td>
        <td class="text-end col-D">{% if r.actual_downtime %}{{ r.actual_downtime|floatformat:1 }}{% endif %}</td>
        <td class="text-end col-K1">{% if r.k1 %}{{ r.k1|floatformat:1 }}{% endif %}</td>
        <td class="text-end col-L">{{ r.non_overdue_requests }}</td>
        <td class="text-end col-W">{{ r.total_requests }}</td>
        <td class="text-end col-K2">{% if r.k2 %}{{ r.k2|floatformat:1 }}{% endif %}</td>
      </tr>
      {% empty %}
      <tr><td colspan="23" class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="serialInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>

{% if is_paginated %}
  {% include "partials/pagination.html" %}
{% endif %}
    <div class="floating-scrollbar" id="floatingScrollbar">
  <div class="floating-scrollbar-inner" id="floatingScrollbarInner">
    <div class="floating-scrollbar-content" id="floatingScrollbarContent"></div>
  </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∫—Ä–æ–ª–ª–∞ -->
<div class="scroll-progress" id="scrollProgress"></div>
{% endblock %}

{% block scripts %}
<script>
// ===== Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Bootstrap 5) =====
function showToast(type, title, message, duration = 3000) {
  const toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) return;

  const toastId = 'toast-' + Date.now();
  const iconMap = {
    success: 'bi-check-circle-fill text-success',
    error: 'bi-exclamation-triangle-fill text-danger',
    warning: 'bi-exclamation-triangle-fill text-warning',
    info: 'bi-info-circle-fill text-info'
  };

  const html = `
    <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="bi ${iconMap[type] || iconMap.info} me-2"></i>
        <strong class="me-auto">${title}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="toast-body">${message}</div>
    </div>
  `;
  toastContainer.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(toastId);
  const t = new bootstrap.Toast(el, { delay: duration });
  el.addEventListener('hidden.bs.toast', () => el.remove());
  t.show();
}
</script>

<script>
/* ===== –¢—É–ª—Ç–∏–ø—ã + –º–æ–¥–∞–ª–∫–∞ IP¬∑AUTO ===== */
(function(){
  // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Ç—É–ª—Ç–∏–ø–æ–≤
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
    try { new bootstrap.Tooltip(el); } catch(e) {}
  });

  // –º–æ–¥–∞–ª–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –±–µ–π–¥–∂ "IP"
  const modalEl = document.getElementById('serialInfoModal');
  const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

  document.querySelectorAll('.serial-info').forEach(el=>{
    el.addEventListener('click', ()=>{
      if (!modal) return;
      const tr = el.closest('tr');
      const serial = tr?.querySelector('.col-serial span')?.textContent?.trim() || '';
      const ip = el.dataset.ip || '‚Äî';
      const last = el.dataset.lastok || '‚Äî';
      modalEl.querySelector('.modal-body').innerHTML = `
      <div class="small">
        <div><strong>–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ:</strong> ${serial || '‚Äî'}</div>
        <div><strong>IP:</strong> ${ip !== '‚Äî' ? `<a href="http://${ip}" target="_blank" rel="noopener noreferrer">${ip}</a>` : '‚Äî'}</div>
        <div><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –æ–ø—Ä–æ—Å:</strong> ${last}</div>
      </div>`;
      modal.show();
    });
  });
})();
</script>

<script>
/* ===== –ö–æ–ª–æ–Ω–∫–∏ (–ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç—å) ===== */
(function() {
  const KEY = "monthly:visibleCols:v2:{{ month_str }}";
  const DEFAULTS = new Set([
    "org","branch","city","address","model","serial","inv",
    "a4bw_s","a4bw_e","a4c_s","a4c_e","a3bw_s","a3bw_e","a3c_s","a3c_e",
    "total"
  ]);
  const ALL = ["org","branch","city","address","model","serial","inv",
               "a4bw_s","a4bw_e","a4c_s","a4c_e","a3bw_s","a3bw_e","a3c_s","a3c_e",
               "total","A","D","K1","L","W","K2"];

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return new Set(DEFAULTS);
      const a = JSON.parse(raw);
      return Array.isArray(a)&&a.length? new Set(a): new Set(DEFAULTS);
    } catch {
      return new Set(DEFAULTS);
    }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify([...s])); }
  function apply(s){
    for(const k of ALL){
      const show = s.has(k);
      document.querySelectorAll(".th-"+k).forEach(el=>el.classList.toggle("d-none", !show));
      document.querySelectorAll(".col-"+k+", .cg-"+k).forEach(el=>el.classList.toggle("d-none", !show));
      const cb = document.getElementById("col-"+k); if (cb) cb.checked = show;
    }
  }

  const state = loadState();
  apply(state);
  document.querySelector(".columns-menu")?.addEventListener("click", (e)=> e.stopPropagation());
  document.querySelectorAll(".column-toggle").forEach(cb=>{
    cb.addEventListener("change",(e)=>{
      const k = e.target.dataset.colKey;
      if(e.target.checked) state.add(k); else state.delete(k);
      saveState(state); apply(state);
    });
  });
  document.getElementById("cols-reset")?.addEventListener("click",(e)=>{
    e.preventDefault(); const s = new Set(DEFAULTS); saveState(s); apply(s);
  });
})();
</script>

<script>
/* ===== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===== */
(function(){
  if (!{{ report_is_editable|yesno:"true,false" }}) return;

  // CSRF: –±–µ—Ä—ë–º –∏–∑ —Å–∫—Ä—ã—Ç–æ–π —Ñ–æ—Ä–º—ã –∏–ª–∏ —Ñ–æ—Ä–º—ã —Å–∏–Ω–∫–∞, –∑–∞—Ç–µ–º –∏–∑ cookie
  function getCSRFToken() {
    const mainForm = document.getElementById('csrf-form');
    if (mainForm) {
      const token = mainForm.querySelector('[name=csrfmiddlewaretoken]');
      if (token?.value) return token.value;
    }
    const syncForm = document.getElementById('sync-inv-form');
    if (syncForm) {
      const token = syncForm.querySelector('[name=csrfmiddlewaretoken]');
      if (token?.value) return token.value;
    }
    const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  // –ø—Ä–æ—Å—Ç–æ–π –¥–µ–±–∞—É–Ω—Å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
  const timers = new WeakMap();
  function debounce(el, fn, ms=450){
    clearTimeout(timers.get(el));
    const t = setTimeout(fn, ms);
    timers.set(el, t);
  }

  // === –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø saveCell ===
  async function saveCell(input){
    const wrap = input.closest('.cell-editable');
    if (!wrap) return;

    const tr = input.closest('tr');
    if (!tr) return;

    const url = tr.dataset.updateUrl;
    const field = input.dataset.field;
    const val = input.value.trim();

    wrap.classList.remove('saved','error','became-manual');
    wrap.classList.add('saving');
    input.disabled = true;

    try{
      const csrfToken = getCSRFToken();
      if (!csrfToken) throw new Error('CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');

      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fields: { [field]: val } })
      });

      const ct = resp.headers.get('content-type') || '';
      let data;
      if (ct.includes('application/json')) {
        data = await resp.json();
      } else {
        const text = await resp.text();
        throw new Error(text || `HTTP ${resp.status}`);
      }

      if (!resp.ok || !data.ok) throw new Error(data.error || `HTTP ${resp.status}`);

      // –û–±–Ω–æ–≤–ª—è–µ–º total_prints
      const totalCell = tr.querySelector('.total-cell');
      if (totalCell && data.report && typeof data.report.total_prints !== 'undefined'){
        totalCell.textContent = data.report.total_prints;
        totalCell.classList.add('updated');
        setTimeout(()=> totalCell.classList.remove('updated'), 1200);
      }

      wrap.classList.remove('saving');
      wrap.classList.add('saved');

      // === –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===
      if (data.manually_edited_fields && data.manually_edited_fields.length > 0) {
        // –ü–æ–º–µ—á–∞–µ–º —è—á–µ–π–∫—É –∫–∞–∫ —Ä—É—á–Ω—É—é
        wrap.classList.add('manual-edited', 'became-manual');
        input.classList.add('manual-field');

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!wrap.querySelector('.manual-indicator')) {
          const indicator = document.createElement('span');
          indicator.className = 'manual-indicator';
          indicator.textContent = '‚úã';
          indicator.title = `–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é`;
          wrap.appendChild(indicator);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ IP¬∑AUTO
        const serialBadge = tr.querySelector('.serial-info');
        if (serialBadge && !serialBadge.classList.contains('with-manual-fields')) {
          serialBadge.classList.add('with-manual-fields');
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –±–µ–π–¥–∂–∞
          if (serialBadge.textContent === 'IP¬∑AUTO') {
            serialBadge.textContent = 'IP¬∑AUTO¬∑–†–£–ß–ù';
          }
          // –û–±–Ω–æ–≤–ª—è–µ–º tooltip
          const currentTitle = serialBadge.getAttribute('title') || '';
          if (!currentTitle.includes('—Ä—É—á–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º')) {
            serialBadge.setAttribute('title', currentTitle + '<br><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –µ—Å—Ç—å –ø–æ–ª—è —Å —Ä—É—á–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º');
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º title –∏–Ω–ø—É—Ç–∞
        input.title = '–ü–æ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';

        if (data.message) {
          showToast('info', '–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞', data.message, 5000);
        }
      }

      setTimeout(()=> {
        wrap.classList.remove('saved', 'became-manual');
      }, 2000);

    } catch(e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
      wrap.classList.remove('saving');
      wrap.classList.add('error');
      setTimeout(()=> wrap.classList.remove('error'), 3000);
      showToast('error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', e.message, 3000);
    } finally {
      input.disabled = false;
    }
  }

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
  document.querySelectorAll('input.counter-input').forEach(inp=>{
    // –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –ø–∞—É–∑–µ
    inp.addEventListener('input', ()=> debounce(inp, ()=> saveCell(inp), 500));
    // Enter ‚Äî —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º; —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç/–¥–µ–∫—Ä–µ–º–µ–Ω—Ç
    inp.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); saveCell(inp); }
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown'){
        e.preventDefault();
        const delta = (e.key === 'ArrowUp' ? 1 : -1) * (e.shiftKey ? 10 : 1);
        const v = parseInt(inp.value||'0', 10) || 0;
        inp.value = Math.max(0, v + delta);
        debounce(inp, ()=> saveCell(inp), 300);
      }
    });
    // —É—Ö–æ–¥ —Å –ø–æ–ª—è ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    inp.addEventListener('blur', ()=> saveCell(inp));
  });
})();
</script>


<script>
/* ===== –†–µ—Å–∞–π–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ (drag) —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º ===== */
(function(){
  const STORE_KEY = "monthly:colWidths:v1:{{ month_str }}";
  const table = document.querySelector("table.table-resizable");
  if (!table) return;

  const colByKey = {};
  table.querySelectorAll("colgroup col").forEach(col=>{
    const m = col.className.match(/cg-([A-Za-z0-9_]+)/);
    if (m) colByKey[m[1]] = col;
  });

  try {
    const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
    Object.entries(saved).forEach(([k,w])=>{
      if (colByKey[k]) colByKey[k].style.width = w;
    });
  } catch {}

  table.querySelectorAll("thead th").forEach((th)=>{
    const cls = [...th.classList].find(c=>c.startsWith("th-"));
    if (!cls) return;
    const key = cls.slice(3);
    if (!colByKey[key]) return;

    const handle = document.createElement("span");
    handle.className = "col-resize-handle";
    th.appendChild(handle);

    let startX = 0, startW = 0;

    function onMove(e){
      const dx = e.clientX - startX;
      const newW = Math.max(60, startW + dx);
      colByKey[key].style.width = newW + "px";
    }
    function onUp(){
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      handle.classList.remove("active");
      const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
      saved[key] = colByKey[key].style.width || "";
      localStorage.setItem(STORE_KEY, JSON.stringify(saved));
    }

    handle.addEventListener("mousedown", (e)=>{
      e.preventDefault();
      startX = e.clientX;
      startW = parseInt(colByKey[key].style.width) || th.offsetWidth;
      handle.classList.add("active");
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
    });

    handle.addEventListener("dblclick", (e)=>{
      e.preventDefault();
      colByKey[key].style.width = "";
      const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
      delete saved[key];
      localStorage.setItem(STORE_KEY, JSON.stringify(saved));
    });
  });
})();
</script>

<script>
/* ===== –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å inventory (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è) ===== */
document.getElementById('btn-sync-inv')?.addEventListener('click', async ()=>{
  const btn = document.getElementById('btn-sync-inv');
  const status = document.getElementById('sync-inv-status');
  const form = document.getElementById('sync-inv-form');

  if (!form) {
    status.textContent = '–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
    return;
  }

  btn.disabled = true;
  status.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';

  try{
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) throw new Error('CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');

    const resp = await fetch(form.action, {
      method: 'POST',
      headers: {'X-CSRFToken': csrfToken}
    });

    const data = await resp.json();
    if (!resp.ok || !data.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞');

    let statusText = `–ì–æ—Ç–æ–≤–æ: –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫ ‚Äî ${data.updated_rows}, –≥—Ä—É–ø–ø ‚Äî ${data.groups_recomputed}`;
    if (data.manually_edited_skipped && data.manually_edited_skipped > 0) {
      statusText += `, –ø—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª–µ–π (—Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî ${data.manually_edited_skipped}`;
      showToast('info', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—è –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—ã–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Ä—É—á–Ω—É—é', 5000);
    } else {
      showToast('success', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated_rows} –∑–∞–ø–∏—Å–µ–π`, 3000);
    }

    status.textContent = statusText;

    // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    setTimeout(() => {
      if (confirm('–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π?')) {
        location.reload();
      }
    }, 2000);

  } catch(e) {
    status.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    showToast('error', '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', e.message, 5000);
  } finally {
    btn.disabled = false;
  }
});
</script>

<script>
/* ===== –§–∏–ª—å—Ç—Ä—ã ===== */
document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏
  document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
    dropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  // –ü–æ–∏—Å–∫ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –≤ —Å–ø–∏—Å–∫–µ
  document.querySelectorAll('.search-suggestions').forEach(function(searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const key = this.dataset.key;
      const suggestions = document.querySelector('.suggestions[data-key="' + key + '"]');
      if (suggestions) {
        suggestions.querySelectorAll('.suggestion-item').forEach(function(item) {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      }
    });
  });

  // –ö–Ω–æ–ø–∫–∞ "OK" (–ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä)
  document.querySelectorAll('.apply-filter').forEach(function(button) {
    button.addEventListener('click', function() {
      const key = this.dataset.key;
      const input = document.getElementById('flt-' + key);
      const value = input.value.trim();

      const url = new URL(window.location);
      if (value) url.searchParams.set(key, value);
      else url.searchParams.delete(key);
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  });

  // Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å
  document.querySelectorAll('.flt-input').forEach(function(input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const key = this.dataset.key;
        document.querySelector('.apply-filter[data-key="' + key + '"]')?.click();
      }
    });
  });

  // "–°–±—Ä–æ—Å" –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
  document.querySelectorAll('.clear-filter').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const key = this.dataset.key;
      const url = new URL(window.location);
      url.searchParams.delete(key);
      url.searchParams.delete('page');
      window.location.href = url.toString();
    });
  });

  // –ö–ª–∏–∫ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ
  document.querySelectorAll('.suggestion-item').forEach(function(item) {
    item.addEventListener('click', function() {
      const suggestions = this.closest('.suggestions');
      const key = suggestions.dataset.key;
      const input = document.getElementById('flt-' + key);
      const value = this.textContent.trim();
      if (input) {
        input.value = value;
        document.querySelector('.apply-filter[data-key="' + key + '"]')?.click();
      }
    });
  });
});
/* ===== –ü–ª–∞–≤–∞—é—â–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª ===== */
(function(){
  const tableContainer = document.querySelector('.table-responsive');
  const floatingScrollbar = document.getElementById('floatingScrollbar');
  const floatingScrollbarInner = document.getElementById('floatingScrollbarInner');
  const floatingScrollbarContent = document.getElementById('floatingScrollbarContent');
  const scrollProgress = document.getElementById('scrollProgress');

  if (!tableContainer || !floatingScrollbar || !floatingScrollbarInner || !floatingScrollbarContent) {
    return;
  }

  let isFloatingScrolling = false;
  let isTableScrolling = false;
  let hideTimeout;

  function updateFloatingScrollbar() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ —Ä–∞–≤–Ω–æ–π —à–∏—Ä–∏–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
    const table = tableContainer.querySelector('table');
    if (table) {
      floatingScrollbarContent.style.width = table.scrollWidth + 'px';
      floatingScrollbarInner.style.width = tableContainer.clientWidth + 'px';
    }
  }

  function syncScrollPosition() {
    if (!isFloatingScrolling) {
      floatingScrollbarInner.scrollLeft = tableContainer.scrollLeft;
    }
  }

  function showFloatingScrollbar() {
    const tableRect = tableContainer.getBoundingClientRect();
    const isTableVisible = tableRect.bottom > window.innerHeight || tableRect.top < 0;
    const hasHorizontalScroll = tableContainer.scrollWidth > tableContainer.clientWidth;

    if (isTableVisible && hasHorizontalScroll) {
      floatingScrollbar.classList.add('show');
      updateScrollProgress();
    } else {
      floatingScrollbar.classList.remove('show');
    }
  }

  function updateScrollProgress() {
    if (!scrollProgress) return;

    const scrollPercent = (tableContainer.scrollLeft / (tableContainer.scrollWidth - tableContainer.clientWidth)) || 0;
    scrollProgress.style.transform = `scaleX(${Math.min(scrollPercent, 1)})`;
  }

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–ª–∞–≤–∞—é—â–∏–º —Å–∫—Ä–æ–ª–ª–æ–º
  tableContainer.addEventListener('scroll', function() {
    if (!isFloatingScrolling) {
      isTableScrolling = true;
      syncScrollPosition();
      updateScrollProgress();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞–≤–∞—é—â–∏–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
      showFloatingScrollbar();

      // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(() => {
        if (tableContainer.getBoundingClientRect().bottom > window.innerHeight) {
          // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        }
      }, 2000);

      setTimeout(() => { isTableScrolling = false; }, 10);
    }
  });

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π
  floatingScrollbarInner.addEventListener('scroll', function() {
    if (!isTableScrolling) {
      isFloatingScrolling = true;
      tableContainer.scrollLeft = floatingScrollbarInner.scrollLeft;
      updateScrollProgress();
      setTimeout(() => { isFloatingScrolling = false; }, 10);
    }
  });

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–ª–∞–≤–∞—é—â–∏–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  let scrollTimer;
  window.addEventListener('scroll', function() {
    showFloatingScrollbar();

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(() => {
      const tableRect = tableContainer.getBoundingClientRect();
      if (tableRect.top >= 0 && tableRect.bottom <= window.innerHeight) {
        // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω–∞ - –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–ª–∞–≤–∞—é—â–∏–π —Å–∫—Ä–æ–ª–ª
        setTimeout(() => {
          floatingScrollbar.classList.remove('show');
        }, 1000);
      }
    }, 150);
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', function() {
    updateFloatingScrollbar();
    showFloatingScrollbar();
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–æ–∫ (—Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å)
  const columnToggles = document.querySelectorAll('.column-toggle');
  columnToggles.forEach(toggle => {
    toggle.addEventListener('change', function() {
      setTimeout(() => {
        updateFloatingScrollbar();
        showFloatingScrollbar();
      }, 50);
    });
  });

  // –ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  setTimeout(() => {
    updateFloatingScrollbar();
    showFloatingScrollbar();
  }, 100);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–∫–æ–Ω—Ç–µ–Ω—Ç–∞
  window.addEventListener('load', function() {
    updateFloatingScrollbar();
    showFloatingScrollbar();
  });

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ MutationObserver –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(function(mutations) {
      let shouldUpdate = false;
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList' ||
            (mutation.type === 'attributes' && mutation.attributeName === 'class')) {
          shouldUpdate = true;
        }
      });

      if (shouldUpdate) {
        setTimeout(() => {
          updateFloatingScrollbar();
          showFloatingScrollbar();
        }, 10);
      }
    });

    observer.observe(tableContainer, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['class', 'style']
    });
  }
})();
</script>
<script>
/* ===== –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–∏–ø–∫–∞—è —à–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (—Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–ª–æ–Ω–æ–º –≤–Ω–∏–∑—É) ===== */
(function(){
  const tableContainer = document.querySelector('.table-responsive');
  const table = document.querySelector('.table-fixed');
  if (!tableContainer || !table) return;

  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–∏–ø–∫–æ–π —à–∞–ø–∫–∏ (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
  const stickyIndicator = document.getElementById('stickyHeaderIndicator') || (() => {
    const el = document.createElement('div');
    el.className = 'sticky-header-indicator';
    el.id = 'stickyHeaderIndicator';
    document.body.insertBefore(el, document.body.firstChild);
    return el;
  })();

  let isHeaderSticky = false;
  let scrollTimer;

  // === –ö–õ–û–ù-–®–ê–ü–ö–ê (fixed) ===
  const origThead = table.querySelector('thead');
  if (!origThead) return;

  const clonedHeaderWrap = document.createElement('div');
  clonedHeaderWrap.style.position = 'fixed';
  clonedHeaderWrap.style.top = '0';
  clonedHeaderWrap.style.left = '0';
  clonedHeaderWrap.style.right = '0';
  clonedHeaderWrap.style.zIndex = '1100';
  clonedHeaderWrap.style.pointerEvents = 'none'; // –∫–ª–∏–∫–∏ –∏–¥—É—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª
  clonedHeaderWrap.style.display = 'none';
  clonedHeaderWrap.style.transform = 'translateX(0)';
  clonedHeaderWrap.setAttribute('aria-hidden', 'true');

  // –°–∞–º –∫–ª–æ–Ω —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
  const clonedTable = document.createElement('table');
  clonedTable.className = table.className; // –Ω–∞—Å–ª–µ–¥—É–µ–º –∫–ª–∞—Å—Å—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
  clonedTable.style.margin = '0';
  clonedTable.style.pointerEvents = 'none';
  clonedTable.style.background = 'rgba(248, 249, 250, 0.98)';
  clonedTable.style.backdropFilter = 'blur(8px)';
  clonedTable.style.borderCollapse = 'separate';
  clonedTable.style.borderSpacing = '0';

  // –í—Å—Ç–∞–≤–ª—è–µ–º: –∫–ª–æ–Ω THEAD
  const clonedThead = origThead.cloneNode(true);
  // –£–±–∏—Ä–∞–µ–º –≤—Å–µ data-bs-* —É –∫–ª–æ–Ω–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å —Ç—É–ª—Ç–∏–ø—ã/–¥—Ä–æ–ø–¥–∞—É–Ω—ã)
  clonedThead.querySelectorAll('[data-bs-toggle]').forEach(el => el.removeAttribute('data-bs-toggle'));
  clonedTable.appendChild(clonedThead);
  clonedHeaderWrap.appendChild(clonedTable);
  document.body.appendChild(clonedHeaderWrap);

  // –ü–æ–¥—Å—á—ë—Ç —Å—É–º–º–∞—Ä–Ω–æ–π –≤—ã—Å–æ—Ç—ã —à–∞–ø–∫–∏
  function headerTotalHeight() {
    const h1 = (origThead.rows[0]?.offsetHeight || 0);
    const h2 = (origThead.rows[1]?.offsetHeight || 0);
    return h1 + h2 || (origThead.offsetHeight || 0);
  }

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —à–∏—Ä–∏–Ω –∫–æ–ª–æ–Ω–æ–∫ –º–µ–∂–¥—É –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –∏ –∫–ª–æ–Ω–æ–º
  function syncHeaderWidths() {
    const origTh = Array.from(origThead.querySelectorAll('th'));
    const cloneTh = Array.from(clonedThead.querySelectorAll('th'));

    // —à–∏—Ä–∏–Ω–∞ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã ‚Äî —á—Ç–æ–±—ã –∫–ª–æ–Ω —Å–æ–≤–ø–∞–¥–∞–ª
    clonedHeaderWrap.style.width = tableContainer.clientWidth + 'px';

    // –±–µ—Ä—ë–º —à–∏—Ä–∏–Ω—ã –∏–∑ <colgroup> –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ th.getBoundingClientRect()
    const colEls = table.querySelectorAll('colgroup col');
    origTh.forEach((th, i) => {
      let w = th.getBoundingClientRect().width;
      if (colEls[i]) {
        const cw = parseFloat(getComputedStyle(colEls[i]).width) || w;
        if (cw) w = cw;
      }
      // –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —Å–∫—Ä—ã—Ç–∞ (d-none), –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–ª–µ–≤—É—é/—Ç–µ–∫—É—â—É—é —à–∏—Ä–∏–Ω—É
      if (th.classList.contains('d-none')) w = 0;

      if (cloneTh[i]) {
        cloneTh[i].style.minWidth = w + 'px';
        cloneTh[i].style.maxWidth = w + 'px';
        cloneTh[i].style.width = w + 'px';
        // –°–∫—Ä—ã—Ç–∏–µ –¥–ª—è d-none
        cloneTh[i].style.display = th.classList.contains('d-none') ? 'none' : '';
      }
    });
  }

  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–ø–µ—Ä–µ–≤–æ–¥ –∫–ª–æ–Ω–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ)
  function syncHorizontalScroll() {
    // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∫–ª–æ–Ω –≤–ª–µ–≤–æ –Ω–∞ scrollLeft, —á—Ç–æ–±—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–ª–∏ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏
    clonedHeaderWrap.style.transform = `translateX(${-tableContainer.scrollLeft}px)`;
  }

  // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∫–ª–æ–Ω–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–≥–¥–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è sticky-—à–∞–ø–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–ø—ë—Ä–ª–∞—Å—å –≤ –Ω–∏–∑ —Ç–∞–±–ª–∏—Ü—ã
  function updateFixedCloneVisibility() {
    const rect = tableContainer.getBoundingClientRect();
    const headHeight = headerTotalHeight();

    const tableTopAboveViewport = rect.top < 0;
    const tableBottomAboveHeaderTop = rect.bottom < headHeight; // –∑–Ω–∞—á–∏—Ç, sticky —É–∂–µ –Ω–µ –≤–∏–¥–Ω–æ

    // –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≤—å—é–ø–æ—Ä—Ç?
    const intersectsViewport = rect.bottom > 0 && rect.top < window.innerHeight;

    if (intersectsViewport && tableTopAboveViewport && tableBottomAboveHeaderTop) {
      clonedHeaderWrap.style.display = 'block';
      syncHeaderWidths();
      syncHorizontalScroll();
    } else {
      clonedHeaderWrap.style.display = 'none';
    }
  }

  // –¢–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã sticky
  function updateStickyHeader() {
    const rect = tableContainer.getBoundingClientRect();
    const shouldBeSticky = rect.top < 0 && rect.bottom > 0; // —Ç–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≤—å—é–ø–æ—Ä—Ç

    if (shouldBeSticky && !isHeaderSticky) {
      isHeaderSticky = true;
      document.body.classList.add('sticky-active');
      stickyIndicator.classList.add('show');
      table.querySelectorAll('thead th').forEach(th => th.style.transform = 'translateY(0)');
    } else if (!shouldBeSticky && isHeaderSticky) {
      isHeaderSticky = false;
      document.body.classList.remove('sticky-active');
      stickyIndicator.classList.remove('show');
    }

    // –ì—Ä–∞–¥–∏–µ–Ω—Ç-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    if (isHeaderSticky) {
      const tableHeight = table.offsetHeight;
      const visibleTableTop = Math.max(0, -rect.top);
      const denom = Math.max(1, tableHeight - window.innerHeight);
      const scrollPercent = Math.min(visibleTableTop / denom, 1);
      stickyIndicator.style.background = `linear-gradient(90deg,
        #0d6efd 0%,
        #198754 ${scrollPercent * 50}%,
        #fd7e14 ${scrollPercent * 100}%)`;
    }

    // –ò –æ—Ç–¥–µ–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–ª–æ–Ω–∞
    updateFixedCloneVisibility();
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏
  function onScroll() {
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(() => {
      updateStickyHeader();
      syncHorizontalScroll();
    }, 10);
  }

  tableContainer.addEventListener('scroll', onScroll);
  window.addEventListener('scroll', onScroll);
  window.addEventListener('resize', () => {
    syncHeaderWidths();
    updateStickyHeader();
    syncHorizontalScroll();
  });

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫/—Ä–µ—Å–∞–π–∑–∞
  document.querySelectorAll('.column-toggle').forEach(toggle => {
    toggle.addEventListener('change', () => {
      setTimeout(() => {
        syncHeaderWidths();
        updateStickyHeader();
        syncHorizontalScroll();
      }, 50);
    });
  });

  // –•—ç–Ω–¥–ª—ã —Ä–µ—Å–∞–π–∑–∞ –∫–æ–ª–æ–Ω–æ–∫ ‚Äî –ª–æ–≤–∏–º mouseup, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–ª–æ–Ω
  document.addEventListener('mouseup', () => {
    setTimeout(() => {
      syncHeaderWidths();
      syncHorizontalScroll();
    }, 30);
  });

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  setTimeout(() => {
    syncHeaderWidths();
    updateStickyHeader();
    syncHorizontalScroll();
  }, 120);

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ª–∏–ø–∫–æ–π —à–∞–ø–∫–µ (–∫–∞–∫ —É —Ç–µ–±—è)
  if (!localStorage.getItem('stickyHeaderTipShown') && typeof showToast === 'function') {
    const tipListener = () => {
      if (isHeaderSticky) {
        showToast('info', '–õ–∏–ø–∫–∞—è —à–∞–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞',
          '–ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã —Å–≤–µ—Ä—Ö—É, –¥–∞–∂–µ –≤–Ω–∏–∑—É —Ç–∞–±–ª–∏—Ü—ã', 3000);
        localStorage.setItem('stickyHeaderTipShown', 'true');
        window.removeEventListener('scroll', tipListener);
      }
    };
    window.addEventListener('scroll', tipListener);
  }

  // Fallback: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç sticky ‚Äî –∫–ª–æ–Ω —Å–ø–∞—Å—ë—Ç —Å–∏—Ç—É–∞—Ü–∏—é
  try {
    if (!CSS.supports || !CSS.supports('position', 'sticky')) {
      // –Ω–∏—á–µ–≥–æ, –∫–ª–æ–Ω –∏ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
    }
  } catch {}
})();
</script>

{% endblock %}