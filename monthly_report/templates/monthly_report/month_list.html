{% extends 'base.html' %}

{% block head_extra %}
<style>
  .month-toolbar { gap: .5rem; }
  .month-card {
    transition: transform .12s ease, box-shadow .12s ease;
    border-radius: 1rem;
    position: relative;
  }
  .month-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 .25rem 1rem rgba(0,0,0,.08);
  }
  .month-card .bi { opacity: .7; }
  .month-badge { font-weight: 600; }

  /* Название месяца черное */
  .month-card .fw-semibold {
    color: #212529;
  }

  /* Кнопка экспорта внизу справа - прозрачная с зеленой иконкой */
  .export-btn {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    z-index: 10;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    background-color: transparent !important;
    border: none;
    color: #198754;
  }
  .export-btn:hover {
    transform: scale(1.1);
    color: #157347;
  }
  .export-btn .bi {
    opacity: 1;
  }
</style>
{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Ежемесячные отчёты</h1>

<div class="d-flex flex-wrap align-items-center month-toolbar mb-3">
  <div class="input-group input-group-sm" style="max-width: 340px;">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input id="searchInput" type="text" class="form-control" placeholder="Поиск: ноябрь, 2025, Иркутск...">
  </div>

  <div class="input-group input-group-sm" style="width: 220px;">
    <span class="input-group-text"><i class="bi bi-filter"></i></span>
    <select id="yearSelect" class="form-select">
      <option value="">Все годы</option>
    </select>
  </div>

  <div class="ms-auto d-flex align-items-center small text-muted">
    <span id="visibleCount">—</span>
  </div>

  {% if perms.monthly_report.upload_monthly_report %}
    <a class="btn btn-success btn-sm ms-2" href="{% url 'upload_excel' %}">
      <i class="bi bi-file-earmark-excel"></i> Загрузка Excel
    </a>
  {% endif %}
</div>

<div id="monthsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
  {% for m in months %}
    {% with y=m.month_trunc|date:'Y' ym=m.month_trunc|date:'Y-m' ym_int=m.month_trunc title=m.month_trunc|date:'F Y' %}
    <div class="col month-item" data-year="{{ y }}" data-text="{{ title|lower }} {{ y }}">
      <a class="text-decoration-none" href="{% url 'month_detail' month=ym %}">
        <div class="card shadow-sm month-card h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="text-muted small">{{ y }}</div>
                <div class="fw-semibold">{{ m.month_trunc|date:'F' }}</div>
              </div>

              <div class="text-end">
                <span class="badge bg-primary-subtle text-primary-emphasis month-badge">
                  {{ m.count }} записей
                </span>
                {% if m.is_editable %}
                  <div class="small mt-1">
                    <span class="badge bg-success-subtle text-success-emphasis" title="Редактирование открыто">
                      <i class="bi bi-unlock"></i> до {{ m.edit_until|date:"d.m H:i" }}
                    </span>
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="mt-3 small text-muted">
              <i class="bi bi-chevron-right"></i> открыть отчёт
            </div>
          </div>

          <!-- Кнопка экспорта внизу справа - прозрачная с зеленой стрелкой -->
          <a href="{% url 'export_month_excel' year=ym_int.year month=ym_int.month %}"
             class="btn export-btn"
             title="Скачать Excel"
             onclick="event.stopPropagation(); event.preventDefault(); window.location.href=this.href;">
            <i class="bi bi-download"></i>
          </a>
        </div>
      </a>
    </div>
    {% endwith %}
  {% empty %}
    <div class="col">
      <div class="alert alert-secondary mb-0">Нет загруженных месяцев.</div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const grid = document.getElementById('monthsGrid');
  const items = [...grid.querySelectorAll('.month-item')];

  // === заполнить селект годов ===
  const yearSel = document.getElementById('yearSelect');
  const years = [...new Set(items.map(it => it.dataset.year))].sort((a,b)=>b.localeCompare(a));
  for(const y of years){
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    yearSel.appendChild(opt);
  }

  // === фильтр (поиск + год) ===
  const search = document.getElementById('searchInput');
  const counter = document.getElementById('visibleCount');

  function applyFilter(){
    const term = (search.value || '').trim().toLowerCase();
    const year = yearSel.value || '';
    let visible = 0;
    for(const it of items){
      const okYear = !year || it.dataset.year === year;
      const okText = !term || it.dataset.text.includes(term);
      const show = okYear && okText;
      it.classList.toggle('d-none', !show);
      if (show) visible++;
    }
    counter.textContent = visible + ' из ' + items.length;
  }

  search.addEventListener('input', applyFilter);
  yearSel.addEventListener('change', applyFilter);
  applyFilter();

  // === защитим код "быстрый переход", если элементов нет ===
  const jumpBtn = document.getElementById('jumpBtn');
  const jump = document.getElementById('jumpMonth');
  if (jumpBtn && jump) {
    jumpBtn.addEventListener('click', () => {
      const val = (jump.value || '').trim(); // YYYY-MM
      if(!val) return;
      window.location.href = `/monthly-report/${val}/`;
    });
  }
})();
</script>
{% endblock %}