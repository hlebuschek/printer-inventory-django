<!-- Партиал для фильтра колонок -->
<th class="column-filter th-{{ key }}">
  <div class="d-flex align-items-center gap-1 position-relative">
    <span class="flex-grow-1">{{ label }}</span>

    {% if options %}
    <div class="dropdown">
      <button class="btn btn-link btn-sm p-0 text-muted dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              data-bs-auto-close="outside"
              aria-expanded="false">
        <i class="bi bi-funnel"></i>
      </button>

      <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px; max-height: 300px; overflow-y: auto;">
        <form method="get" class="filter-form">
          <!-- Сохраняем все текущие параметры кроме текущего фильтра -->
          {% for k, v in request.GET.items %}
            {% if k != key and k != 'page' %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endif %}
          {% endfor %}

          <div class="mb-2">
            <input type="text"
                   name="{{ key }}"
                   value="{{ value }}"
                   class="form-control form-control-sm"
                   placeholder="Поиск...">
          </div>

          <div class="mb-2">
            <small class="text-muted">Выберите значение:</small>
          </div>

          {% for option in options|slice:":20" %}
          <div class="form-check">
            <input class="form-check-input filter-option"
                   type="radio"
                   name="{{ key }}"
                   value="{{ option }}"
                   id="{{ key }}_{{ forloop.counter }}"
                   {% if option == value %}checked{% endif %}>
            <label class="form-check-label small" for="{{ key }}_{{ forloop.counter }}">
              {{ option|truncatechars:30 }}
            </label>
          </div>
          {% endfor %}

          {% if options|length > 20 %}
          <small class="text-muted">Показано первые 20 из {{ options|length }}</small>
          {% endif %}

          <div class="mt-2 pt-2 border-top">
            <button type="submit" class="btn btn-primary btn-sm">Применить</button>
            <a href="?{% if base_qs %}{{ base_qs }}{% endif %}" class="btn btn-outline-secondary btn-sm">Сбросить</a>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <div class="col-resize-handle"></div>
  </div>
</th>