# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Worker –¥–ª—è low_priority –Ω–µ –∑–∞–ø—É—â–µ–Ω

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—á–µ—Ä–µ–¥—å `low_priority` —Ä–∞—Å—Ç—ë—Ç: 9,919 ‚Üí 19,334+ –∑–∞–¥–∞—á
- Workers –¥–ª—è `high_priority` –∏ `daemon` —Ä–∞–±–æ—Ç–∞—é—Ç
- **Worker –¥–ª—è `low_priority` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!**

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ)

```bash
cd /var/www/printer-inventory
source .venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö workers
ps aux | grep "celery.*worker.*low_priority" | grep -v grep

# –ï—Å–ª–∏ –ø—É—Å—Ç–æ - worker –ù–ï –ó–ê–ü–£–©–ï–ù!
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```bash
./diagnose_workers.sh
```

## üöÄ –†–µ—à–µ–Ω–∏–µ 1: –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (5 –º–∏–Ω—É—Ç)

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ low_priority worker, –Ω–µ —Ç—Ä–æ–≥–∞—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ:**

```bash
cd /var/www/printer-inventory
source .venv/bin/activate

./start_low_priority_worker.sh
```

–°–∫—Ä–∏–ø—Ç:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ
- ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç worker —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ –ü–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –ª–æ–≥–∏

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫ –æ—á–µ—Ä–µ–¥—å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
watch -n 5 'redis-cli -n 3 LLEN low_priority'

# –õ–æ–≥–∏ worker'–∞
tail -f logs/celery_low.log
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—á–µ—Ä–µ–¥—å –Ω–∞—á–Ω—ë—Ç **–£–ú–ï–ù–¨–®–ê–¢–¨–°–Ø**
- –í –ª–æ–≥–∞—Ö –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á

---

## üöÄ –†–µ—à–µ–Ω–∏–µ 2: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ (10 –º–∏–Ω—É—Ç)

**–ï—Å–ª–∏ —É –≤–∞—Å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (40+), –ª—É—á—à–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë:**

```bash
cd /var/www/printer-inventory
source .venv/bin/activate

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ Celery –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f celery

# –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
ps aux | grep celery | grep -v grep

# –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
pkill -9 -f celery

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ
nohup ./start_workers.sh > logs/celery.log 2>&1 &

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –í–°–ï workers
sleep 3
./diagnose_workers.sh
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ:**
- `high_priority`: 4+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (concurrency=4)
- `low_priority`: 2+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (concurrency=2) ‚Üê **–í–ê–ñ–ù–û!**
- `daemon`: 1+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (concurrency=1)
- `beat`: 1 –ø—Ä–æ—Ü–µ—Å—Å

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è

**–ï—Å–ª–∏ low_priority worker –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**

```bash
# –û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
grep -i error logs/celery_low.log | tail -20

# –û—à–∏–±–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–æ–≥–µ
grep -i "low_priority" logs/celery.log | tail -20

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è systemd)
journalctl -u celery-worker-low -n 50
```

**–ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è:**

1. **–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
   ```bash
   pip install -r requirements.txt
   pip install -r requirements/daphne-requirements.txt
   ```

2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `free -h`

3. **–û—à–∏–±–∫–∏ –≤ –∑–∞–¥–∞—á–∞—Ö** - –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ traceback –≤ –ª–æ–≥–∞—Ö

4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã** - worker –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç `www-data`:
   ```bash
   chown -R www-data:www-data /var/www/printer-inventory
   ```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (5 –º–∏–Ω—É—Ç):

```bash
# –ó–∞–ø–∏—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
BEFORE=$(redis-cli -n 3 LLEN low_priority)
echo "–û—á–µ—Ä–µ–¥—å: $BEFORE"

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5 –º–∏–Ω—É—Ç
sleep 300

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–Ω–æ–≤–∞
AFTER=$(redis-cli -n 3 LLEN low_priority)
PROCESSED=$((BEFORE - AFTER))

echo "–ë—ã–ª–æ: $BEFORE"
echo "–°—Ç–∞–ª–æ: $AFTER"
echo "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: $PROCESSED –∑–∞–¥–∞—á –∑–∞ 5 –º–∏–Ω—É—Ç"
echo "–°–∫–æ—Ä–æ—Å—Ç—å: $(($PROCESSED / 5)) –∑–∞–¥–∞—á/–º–∏–Ω"
```

**–ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- ~10-50 –∑–∞–¥–∞—á/–º–∏–Ω—É—Ç—É (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤)

**–ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∏–∑–∫–∞—è:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `concurrency` —Å 2 –¥–æ 4 –≤ `start_workers.sh`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ workers

---

## üõ† –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: systemd

**–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd:**

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/systemd/system/celery-worker-low.service`:

```ini
[Unit]
Description=Celery Worker (Low Priority Queue)
After=network.target redis.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/var/www/printer-inventory
Environment="PATH=/var/www/printer-inventory/.venv/bin"

ExecStart=/var/www/printer-inventory/.venv/bin/celery \
    -A printer_inventory worker \
    --queues=low_priority \
    --loglevel=INFO \
    --concurrency=2 \
    --max-tasks-per-child=200 \
    --hostname=worker_low@%%h \
    --pidfile=/var/run/celery/worker_low.pid \
    --logfile=/var/www/printer-inventory/logs/celery_low.log \
    --detach

Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=celery-worker-low

[Install]
WantedBy=multi-user.target
```

### 2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å:

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –¥–ª—è PID —Ñ–∞–π–ª–æ–≤
sudo mkdir -p /var/run/celery
sudo chown www-data:www-data /var/run/celery

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ systemd
sudo systemctl daemon-reload

# –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
sudo systemctl enable celery-worker-low

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl start celery-worker-low

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
sudo systemctl status celery-worker-low

# –õ–æ–≥–∏
sudo journalctl -u celery-worker-low -f
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- ‚úÖ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ journald
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ `systemctl`

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

- [ ] Worker –¥–ª—è `low_priority` –∑–∞–ø—É—â–µ–Ω
- [ ] –û—á–µ—Ä–µ–¥—å –Ω–∞—á–∞–ª–∞ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è
- [ ] –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è (10+ –∑–∞–¥–∞—á/–º–∏–Ω)
- [ ] –õ–æ–≥–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—à–∏–±–æ–∫
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω systemd –¥–ª—è –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Grafana, Prometheus, etc.)

---

## ‚ùì FAQ

**Q: –ü–æ—á–µ–º—É worker –¥–ª—è low_priority –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–∑ start_workers.sh?**

A: –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
1. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (—Å–º. –ª–æ–≥–∏)
2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞
4. Worker —É–ø–∞–ª –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

**Q: –°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª—è low_priority?**

A: –ú–∏–Ω–∏–º—É–º 2 (–∏–∑-–∑–∞ `--concurrency=2`), –æ–±—ã—á–Ω–æ 2-3 –ø—Ä–æ—Ü–µ—Å—Å–∞.

**Q: –ú–æ–∂–Ω–æ –ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å concurrency?**

A: –î–∞! –í `start_workers.sh` –∏–∑–º–µ–Ω–∏—Ç–µ:
```bash
--concurrency=4  # –±—ã–ª–æ 2
```

**Q: –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏?**

A: –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏:
```bash
tail -f logs/celery_low.log | grep "Task.*succeeded"
```

**Q: –û—á–µ—Ä–µ–¥—å –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞—Å—Ç—ë—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å?**

A:
1. –£–≤–µ–ª–∏—á—å—Ç–µ concurrency –¥–æ 4
2. –°–Ω–∏–∑—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É daemon (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ –≤–º–µ—Å—Ç–æ 1)
3. –£–≤–µ–ª–∏—á—å—Ç–µ MAX_QUEUE_SIZE –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
4. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ workers (–∑–∞–ø—É—Å—Ç–∏—Ç–µ start_workers.sh –¥–≤–∞–∂–¥—ã —Å —Ä–∞–∑–Ω—ã–º–∏ hostname)

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ:
1. –í—ã–≤–æ–¥ `./diagnose_workers.sh`
2. –õ–æ–≥–∏: `logs/celery_low.log` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫)
3. –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏: `redis-cli -n 3 LLEN low_priority`
4. –í—ã–≤–æ–¥: `ps aux | grep celery | grep -v grep`
