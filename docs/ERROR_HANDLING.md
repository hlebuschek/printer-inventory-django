# Система обработки ошибок

Проект включает полноценную систему обработки ошибок с красивыми страницами ошибок, логированием и middleware для production-среды.

## Компоненты системы

### 1. Обработчики ошибок (`printer_inventory/errors.py`)

Кастомные view-функции для обработки HTTP ошибок:
- `custom_400` - Неверный запрос  
- `custom_403` - Доступ запрещён
- `custom_404` - Страница не найдена
- `custom_405` - Метод не разрешён  
- `custom_500` - Внутренняя ошибка сервера
- `custom_csrf_failure` - Ошибки CSRF защиты

### 2. Middleware (`printer_inventory/middleware.py`)

**ErrorHandlingMiddleware:**
- Перехватывает исключения в production
- Логирует ошибки с контекстом (пользователь, IP, User-Agent)
- Возвращает красивые страницы ошибок

**SecurityHeadersMiddleware:**
- Добавляет заголовки безопасности
- Content Security Policy (CSP)
- X-Frame-Options, X-XSS-Protection и др.

**RequestLoggingMiddleware:**
- Логирует важные запросы (POST, PUT, DELETE)
- Фиксирует ответы с ошибками

### 3. Шаблоны ошибок (`templates/`)

Красивые, адаптивные страницы ошибок:
- `400.html`, `403.html`, `403_csrf.html`
- `404.html`, `405.html`, `500.html`
- `error.html` - универсальный шаблон

Все шаблоны включают:
- Bootstrap стили и иконки
- Контекстную помощь пользователю
- Навигацию в зависимости от прав доступа
- Быстрые ссылки для восстановления

### 4. Логирование

Настроено в `settings.py`:
- **Console handler** - вывод в консоль
- **File handler** - общие логи в `logs/django.log`  
- **Error handler** - только ошибки в `logs/errors.log`

Логируется:
- Все исключения с полным traceback
- HTTP ошибки с контекстом запроса
- Информация о пользователе и IP

## Режимы работы

### DEBUG = True (разработка)
- Django показывает встроенные детальные страницы ошибок
- Доступны тестовые URL `/debug/errors/`
- Подробные трейсбеки для отладки
- Middleware логирует, но не перехватывает исключения

### DEBUG = False (production)  
- Активируются кастомные обработчики ошибок
- Показываются красивые страницы ошибок
- Скрывается чувствительная информация
- Полное логирование в файлы

## Тестирование

### Команды управления

```bash
# Проверить текущий статус DEBUG
python manage.py toggle_debug --status

# Включить DEBUG режим
python manage.py toggle_debug --on

# Выключить DEBUG режим (production)
python manage.py toggle_debug --off

# Запустить тесты обработчиков
python manage.py test_errors --test-all
```

### Тестовые URL (только в DEBUG режиме)

```
/debug/errors/           # Меню тестирования
/debug/errors/400/       # Неверный запрос
/debug/errors/403/       # Доступ запрещён  
/debug/errors/404/       # Страница не найдена
/debug/errors/405/       # Метод не разрешён
/debug/errors/500/       # Внутренняя ошибка сервера
/debug/errors/csrf/      # Тестирование CSRF
```

### Ручное тестирование

1. **Переключитесь в production режим:**
   ```bash
   python manage.py toggle_debug --off
   python manage.py runserver
   ```

2. **Тестируйте ошибки:**
   - 404: перейдите на несуществующую страницу
   - 403: войдите обычным пользователем и попробуйте `/admin/`
   - 500: временно добавьте `raise Exception()` в любой view

3. **Проверьте логи:**
   ```bash
   tail -f logs/django.log
   tail -f logs/errors.log
   ```

## Настройка для production

### 1. Переменные окружения (.env)
```env
DEBUG=False
SECRET_KEY=your-secure-secret-key
ALLOWED_HOSTS=your-domain.com,www.your-domain.com
```

### 2. Веб-сервер (Nginx)

Настройте кастомные страницы ошибок:
```nginx
error_page 404 /404/;
error_page 500 502 503 504 /500/;
```

### 3. Мониторинг логов

Настройте ротацию логов и мониторинг:
```bash
# Ротация логов
sudo logrotate -f /path/to/logrotate.conf

# Мониторинг ошибок  
tail -f logs/errors.log | grep ERROR
```

## Кастомизация

### Добавление новых типов ошибок

1. **Создайте обработчик в `errors.py`:**
   ```python
   def custom_429(request, exception=None):
       return generic_error(request, 429, 'Слишком много запросов', 
                          'Попробуйте позже')
   ```

2. **Добавьте в `settings.py`:**
   ```python
   handler429 = 'printer_inventory.errors.custom_429'
   ```

3. **Создайте шаблон `429.html`**

### Настройка логирования

Измените уровни логирования в `settings.py`:
```python
'loggers': {
    'django.request': {
        'level': 'WARNING',  # Только предупреждения и выше
    },
}
```

### Кастомизация страниц ошибок

Переопределите шаблоны в `templates/`:
- Добавьте брендинг компании
- Измените цветовую схему
- Добавьте дополнительные ссылки
- Интегрируйте с системой поддержки

## Безопасность

### Заголовки безопасности

Автоматически добавляются в production:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`  
- `X-XSS-Protection: 1; mode=block`
- `Content-Security-Policy`

### Скрытие информации

В production режиме:
- Скрываются трейсбеки
- Не показываются внутренние пути
- Логируется минимум пользовательских данных
- CSRF защита активна

## Мониторинг и алерты

### Настройка алертов

Можно интегрировать с:
- **Sentry** - для отслеживания ошибок
- **Grafana** - для визуализации метрик
- **Prometheus** - для сбора метрик
- **Email/Slack** - для уведомлений об ошибках

### Метрики для отслеживания

- Количество 404 ошибок (может указывать на сломанные ссылки)
- Количество 500 ошибок (проблемы в коде)  
- Количество 403 ошибок (попытки несанкционированного доступа)
- Время ответа на ошибки

## Troubleshooting

### Обработчики не активируются
- Проверьте `DEBUG=False` в настройках
- Убедитесь, что handler'ы импортируются в `urls.py`
- Перезапустите сервер после изменений

### Логи не создаются
- Проверьте права на запись в директорию `logs/`
- Убедитесь, что директория создана
- Проверьте настройки `LOGGING` в `settings.py`

### Middleware не работает
- Проверьте порядок middleware в `MIDDLEWARE`
- Убедитесь, что middleware импортируется без ошибок
- Проверьте логи на наличие исключений при загрузке