{% extends "base.html" %}
{% load contracts_extras %}

{% block head_extra %}
<style>
  /* таблица + заголовки */
.table-fixed { table-layout: fixed; }
.table-fixed th, .table-fixed td { vertical-align: middle; }
.table-fixed thead th{
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip;
  position: relative;
  padding-right: 10px; /* место под ручку */
}

/* ВАЖНО: позволяем вертикально выходить меню за пределы .table-responsive,
   но горизонтальный скролл таблицы сохраняем */
.table-responsive{
  overflow-x: auto;
  overflow-y: visible; /* <-- это ключ! */
}

/* тело таблицы — переносы */
.table-fixed tbody td{
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;
}

/* узкие ячейки — без переносов */
.table-fixed td.col-serial,
.table-fixed td.col-room,
.table-fixed td.col-status,
.table-fixed td.col-actions{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* кнопки действий */
.col-actions{ text-align:center; white-space:nowrap; }
.action-group .btn-icon{
  width:2rem; height:2rem; padding:0;
  display:inline-flex; align-items:center; justify-content:center;
  border-radius:50%;
}
.action-group .btn-icon i{ font-size:1rem; line-height:1; }

/* подсветка редактируемой строки */
tr.editing{ background: rgba(13,110,253,.05); }

/* РУЧКА РЕСАЙЗА: делаем поуже и ниже по z-index, чтобы не перекрывала воронку */
.col-resize-handle{
  position:absolute; top:0; right:-3px; width:6px; height:100%;
  cursor: col-resize; user-select:none; z-index: 1; /* было 3 */
}
.col-resize-handle::after{
  content:""; position:absolute; top:0; bottom:0; right:2px;
  border-right:1px dashed rgba(0,0,0,.2);
}
.col-resize-handle.active::after{ border-right-color: var(--bs-primary); }

/* сам переключатель фильтра пусть будет поверх ручки */
.column-filter .dropdown-toggle{ position: relative; z-index: 2; }

/* на всякий: меню поверх всего */
.table-fixed thead .dropdown-menu{ z-index: 1056; }
</style>
{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Устройства в договоре</h1>

<div class="d-flex gap-2 align-items-center mb-3">
  <form class="row g-2 flex-grow-1" method="get">
    <div class="col">
      <input name="q" value="{{ request.GET.q }}" class="form-control"
             placeholder="Поиск (SN, адрес, модель, комментарий)">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Фильтровать</button>
    </div>
    {% if perms.contracts.export_contracts %}
    <div class="col-auto">
      <a class="btn btn-outline-success" href="{% url 'contracts:export' %}?{{ base_qs }}">
        Экспорт в Excel
      </a>
    </div>
    {% endif %}
    {% if perms.contracts.add_contractdevice %}
    <div class="col-auto">
      <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#deviceCreateModal">
          Добавить
      </button>
    </div>
    {% endif %}
  </form>

  <!-- Переключатель столбцов -->
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      Колонки
    </button>
    <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 260px;">
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-org" data-col-key="org" type="checkbox" checked><span class="form-check-label">Организация</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-city" data-col-key="city" type="checkbox" checked><span class="form-check-label">Город</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-address" data-col-key="address" type="checkbox" checked><span class="form-check-label">Адрес</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-room" data-col-key="room" type="checkbox" checked><span class="form-check-label">№ кабинета</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-mfr" data-col-key="mfr" type="checkbox" checked><span class="form-check-label">Производитель</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-model" data-col-key="model" type="checkbox" checked><span class="form-check-label">Модель оборудования</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-serial" data-col-key="serial" type="checkbox" checked><span class="form-check-label">Серийный номер</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-status" data-col-key="status" type="checkbox" checked><span class="form-check-label">Статус</span></label>
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-comment" data-col-key="comment" type="checkbox" checked><span class="form-check-label">Комментарий</span></label>
      {% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}
      <label class="dropdown-item form-check"><input class="form-check-input me-2 column-toggle" id="col-actions" data-col-key="actions" type="checkbox" checked disabled><span class="form-check-label">Действия</span></label>
      {% endif %}
      <div class="dropdown-divider"></div>
      <button class="btn btn-sm btn-outline-secondary w-100" id="cols-reset">Сброс</button>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped table-hover table-bordered align-middle table-fixed table-resizable">
    <colgroup>
      <col style="width: 70px;">
      <col class="cg-org" style="width: 220px;">
      <col class="cg-city" style="width: 160px;">
      <col class="cg-address" style="width: 280px;">
      <col class="cg-room" style="width: 130px;">
      <col class="cg-mfr" style="width: 200px;">
      <col class="cg-model" style="width: 260px;">
      <col class="cg-serial" style="width: 190px;">
      <col class="cg-status" style="width: 220px;">
      <col class="cg-comment">
      {% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}
      <col class="cg-actions" style="width: 200px;">
      {% endif %}
    </colgroup>

    <thead class="table-light">
      <tr>
        <th>№</th>
        {% include "partials/column_filter.html" with key="org"     label="Организация"         value=filters.org     options=choices.org     base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="city"    label="Город"               value=filters.city    options=choices.city    base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="address" label="Адрес"               value=filters.address options=choices.address base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="room"    label="№ кабинета"          value=filters.room    options=choices.room    base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="mfr"     label="Производитель"       value=filters.mfr     options=choices.mfr     base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="model"   label="Модель оборудования"  value=filters.model   options=choices.model   base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="serial"  label="Серийный номер"      value=filters.serial  options=choices.serial  base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="status"  label="Статус"              value=filters.status  options=choices.status  base_qs=base_qs %}
        {% include "partials/column_filter.html" with key="comment" label="Комментарий"         value=filters.comment options=choices.comment base_qs=base_qs %}
        {% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}
        <th class="text-center th-actions">Действия</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for d in object_list %}
      <tr data-pk="{{ d.id }}">
        <td>{{ page_obj.start_index|add:forloop.counter0 }}</td>

        <td class="col-org"  data-org-id="{{ d.organization_id }}">{{ d.organization }}</td>
        <td class="col-city" data-city-id="{{ d.city_id }}">{{ d.city }}</td>

        <td class="col-address addr">{{ d.address }}</td>
        <td class="col-room">{{ d.room_number }}</td>

        <td class="col-mfr"   data-mfr-id="{{ d.model.manufacturer_id }}">{{ d.model.manufacturer }}</td>
        <td class="col-model" data-model-id="{{ d.model_id }}">{{ d.model.name }}</td>

        <td class="col-serial">
          {{ d.serial_number }}
          {% if d.printer %}<br><a href="{% url 'inventory:edit_printer' d.printer.id %}">↗ опрос</a>{% endif %}
        </td>

        <td class="col-status" data-status-id="{{ d.status_id }}">
          {% if d.status %}
            <span class="badge rounded-pill"
                  title="{{ d.status.name }} ({{ d.status.color }}){% if not d.status.is_active %} • неактивен{% endif %}"
                  style="background-color: {{ d.status.color }}; color: {{ d.status.color|contrast }}; opacity: {% if not d.status.is_active %}0.6{% else %}1{% endif %};">
              {{ d.status.name }}
            </span>
          {% else %}—{% endif %}
        </td>

        <td class="col-comment comment">{{ d.comment }}</td>

        {% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}
        <td class="col-actions">
          <div class="btn-group btn-group-sm action-group" role="group" aria-label="Действия">
            {% if perms.contracts.change_contractdevice %}
            <button class="btn btn-outline-secondary btn-icon row-edit"  title="Редактировать" aria-label="Редактировать">
              <i class="bi bi-pencil"></i>
            </button>
            {% endif %}
            {% if perms.contracts.delete_contractdevice %}
            <button class="btn btn-outline-danger   btn-icon row-delete" title="Удалить"        aria-label="Удалить">
              <i class="bi bi-trash"></i>
            </button>
            {% endif %}
            {% if perms.contracts.change_contractdevice %}
            <button class="btn btn-outline-success  btn-icon d-none row-save"   title="Сохранить" aria-label="Сохранить">
              <i class="bi bi-check2"></i>
            </button>
            <button class="btn btn-outline-secondary btn-icon d-none row-cancel" title="Отмена"    aria-label="Отмена">
              <i class="bi bi-x"></i>
            </button>
            {% endif %}
          </div>
        </td>
        {% endif %}
      </tr>
      {% empty %}
      <tr><td colspan="{% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}11{% else %}10{% endif %}" class="text-muted">Нет данных</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal: добавление устройства -->
<div class="modal fade" id="deviceCreateModal" tabindex="-1" aria-labelledby="deviceCreateLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deviceCreateLabel">Добавить устройство в договор</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <form id="deviceCreateForm" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Организация</label>
            <select class="form-select" id="new-org" required {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Город</label>
            <select class="form-select" id="new-city" required {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Производитель</label>
            <select class="form-select" id="new-mfr" required {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Модель</label>
            <select class="form-select" id="new-model" required {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Статус</label>
            <select class="form-select" id="new-status" required {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Серийный номер</label>
            <input type="text" class="form-control" id="new-serial" {% if not perms.contracts.add_contractdevice %}disabled{% endif %}>
          </div>

          <div class="col-12">
            <label class="form-label">Адрес</label>
            <input type="text" class="form-control" id="new-address" {% if not perms.contracts.add_contractdevice %}disabled{% endif %}>
          </div>
          <div class="col-md-6">
            <label class="form-label">№ кабинета</label>
            <input type="text" class="form-control" id="new-room" {% if not perms.contracts.add_contractdevice %}disabled{% endif %}>
          </div>
          <div class="col-12">
            <label class="form-label">Комментарий</label>
            <textarea class="form-control" id="new-comment" rows="3" {% if not perms.contracts.add_contractdevice %}disabled{% endif %}></textarea>
          </div>
        </form>
        <div class="small text-muted mt-2">Поля со * — обязательные.</div>
        {% if not perms.contracts.add_contractdevice %}
        <div class="alert alert-info mt-3">У вас нет прав на создание устройства — доступен только просмотр.</div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
        {% if perms.contracts.add_contractdevice %}
        <button class="btn btn-primary" id="createDeviceBtn">Создать</button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% include "partials/pagination.html" %}
{% endblock %}

{% block scripts %}
<!-- Справочники для инлайн-редактора -->
<script>
  window.CONTRACT_STATUSES = {{ statuses_json|safe }};
  window.CONTRACT_ORGS     = {{ orgs_json|safe }};
  window.CONTRACT_CITIES   = {{ cities_json|safe }};
  window.CONTRACT_MFRS     = {{ mfrs_json|safe }};
  window.CONTRACT_MODELS   = {{ models_json|safe }};
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация contracts интерфейса...');

    // ===== ПЕРЕКЛЮЧЕНИЕ ВИДИМОСТИ КОЛОНОК =====
    (function() {
        const KEY = "contracts:visibleCols";
        const DEFAULTS = new Set(["org","city","address","room","mfr","model","serial","status","comment"]);
        const ALL = ["org","city","address","room","mfr","model","serial","status","comment","actions"];

        function loadState(){
            try{
                const raw = localStorage.getItem(KEY);
                if(!raw) return new Set(DEFAULTS);
                const a = JSON.parse(raw);
                return Array.isArray(a) && a.length ? new Set(a) : new Set(DEFAULTS);
            }catch{
                return new Set(DEFAULTS);
            }
        }

        function saveState(s){
            localStorage.setItem(KEY, JSON.stringify([...s]));
        }

        function apply(s){
            for(const k of ALL){
                const show = s.has(k);
                document.querySelectorAll(".th-"+k).forEach(el=>el.classList.toggle("d-none", !show));
                document.querySelectorAll(".col-"+k+", .cg-"+k).forEach(el=>el.classList.toggle("d-none", !show));
                const cb = document.getElementById("col-"+k);
                if (cb) cb.checked = show;
            }
        }

        const state = loadState();
        if (document.querySelector(".th-actions") && !state.has("actions")) {
            state.add("actions");
        }
        apply(state);

        document.querySelector(".columns-menu")?.addEventListener("click", (e) => e.stopPropagation());

        document.querySelectorAll(".column-toggle").forEach(cb => {
            cb.addEventListener("change", (e) => {
                const k = e.target.dataset.colKey;
                if(e.target.checked) state.add(k);
                else state.delete(k);
                saveState(state);
                apply(state);
            });
        });

        document.getElementById("cols-reset")?.addEventListener("click", (e) => {
            e.preventDefault();
            const s = new Set([...DEFAULTS]);
            if (document.querySelector(".th-actions")) s.add("actions");
            saveState(s);
            apply(s);
        });
    })();

    // ===== ФИЛЬТРЫ ПО СТОЛБЦАМ =====
    (function() {
        console.log('Инициализация фильтров...');

        // Предотвращаем закрытие dropdown при клике внутри
        document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Поиск по вариантам в списке
        document.querySelectorAll('.search-suggestions').forEach(function(searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const key = this.dataset.key;
                const suggestions = document.querySelector('.suggestions[data-key="' + key + '"]');

                if (suggestions) {
                    suggestions.querySelectorAll('.suggestion-item').forEach(function(item) {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        });

        // Обработка кнопки "OK" (применить фильтр)
        document.querySelectorAll('.apply-filter').forEach(function(button) {
            button.addEventListener('click', function() {
                const key = this.dataset.key;
                const input = document.getElementById('flt-' + key);
                const value = input ? input.value.trim() : '';

                // Создаем URL с фильтром
                const url = new URL(window.location);
                if (value) {
                    url.searchParams.set(key, value);
                } else {
                    url.searchParams.delete(key);
                }
                url.searchParams.delete('page'); // сбрасываем страницу при фильтрации

                // Переходим на новый URL
                window.location.href = url.toString();
            });
        });

        // Обработка Enter в поле ввода
        document.querySelectorAll('.flt-input').forEach(function(input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const key = this.dataset.key;
                    const button = document.querySelector('.apply-filter[data-key="' + key + '"]');
                    if (button) {
                        button.click();
                    }
                }
            });
        });

        // Обработка кнопки "Сброс"
        document.querySelectorAll('.clear-filter').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const key = this.dataset.key;

                // Создаем URL без этого фильтра
                const url = new URL(window.location);
                url.searchParams.delete(key);
                url.searchParams.delete('page');

                window.location.href = url.toString();
            });
        });

        // Обработка клика по вариантам в списке
        document.querySelectorAll('.suggestion-item').forEach(function(item) {
            item.addEventListener('click', function() {
                const suggestions = this.closest('.suggestions');
                if (!suggestions) return;

                const key = suggestions.dataset.key;
                const input = document.getElementById('flt-' + key);
                const value = this.textContent.trim();

                // Устанавливаем значение в поле
                if (input) {
                    input.value = value;

                    // Автоматически применяем фильтр
                    const button = document.querySelector('.apply-filter[data-key="' + key + '"]');
                    if (button) {
                        button.click();
                    }
                }
            });
        });

        console.log('Фильтры инициализированы');
    })();

    // ===== ИНЛАЙН-РЕДАКТИРОВАНИЕ =====
    (function(){
        function getCSRF(){
            const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
            return m ? decodeURIComponent(m[1]) : "";
        }

        function contrast(hex){
            hex = (hex || "").replace("#", "");
            if(hex.length === 3) hex = hex.split("").map(c => c+c).join("");
            if(hex.length !== 6) return "#fff";
            const r = parseInt(hex.slice(0,2), 16);
            const g = parseInt(hex.slice(2,4), 16);
            const b = parseInt(hex.slice(4,6), 16);
            return (r*299 + g*587 + b*114) / 1000 > 140 ? "#000" : "#fff";
        }

        const STATUSES = window.CONTRACT_STATUSES || [];
        const ORGS = window.CONTRACT_ORGS || [];
        const CITIES = window.CONTRACT_CITIES || [];
        const MFRS = window.CONTRACT_MFRS || [];
        const MODELS = window.CONTRACT_MODELS || [];

        function toInput(td, val, isArea){
            const el = document.createElement(isArea ? "textarea" : "input");
            if(!isArea) el.type = "text";
            el.className = "form-control form-control-sm";
            el.value = val || "";
            td.dataset.orig = val || "";
            td.innerHTML = "";
            td.appendChild(el);
            return el;
        }

        function toSelect(td, list, currentId){
            const sel = document.createElement("select");
            sel.className = "form-select form-select-sm";
            td.dataset.origId = currentId || "";
            td.innerHTML = "";
            for (const o of list){
                sel.append(new Option(o.name, o.id, false, String(o.id) === String(currentId)));
            }
            td.appendChild(sel);
            return sel;
        }

        function modelsByMfr(mfrId){
            return MODELS.filter(m => String(m.manufacturer_id) === String(mfrId));
        }

        function renderStatusBadge(td, st){
            if(!st || !st.id){
                td.dataset.statusId = "";
                td.textContent = "—";
                return;
            }
            td.dataset.statusId = st.id;
            td.innerHTML = `<span class="badge rounded-pill" title="${st.name}"
                             style="background-color:${st.color};color:${contrast(st.color)};${st.is_active?"":"opacity:.6;"}">${st.name}</span>`;
        }

        function enterEdit(tr){
            tr.classList.add("editing");
            tr.querySelector(".row-edit")?.classList.add("d-none");
            tr.querySelector(".row-save")?.classList.remove("d-none");
            tr.querySelector(".row-cancel")?.classList.remove("d-none");

            // справочники
            const orgTd = tr.querySelector(".col-org");
            const cityTd = tr.querySelector(".col-city");
            const mfrTd = tr.querySelector(".col-mfr");
            const mdlTd = tr.querySelector(".col-model");

            const orgSel = toSelect(orgTd, ORGS, orgTd.dataset.orgId);
            const citySel = toSelect(cityTd, CITIES, cityTd.dataset.cityId);
            const mfrSel = toSelect(mfrTd, MFRS, mfrTd.dataset.mfrId);
            const mdlSel = toSelect(mdlTd, modelsByMfr(mfrSel.value || mfrTd.dataset.mfrId), mdlTd.dataset.modelId);

            // при смене производителя — пересобрать модели
            mfrSel.addEventListener("change", () => {
                const allowed = modelsByMfr(mfrSel.value);
                mdlSel.innerHTML = "";
                for (const m of allowed) mdlSel.append(new Option(m.name, m.id));
            });

            // простые поля
            toInput(tr.querySelector(".col-address"), tr.querySelector(".col-address").textContent.trim());
            toInput(tr.querySelector(".col-room"), tr.querySelector(".col-room").textContent.trim());
            const serTd = tr.querySelector(".col-serial");
            const serText = serTd.firstChild ? serTd.firstChild.textContent.trim() : serTd.textContent.trim();
            toInput(serTd, serText);
            toInput(tr.querySelector(".col-comment"), tr.querySelector(".col-comment").textContent.trim(), true);

            // статус
            toSelect(tr.querySelector(".col-status"), STATUSES, tr.querySelector(".col-status").dataset.statusId);
        }

        function leaveEdit(tr, restore){
            tr.querySelector(".row-edit")?.classList.remove("d-none");
            tr.querySelector(".row-save")?.classList.add("d-none");
            tr.querySelector(".row-cancel")?.classList.add("d-none");
            tr.classList.remove("editing");

            if(restore){
                const a = tr.querySelector(".col-address");
                const r = tr.querySelector(".col-room");
                const s = tr.querySelector(".col-serial");
                const c = tr.querySelector(".col-comment");
                const st = tr.querySelector(".col-status");
                const org = tr.querySelector(".col-org");
                const city = tr.querySelector(".col-city");
                const mfr = tr.querySelector(".col-mfr");
                const mdl = tr.querySelector(".col-model");

                a.textContent = a.dataset.orig || "";
                r.textContent = r.dataset.orig || "";
                s.textContent = s.dataset.orig || "";
                c.textContent = c.dataset.orig || "";

                const stCur = STATUSES.find(x => String(x.id) === String(st.dataset.origId || st.dataset.statusId));
                renderStatusBadge(st, stCur || null);

                const findById = (arr, id) => arr.find(x => String(x.id) === String(id));
                const orgObj = findById(ORGS, org.dataset.orgId);
                org.textContent = orgObj ? orgObj.name : "";
                const cityObj = findById(CITIES, city.dataset.cityId);
                city.textContent = cityObj ? cityObj.name : "";
                const mdlObj = findById(MODELS, mdl.dataset.modelId);
                mdl.textContent = mdlObj ? mdlObj.name : "";
                const mfrObj = findById(MFRS, mfr.dataset.mfrId);
                mfr.textContent = mfrObj ? mfrObj.name : "";
            }
        }

        document.addEventListener("click", async (e) => {
            const tr = e.target.closest("tr[data-pk]");
            if(!tr) return;
            const pk = tr.dataset.pk;

            if (e.target.closest(".row-edit")) {
                e.preventDefault();
                enterEdit(tr);
                return;
            }

            if (e.target.closest(".row-cancel")) {
                e.preventDefault();
                leaveEdit(tr, true);
                return;
            }

            if (e.target.closest(".row-delete")) {
                e.preventDefault();
                if(!confirm("Удалить устройство из списка договора?")) return;
                try{
                    const resp = await fetch(`{% url 'contracts:api_delete' 0 %}`.replace("/0/", "/" + pk + "/"), {
                        method: "POST",
                        headers: { "X-CSRFToken": getCSRF() }
                    });
                    const data = await resp.json();
                    if(!data.ok) throw new Error(data.error || "Ошибка удаления");
                    tr.remove();
                }catch(err){
                    alert(err.message || "Не удалось удалить");
                }
                return;
            }

            if (e.target.closest(".row-save")) {
                e.preventDefault();

                const payload = {
                    organization_id: tr.querySelector(".col-org select")?.value ?? tr.querySelector(".col-org")?.dataset.orgId ?? null,
                    city_id: tr.querySelector(".col-city select")?.value ?? tr.querySelector(".col-city")?.dataset.cityId ?? null,
                    model_id: tr.querySelector(".col-model select")?.value ?? tr.querySelector(".col-model")?.dataset.modelId ?? null,
                    address: tr.querySelector(".col-address input")?.value ?? "",
                    room_number: tr.querySelector(".col-room input")?.value ?? "",
                    serial_number: tr.querySelector(".col-serial input")?.value ?? "",
                    comment: tr.querySelector(".col-comment textarea")?.value ?? "",
                    status_id: tr.querySelector(".col-status select")?.value ?? null,
                };

                try{
                    const resp = await fetch(`{% url 'contracts:api_update' 0 %}`.replace("/0/", "/" + pk + "/"), {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRF()
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await resp.json();
                    if(!data.ok) throw new Error(data.error || "Ошибка сохранения");

                    // простые поля
                    tr.querySelector(".col-address").textContent = data.device.address || "";
                    tr.querySelector(".col-room").textContent = data.device.room_number || "";
                    const serTd = tr.querySelector(".col-serial");
                    const oldLink = serTd.querySelector("a")?.cloneNode(true);
                    serTd.textContent = data.device.serial_number || "";
                    if (oldLink){
                        serTd.appendChild(document.createElement("br"));
                        serTd.appendChild(oldLink);
                    }
                    tr.querySelector(".col-comment").textContent = data.device.comment || "";
                    renderStatusBadge(tr.querySelector(".col-status"), data.device.status);

                    // справочники из ответа
                    const orgTd = tr.querySelector(".col-org");
                    const cityTd = tr.querySelector(".col-city");
                    const mfrTd = tr.querySelector(".col-mfr");
                    const mdlTd = tr.querySelector(".col-model");

                    orgTd.dataset.orgId = data.device.organization.id;
                    orgTd.textContent = data.device.organization.name;

                    cityTd.dataset.cityId = data.device.city.id;
                    cityTd.textContent = data.device.city.name;

                    mfrTd.dataset.mfrId = data.device.manufacturer.id;
                    mfrTd.textContent = data.device.manufacturer.name;

                    mdlTd.dataset.modelId = data.device.model.id;
                    mdlTd.textContent = data.device.model.name;

                    leaveEdit(tr, false);
                }catch(err){
                    alert(err.message || "Не удалось сохранить изменения");
                }
            }
        });
    })();

    // ===== РЕСАЙЗ СТОЛБЦОВ =====
    (function(){
        const STORE_KEY = "contracts:colWidths:v1";
        const table = document.querySelector("table.table-resizable");
        if (!table) return;

        // Собираем <col> по ключам из классов cg-*
        const colByKey = {};
        table.querySelectorAll("colgroup col").forEach(col => {
            const m = col.className.match(/cg-([a-z]+)/);
            if (m) colByKey[m[1]] = col;
        });

        // Применим сохранённые ширины
        try {
            const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
            Object.entries(saved).forEach(([k, w]) => {
                if (colByKey[k]) colByKey[k].style.width = w;
            });
        } catch {}

        // Добавляем ручки ко всем th у которых есть класс th-<key>
        table.querySelectorAll("thead th").forEach((th) => {
            const cls = [...th.classList].find(c => c.startsWith("th-"));
            if (!cls) return; // пропускаем № и "Действия"
            const key = cls.slice(3);
            if (!colByKey[key]) return;

            const handle = document.createElement("span");
            handle.className = "col-resize-handle";
            th.appendChild(handle);

            let startX = 0, startW = 0;

            function onMove(e){
                const dx = e.clientX - startX;
                const newW = Math.max(60, startW + dx);
                colByKey[key].style.width = newW + "px";
            }

            function onUp(){
                document.removeEventListener("mousemove", onMove);
                document.removeEventListener("mouseup", onUp);
                handle.classList.remove("active");
                // сохранить
                const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
                saved[key] = colByKey[key].style.width || "";
                localStorage.setItem(STORE_KEY, JSON.stringify(saved));
            }

            handle.addEventListener("mousedown", (e) => {
                e.preventDefault();
                startX = e.clientX;
                startW = parseInt(colByKey[key].style.width) || th.offsetWidth;
                handle.classList.add("active");
                document.addEventListener("mousemove", onMove);
                document.addEventListener("mouseup", onUp);
            });

            // Двойной клик — сброс ширины
            handle.addEventListener("dblclick", (e) => {
                e.preventDefault();
                colByKey[key].style.width = "";
                const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
                delete saved[key];
                localStorage.setItem(STORE_KEY, JSON.stringify(saved));
            });
        });
    })();

    // ===== МОДАЛЬНОЕ ОКНО СОЗДАНИЯ УСТРОЙСТВА =====
    (function(){
        const STATUSES = window.CONTRACT_STATUSES || [];
        const ORGS = window.CONTRACT_ORGS || [];
        const CITIES = window.CONTRACT_CITIES || [];
        const MFRS = window.CONTRACT_MFRS || [];
        const MODELS = window.CONTRACT_MODELS || [];

        const modalEl = document.getElementById("deviceCreateModal");
        const orgSel = document.getElementById("new-org");
        const citySel = document.getElementById("new-city");
        const mfrSel = document.getElementById("new-mfr");
        const modelSel = document.getElementById("new-model");
        const statusSel = document.getElementById("new-status");

        if (!modalEl) return; // модальное окно не найдено

        function getCSRF(){
            const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
            return m ? decodeURIComponent(m[1]) : "";
        }

        function modelsByMfr(mfrId){
            return MODELS.filter(m => String(m.manufacturer_id) === String(mfrId));
        }

        function fillSelect(sel, items){
            if (!sel) return;
            sel.innerHTML = "";
            sel.append(new Option("— выберите —", ""));
            for(const it of items){
                sel.append(new Option(it.name, it.id));
            }
        }

        function contrast(hex){
            hex = (hex || "").replace("#", "");
            if(hex.length === 3) hex = hex.split("").map(c => c+c).join("");
            if(hex.length !== 6) return "#fff";
            const r = parseInt(hex.slice(0,2), 16);
            const g = parseInt(hex.slice(2,4), 16);
            const b = parseInt(hex.slice(4,6), 16);
            return (r*299 + g*587 + b*114) / 1000 > 140 ? "#000" : "#fff";
        }

        function statusBadge(st){
            if(!st || !st.id) return "—";
            const fg = contrast(st.color);
            const op = st.is_active ? "" : "opacity:.6;";
            return `<span class="badge rounded-pill" title="${st.name}" style="background-color:${st.color};color:${fg};${op}">${st.name}</span>`;
        }

        // при открытии модалки заполняем селекты и чистим поля
        modalEl.addEventListener("show.bs.modal", () => {
            fillSelect(orgSel, ORGS);
            fillSelect(citySel, CITIES);
            fillSelect(mfrSel, MFRS);
            fillSelect(statusSel, STATUSES);
            fillSelect(modelSel, []);
            if (modelSel) modelSel.disabled = true;

            const fields = ["new-address", "new-room", "new-serial", "new-comment"];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            });
        });

        mfrSel?.addEventListener("change", () => {
            const list = mfrSel.value ? modelsByMfr(mfrSel.value) : [];
            fillSelect(modelSel, list);
            if (modelSel) modelSel.disabled = !mfrSel.value;
        });

        // вставка новой строки в начало tbody
        function prependRow(device){
            const tbody = document.querySelector("table.table-resizable tbody");
            if (!tbody) return;

            const tr = document.createElement("tr");
            tr.setAttribute("data-pk", device.id);
            const printerLink = device.has_printer ? `<br><a href="/printers/${device.printer_id}/edit/">↗ опрос</a>` : "";

            tr.innerHTML = `
                <td>—</td>
                <td class="col-org" data-org-id="${device.organization.id}">${device.organization.name}</td>
                <td class="col-city" data-city-id="${device.city.id}">${device.city.name}</td>
                <td class="col-address">${device.address || ""}</td>
                <td class="col-room">${device.room_number || ""}</td>
                <td class="col-mfr" data-mfr-id="${device.manufacturer.id}">${device.manufacturer.name}</td>
                <td class="col-model" data-model-id="${device.model.id}">${device.model.name}</td>
                <td class="col-serial">${device.serial_number || ""}${printerLink}</td>
                <td class="col-status" data-status-id="${device.status.id}">${statusBadge(device.status)}</td>
                <td class="col-comment">${device.comment || ""}</td>
                {% if perms.contracts.change_contractdevice or perms.contracts.delete_contractdevice %}
                <td class="col-actions">
                    <div class="btn-group btn-group-sm action-group" role="group">
                        {% if perms.contracts.change_contractdevice %}
                        <button class="btn btn-outline-secondary btn-icon row-edit" title="Редактировать"><i class="bi bi-pencil"></i></button>
                        {% endif %}
                        {% if perms.contracts.delete_contractdevice %}
                        <button class="btn btn-outline-danger btn-icon row-delete" title="Удалить"><i class="bi bi-trash"></i></button>
                        {% endif %}
                        {% if perms.contracts.change_contractdevice %}
                        <button class="btn btn-outline-success btn-icon d-none row-save" title="Сохранить"><i class="bi bi-check2"></i></button>
                        <button class="btn btn-outline-secondary btn-icon d-none row-cancel" title="Отмена"><i class="bi bi-x"></i></button>
                        {% endif %}
                    </div>
                </td>
                {% endif %}`;
            tbody.prepend(tr);
        }

        document.getElementById("createDeviceBtn")?.addEventListener("click", async (e) => {
            e.preventDefault();
            const payload = {
                organization_id: orgSel?.value || null,
                city_id: citySel?.value || null,
                model_id: modelSel?.value || null,
                status_id: statusSel?.value || null,
                address: document.getElementById("new-address")?.value.trim() || "",
                room_number: document.getElementById("new-room")?.value.trim() || "",
                serial_number: document.getElementById("new-serial")?.value.trim() || "",
                comment: document.getElementById("new-comment")?.value.trim() || "",
            };

            if(!payload.organization_id || !payload.city_id || !payload.model_id || !payload.status_id){
                alert("Заполните обязательные поля: организация, город, модель, статус.");
                return;
            }

            try{
                const resp = await fetch("{% url 'contracts:api_create' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRF()
                    },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if(!data.ok) throw new Error(data.error || "Не удалось создать запись");

                (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).hide();
                prependRow(data.device);
            }catch(err){
                alert(err.message || "Ошибка при создании устройства");
            }
        });
    })();

    console.log('Contracts интерфейс инициализирован');
});
</script>
{% endblock %}