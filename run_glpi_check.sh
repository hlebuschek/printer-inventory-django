#!/bin/bash

# ============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ GLPI
# ============================================================================

set -e

echo "=================================================="
echo "üöÄ –ó–ê–ü–£–°–ö –ü–†–û–í–ï–†–ö–ò –£–°–¢–†–û–ô–°–¢–í –í GLPI"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
MODE="${1:-async}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏
CONTRACT_FLAG=""
UPDATE_ONLY_FLAG=""

if [[ "$*" == *"--update-only"* ]] || [[ "$*" == *"-o"* ]]; then
    UPDATE_ONLY_FLAG="--update-only"
    echo "üìù –û–ø—Ü–∏—è: –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)"
    echo ""
elif [[ "$*" == *"--update-contract"* ]] || [[ "$*" == *"-u"* ]]; then
    CONTRACT_FLAG="--update-contract-field"
    echo "üìù –û–ø—Ü–∏—è: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–æ"
    echo ""
fi

FLAGS="$CONTRACT_FLAG $UPDATE_ONLY_FLAG"

case $MODE in
    sync|--sync|-s)
        echo "üìä –†–µ–∂–∏–º: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)"
        echo ""
        python manage.py check_glpi --sync $FLAGS
        ;;

    async|--async|-a)
        echo "üîÑ –†–µ–∂–∏–º: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (–∑–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ)"
        echo ""
        python manage.py check_glpi $FLAGS
        ;;

    status|--status)
        if [ -z "$2" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ ID –∑–∞–¥–∞—á–∏"
            echo "   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 status TASK_ID"
            exit 1
        fi
        python manage.py check_glpi --status "$2"
        ;;

    help|--help|-h)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [—Ä–µ–∂–∏–º] [–æ–ø—Ü–∏–∏]"
        echo ""
        echo "–†–µ–∂–∏–º—ã:"
        echo "  sync, --sync, -s      –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  async, --async, -a    –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–µ"
        echo "  status TASK_ID        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏"
        echo "  help, --help, -h      –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        echo ""
        echo "–û–ø—Ü–∏–∏:"
        echo "  --update-contract, -u –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ \"–ó–∞—è–≤–ª–µ–Ω –≤ –¥–æ–≥–æ–≤–æ—Ä–µ\" –≤ GLPI (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)"
        echo "  --update-only, -o     –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã—Å—Ç—Ä–æ ~2-5 –º–∏–Ω)"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0                         # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ"
        echo "  $0 sync                    # –ó–∞–ø—É—Å–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º"
        echo "  $0 sync --update-contract  # –ó–∞–ø—É—Å–∫ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (~20-30 –º–∏–Ω)"
        echo "  $0 sync --update-only      # –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä (~2-5 –º–∏–Ω)"
        echo "  $0 status abc123           # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
        echo ""
        ;;

    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º: $MODE"
        echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 help"
        exit 1
        ;;
esac
